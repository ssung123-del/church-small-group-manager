<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†Œê·¸ë£¹ í¸ì„± ë§¤ë‹ˆì €</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { theme: { extend: { colors: { brand: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' } } } } }</script>
    <style>
        @keyframes fade-in {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(10px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .animate-fade-in {
            animation: fade-in .3s ease-out
        }

        .animate-fade-in-up {
            animation: fade-in-up .4s ease-out
        }

        @media print {
            body * {
                visibility: hidden
            }

            #print-area,
            #print-area * {
                visibility: visible
            }

            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: #fff
            }

            .no-print {
                display: none !important
            }
        }

        .print-container {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 210mm;
            margin: 0 auto;
            padding: 15mm;
            background: #fff
        }

        .print-header {
            border-bottom: 2px solid #1e40af;
            padding-bottom: 12px;
            margin-bottom: 20px
        }

        .print-title {
            font-size: 24px;
            font-weight: bold;
            color: #1e40af
        }

        .print-subtitle {
            font-size: 14px;
            color: #64748b;
            margin-top: 4px
        }

        .print-table {
            width: 100%;
            border-collapse: collapse
        }

        .print-table th {
            background: #f1f5f9;
            padding: 10px 8px;
            text-align: left;
            font-size: 12px;
            font-weight: bold;
            border-bottom: 2px solid #e2e8f0
        }

        .print-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 13px
        }

        .print-table tr:nth-child(even) {
            background: #f8fafc
        }

        .print-footer {
            margin-top: 30px;
            text-align: center;
            font-size: 11px;
            color: #94a3b8
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const SHEET_API_URL_KEY = 'CHURCH_GROUP_SHEET_URL', MAPS_API_KEY_STORAGE = 'GOOGLE_MAPS_API_KEY_V1', GEOCODE_DELAY_MS = 250;

        // ë¯¸ë‹ˆë©€ ê·¸ë ˆì´ìŠ¤ì¼€ì¼ ë§µ ìŠ¤íƒ€ì¼
        const MAP_STYLES = [
            { elementType: "geometry", stylers: [{ color: "#f8fafc" }] },
            { elementType: "labels.icon", stylers: [{ visibility: "off" }] },
            { elementType: "labels.text.fill", stylers: [{ color: "#64748b" }] },
            { elementType: "labels.text.stroke", stylers: [{ color: "#f8fafc" }] },
            { featureType: "poi", stylers: [{ visibility: "off" }] },
            { featureType: "road", elementType: "geometry", stylers: [{ color: "#ffffff" }] },
            { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#e2e8f0" }] },
            { featureType: "transit", stylers: [{ visibility: "off" }] },
            { featureType: "water", elementType: "geometry", stylers: [{ color: "#e2e8f0" }] }
        ];

        const sleep = ms => new Promise(r => setTimeout(r, ms)), getApiUrl = () => localStorage.getItem(SHEET_API_URL_KEY);
        const request = async (action, payload = {}) => { const url = getApiUrl(); if (!url) throw new Error("DB ë¯¸ì—°ê²°"); const r = await fetch(url, { method: 'POST', body: JSON.stringify({ action, ...payload }) }); const res = await r.json(); if (res.status === 'error') throw new Error(res.message); return res.data };
        const fetchLeaders = async () => await request('GET_LEADERS'), insertLeader = async l => await request('ADD_LEADER', { leader: l }), deleteLeader = async id => await request('DELETE_LEADER', { id }), updateLeader = async (id, updates) => await request('UPDATE_LEADER', { id, updates }), insertMember = async m => await request('ADD_MEMBER', { member: m }), updateMember = async (id, updates) => await request('UPDATE_MEMBER', { id, updates }), fetchMembersByLeader = async id => await request('GET_MEMBERS_BY_LEADER', { leaderId: id }), fetchFullData = async () => ({ leaders: await request('GET_LEADERS'), members: await request('GET_ALL_MEMBERS') }), removeMember = async (mid, lid, mode) => await request('REMOVE_MEMBER', { memberId: mid, leaderId: lid, mode }), checkConnection = async url => { try { return (await (await fetch(url, { method: 'POST', body: JSON.stringify({ action: 'PING' }) })).json()).status === 'success' } catch { return false } };
        const geocodeAddress = async addr => { if (!window.google?.maps) throw new Error("Maps not loaded"); return new Promise((res, rej) => { new window.google.maps.Geocoder().geocode({ address: addr }, (r, s) => { if (s === 'OK' && r[0]) res({ lat: r[0].geometry.location.lat(), lng: r[0].geometry.location.lng(), formattedAddress: r[0].formatted_address }); else rej(new Error(`Geocode: ${s}`)) }) }) };
        const calcDist = (a, b, c, d) => { const R = 6371, dLat = (c - a) * Math.PI / 180, dLng = (d - b) * Math.PI / 180, x = Math.sin(dLat / 2) ** 2 + Math.cos(a * Math.PI / 180) * Math.cos(c * Math.PI / 180) * Math.sin(dLng / 2) ** 2; return R * 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1 - x)) };
        // ìƒë…„ì›”ì¼ì—ì„œ ë‚˜ì´ ê³„ì‚° (YYYY-MM-DD í˜•ì‹)
        const calcAge = (birthdate) => { if (!birthdate) return 0; const bd = new Date(birthdate); if (isNaN(bd)) return 0; const today = new Date(); let age = today.getFullYear() - bd.getFullYear(); const m = today.getMonth() - bd.getMonth(); if (m < 0 || (m === 0 && today.getDate() < bd.getDate())) age--; return age; };
        // ìƒë…„ì›”ì¼ í¬ë§·íŒ… (ISO íƒ€ì„ìŠ¤íƒ¬í”„ì—ì„œ YYYY-MM-DDë§Œ ì¶”ì¶œ)
        const formatBirthdate = (birthdate) => { if (!birthdate) return '-'; const str = String(birthdate); if (str.includes('T')) return str.split('T')[0]; return str.slice(0, 10); };
        // ì„±ë³„ ì•„ì´ì½˜ (ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›: Female, ì—¬, ì—¬ì„±, F, å¥³)
        const genderIcon = (g) => { const s = String(g || '').toLowerCase(); return ['female', 'ì—¬', 'ì—¬ì„±', 'f', 'å¥³'].some(v => s.includes(v)) ? 'ğŸ‘©' : 'ğŸ‘¨'; };
        // ì§ë¶„ ê°„ì†Œí™” (ê¶Œì‚¬ í¬í•¨â†’ê¶Œì‚¬, ì•ˆìˆ˜ì§‘ì‚¬ í¬í•¨â†’ì•ˆìˆ˜ì§‘ì‚¬, ì„œë¦¬ì§‘ì‚¬ëŠ” ìœ ì§€)
        const formatRole = (r) => { if (!r) return ''; const s = String(r); if (s.includes('ì„œë¦¬ì§‘ì‚¬')) return s; if (s.includes('ì•ˆìˆ˜ì§‘ì‚¬')) return 'ì•ˆìˆ˜ì§‘ì‚¬'; if (s.includes('ê¶Œì‚¬')) return 'ê¶Œì‚¬'; return s; };
        // ì—°ë½ì²˜ ìë™ í¬ë§·íŒ… (010-0000-0000 í˜•íƒœ)
        const formatPhone = (value) => { const nums = value.replace(/[^0-9]/g, '').slice(0, 11); if (nums.length <= 3) return nums; if (nums.length <= 7) return `${nums.slice(0, 3)}-${nums.slice(3)}`; return `${nums.slice(0, 3)}-${nums.slice(3, 7)}-${nums.slice(7)}`; };
        const findClosest = (lat, lng, birthdate, leaders, n = 3) => { const memberAge = calcAge(birthdate); const s = leaders.map(l => ({ ...l, distance: calcDist(lat, lng, l.lat, l.lng), ageDiff: Math.abs(calcAge(l.birthdate) - memberAge), score: calcDist(lat, lng, l.lat, l.lng) + Math.abs(calcAge(l.birthdate) - memberAge) * 0.2 })); s.sort((a, b) => a.score - b.score); return s.slice(0, n) };

        const GAS_CODE = `function doPost(e){const lock=LockService.getScriptLock();lock.tryLock(30000);try{const ss=SpreadsheetApp.getActiveSpreadsheet(),req=JSON.parse(e.postData.contents),act=req.action;let data=null;init(ss);if(act==='PING')data='PONG';else if(act==='GET_LEADERS'){refresh(ss);data=getRows("Leaders")}else if(act==='ADD_LEADER')data=addLeader(ss,req.leader);else if(act==='DELETE_LEADER')data=delLeader(ss,req.id);else if(act==='UPDATE_LEADER')data=updateLeader(ss,req.id,req.updates);else if(act==='ADD_MEMBER')data=addMember(ss,req.member);else if(act==='UPDATE_MEMBER')data=updateMember(ss,req.id,req.updates);else if(act==='GET_MEMBERS_BY_LEADER')data=getRows("Members").filter(function(m){return String(m.leader_id)===String(req.leaderId)});else if(act==='GET_ALL_MEMBERS')data=getRows("Members");else if(act==='REMOVE_MEMBER')data=remMember(ss,req.memberId,req.leaderId,req.mode);return ContentService.createTextOutput(JSON.stringify({status:'success',data})).setMimeType(ContentService.MimeType.JSON)}catch(err){return ContentService.createTextOutput(JSON.stringify({status:'error',message:err.toString()})).setMimeType(ContentService.MimeType.JSON)}finally{lock.releaseLock()}}function init(ss){if(!ss.getSheetByName("Leaders"))ss.insertSheet("Leaders").appendRow(["id","name","role","gender","birthdate","contact","address","lat","lng","max_capacity","current_members"]);var ms=ss.getSheetByName("Members");if(!ms)ss.insertSheet("Members").appendRow(["id","leader_id","name","role","gender","birthdate","contact","address","lat","lng"]);else{var h=ms.getRange(1,1,1,ms.getLastColumn()).getValues()[0];if(h.indexOf("gender")===-1){var gIdx=h.indexOf("role")+2;ms.insertColumnAfter(gIdx-1);ms.getRange(1,gIdx).setValue("gender")}}}function getRows(n){var s=SpreadsheetApp.getActiveSpreadsheet().getSheetByName(n),d=s.getDataRange().getValues(),h=d.shift();return d.map(function(r){var o={};h.forEach(function(k,i){o[k]=r[i]});return o})}function addLeader(ss,l){ss.getSheetByName("Leaders").appendRow([Date.now(),l.name,l.role,l.gender,l.birthdate,l.contact,l.address,l.lat,l.lng,l.max_capacity,0]);return"OK"}function delLeader(ss,id){var m=ss.getSheetByName("Members"),md=m.getDataRange().getValues();for(var i=1;i<md.length;i++)if(String(md[i][1])===String(id))m.getRange(i+1,2).setValue("");var s=ss.getSheetByName("Leaders"),d=s.getDataRange().getValues();for(var i=1;i<d.length;i++)if(String(d[i][0])===String(id)){s.deleteRow(i+1);break}return"OK"}function updateLeader(ss,id,u){var s=ss.getSheetByName("Leaders"),d=s.getDataRange().getValues(),h=d[0];for(var i=1;i<d.length;i++)if(String(d[i][0])===String(id)){for(var k in u){var ci=h.indexOf(k);if(ci>=0)s.getRange(i+1,ci+1).setValue(u[k])}break}return"OK"}function updateMember(ss,id,u){var s=ss.getSheetByName("Members"),d=s.getDataRange().getValues(),h=d[0];for(var i=1;i<d.length;i++)if(String(d[i][0])===String(id)){var oldLid=d[i][1];for(var k in u){var ci=h.indexOf(k);if(ci>=0)s.getRange(i+1,ci+1).setValue(u[k])}if(u.leader_id!==undefined&&u.leader_id!==oldLid){if(oldLid)recalc(ss,oldLid);if(u.leader_id)recalc(ss,u.leader_id)}break}return"OK"}function addMember(ss,m){var ms=ss.getSheetByName("Members"),h=ms.getRange(1,1,1,ms.getLastColumn()).getValues()[0],gIdx=h.indexOf("gender");if(gIdx===-1){ms.appendRow([Date.now(),m.leader_id||"",m.name,m.role,m.birthdate,m.contact,m.address,m.lat,m.lng])}else{var row=[];h.forEach(function(col){if(col==="id")row.push(Date.now());else if(col==="leader_id")row.push(m.leader_id||"");else if(col==="gender")row.push(m.gender||"");else row.push(m[col]||"")});ms.appendRow(row)}if(m.leader_id)recalc(ss,m.leader_id);return"OK"}function remMember(ss,mid,lid,mode){var s=ss.getSheetByName("Members"),d=s.getDataRange().getValues();for(var i=1;i<d.length;i++)if(String(d[i][0])===String(mid)){mode==='DELETE'?s.deleteRow(i+1):s.getRange(i+1,2).setValue("");break}if(lid)recalc(ss,lid);return"OK"}function recalc(ss,lid){if(!lid)return;var m=ss.getSheetByName("Members").getDataRange().getValues();var c=0;for(var i=1;i<m.length;i++)if(String(m[i][1])===String(lid))c++;var l=ss.getSheetByName("Leaders"),ld=l.getDataRange().getValues();for(var i=1;i<ld.length;i++)if(String(ld[i][0])===String(lid)){l.getRange(i+1,11).setValue(c);break}}function refresh(ss){var m=ss.getSheetByName("Members").getDataRange().getValues(),cnt={};for(var i=1;i<m.length;i++)if(m[i][1])cnt[m[i][1]]=(cnt[m[i][1]]||0)+1;var l=ss.getSheetByName("Leaders"),ld=l.getDataRange().getValues();for(var i=1;i<ld.length;i++){var c=cnt[ld[i][0]]||0;if(ld[i][10]!=c)l.getRange(i+1,11).setValue(c)}}`;

        const SetupScreen = ({ onComplete }) => {
            const [url, setUrl] = useState(''), [apiKey, setApiKey] = useState(''), loading = useState(false)[0], setLoading = useState(false)[1], step = useState(1)[0], setStep = useState(1)[1];

            const connect = async () => {
                if (!url.includes('script.google.com')) { alert("ì˜ëª»ëœ URL (Google Apps Script URLì„ í™•ì¸í•´ì£¼ì„¸ìš”)"); return }
                if (!apiKey.trim() || !apiKey.startsWith('AIza')) { alert("ì˜¬ë°”ë¥¸ Google Maps API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”"); return }
                setLoading(true);
                if (await checkConnection(url)) {
                    localStorage.setItem(SHEET_API_URL_KEY, url);
                    localStorage.setItem(MAPS_API_KEY_STORAGE, apiKey);
                    onComplete(apiKey);
                } else alert("ì—°ê²° ì‹¤íŒ¨: URLì´ ì˜¬ë°”ë¥´ì§€ ì•Šê±°ë‚˜ ì›¹ ì•± ë°°í¬ ì„¤ì •(ì•¡ì„¸ìŠ¤: ëª¨ë“  ì‚¬ìš©ì)ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                setLoading(false)
            };

            const inputClass = "block w-full border-2 border-slate-200 rounded-xl px-4 py-3 focus:border-brand-500 focus:ring-0 transition-all outline-none bg-white text-sm mt-2";

            return (
                <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-2xl overflow-hidden border border-slate-200">
                        <div className="bg-brand-600 p-8 text-white text-center">
                            <h1 className="text-3xl font-extrabold mb-2 text-white">ì‹œìŠ¤í…œ ì´ˆê¸° ì„¤ì •</h1>
                            <p className="text-brand-100 text-sm italic">ì•„ë˜ 2ë‹¨ê³„ ê°€ì´ë“œë¥¼ ë”°ë¼ ì‹œìŠ¤í…œì„ ì—°ê²°í•´ì£¼ì„¸ìš”.</p>
                        </div>

                        <div className="p-8 space-y-8 overflow-y-auto max-h-[85vh] custom-scrollbar">
                            {/* ë‹¨ê³„ 1: ë°ì´í„°ë² ì´ìŠ¤ */}
                            <section className="space-y-4">
                                <h3 className="font-bold text-slate-800 text-lg flex items-center gap-3">
                                    <span className="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm shadow-md">1</span>
                                    ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¶• (Google Sheets)
                                </h3>
                                <div className="bg-slate-50 border border-slate-200 rounded-2xl p-6 text-sm text-slate-600 space-y-4">
                                    <div className="space-y-2">
                                        <p>1. <a href="https://sheets.new" target="_blank" className="text-brand-600 font-bold underline hover:text-brand-700 transition-colors">ìƒˆ ìŠ¤í”„ë ˆë“œì‹œíŠ¸</a>ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
                                        <p>2. ë©”ë‰´ì—ì„œ <b>í™•ì¥ í”„ë¡œê·¸ë¨ &gt; Apps Script</b>ë¥¼ í´ë¦­í•©ë‹ˆë‹¤.</p>
                                        <p>3. ì•„ë˜ ì½”ë“œë¥¼ <b>ì „ì²´ ë³µì‚¬í•˜ì—¬ ë¶™ì—¬ë„£ê¸°</b> í•˜ì„¸ìš”.</p>
                                        <div className="relative group mt-2">
                                            <pre className="bg-slate-900 text-slate-300 p-4 rounded-xl text-xs overflow-auto font-mono h-32">{GAS_CODE}</pre>
                                            <button
                                                onClick={() => { navigator.clipboard.writeText(GAS_CODE); alert("ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }}
                                                className="absolute top-2 right-2 bg-brand-500 hover:bg-brand-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-md transition-all active:scale-95"
                                            >
                                                ì½”ë“œê°€ ë‹´ê¸´ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬
                                            </button>
                                        </div>
                                        <p>4. <b>[ë°°í¬] &gt; [ìƒˆ ë°°í¬] &gt; ìœ í˜•: ì›¹ ì•± &gt; ì•¡ì„¸ìŠ¤ ê¶Œí•œ: ëª¨ë“  ì‚¬ìš©ì</b>ë¡œ ë°°í¬í•©ë‹ˆë‹¤.</p>
                                    </div>
                                    <div className="pt-4 border-t border-slate-200">
                                        <label className="text-xs font-bold text-brand-600 uppercase tracking-wider">ë°°í¬ëœ ì›¹ ì•± URL ì£¼ì†Œ ì…ë ¥</label>
                                        <input
                                            type="password"
                                            value={url}
                                            onChange={e => setUrl(e.target.value)}
                                            placeholder="https://script.google.com/macros/s/..."
                                            className={inputClass}
                                        />
                                    </div>
                                </div>
                            </section>

                            {/* ë‹¨ê³„ 2: ì§€ë„ */}
                            <section className="space-y-4">
                                <h3 className="font-bold text-slate-800 text-lg flex items-center gap-3">
                                    <span className="w-8 h-8 bg-amber-500 text-white rounded-full flex items-center justify-center text-sm shadow-md">2</span>
                                    ì§€ë„ ê¸°ëŠ¥ í™œì„±í™” (Google Maps)
                                </h3>
                                <div className="bg-slate-50 border border-slate-200 rounded-2xl p-6 text-sm text-slate-600 space-y-4">
                                    <div className="space-y-2">
                                        <p>1. <a href="https://console.cloud.google.com/google/maps-apis/overview" target="_blank" className="text-brand-600 font-bold underline hover:text-brand-700 transition-colors">Google Cloud Console</a>ì— ì ‘ì†í•©ë‹ˆë‹¤.</p>
                                        <p>2. <b>[API ë° ì„œë¹„ìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬]</b>ì—ì„œ ì•„ë˜ APIë¥¼ í™œì„±í™” í•˜ì„¸ìš”.</p>
                                        <div className="flex gap-2 text-xs font-medium">
                                            <span className="bg-white border px-2 py-1 rounded-md text-slate-500">Maps JavaScript API</span>
                                            <span className="bg-white border px-2 py-1 rounded-md text-slate-500">Places API</span>
                                        </div>
                                        <p>3. <b>[ì‚¬ìš©ì ì¸ì¦ ì •ë³´]</b>ì—ì„œ <b>API í‚¤</b>ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
                                        <div className="bg-amber-50 border border-amber-100 text-amber-700 p-3 rounded-xl text-[11px] leading-relaxed">
                                            âš ï¸ ê²°ì œ í”„ë¡œí•„ì´ ë“±ë¡ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. (ë¬´ë£Œ ì‚¬ìš© ë²”ìœ„ ë‚´ì—ì„œëŠ” ê³¼ê¸ˆë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)
                                        </div>
                                    </div>
                                    <div className="pt-4 border-t border-slate-200">
                                        <label className="text-xs font-bold text-amber-600 uppercase tracking-wider">ë°œê¸‰ë°›ì€ Google Maps API KEY ì…ë ¥</label>
                                        <input
                                            type="password"
                                            value={apiKey}
                                            onChange={e => setApiKey(e.target.value)}
                                            placeholder="AIzaSy..."
                                            className={inputClass}
                                        />
                                    </div>
                                </div>
                            </section>

                            <button
                                onClick={connect}
                                disabled={!url || !apiKey || loading}
                                className="w-full bg-brand-600 hover:bg-brand-700 text-white py-5 rounded-2xl font-bold text-xl shadow-xl shadow-brand-100 transition-all hover:-translate-y-0.5 active:translate-y-0 active:shadow-md disabled:opacity-50 disabled:translate-y-0 disabled:shadow-none mt-4"
                            >
                                {loading ? 'ì‹œìŠ¤í…œ ì—°ê²° í™•ì¸ ì¤‘...' : 'ëª¨ë“  ì„¤ì • ì™„ë£Œ - ì‹œìŠ¤í…œ ì‹œì‘í•˜ê¸°'}
                            </button>

                            <p className="text-center text-xs text-slate-400">ì„¤ì •ëœ ì •ë³´ëŠ” ë¸Œë¼ìš°ì €ì˜ ë¡œì»¬ ì €ì¥ì†Œì— ì•ˆì „í•˜ê²Œ ë³´ê´€ë©ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>
            )
        };

        const Modal = ({ leader, onClose, onUpdate }) => {
            const [members, setMembers] = useState([]), [loading, setLoading] = useState(true);
            useEffect(() => { if (leader.id) { setLoading(true); fetchMembersByLeader(leader.id).then(setMembers).finally(() => setLoading(false)) } }, [leader]);
            const remove = async (id, mode) => { if (!confirm(mode === 'DELETE' ? "ì‚­ì œ?" : "ì œì™¸?")) return; await removeMember(id, leader.id, mode); setMembers(await fetchMembersByLeader(leader.id)); onUpdate() };
            return (<div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50"><div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col"><div className="px-6 py-4 border-b flex justify-between bg-slate-50"><div><b className="text-lg">{leader.name}</b> ì†Œê·¸ë£¹ì› ({members.length}ëª…)</div><button onClick={onClose}>âœ•</button></div><div className="flex-1 overflow-auto p-4">{loading ? <div className="text-center py-8">ë¡œë”©...</div> : members.length === 0 ? <div className="text-center text-slate-400 py-8">ì—†ìŒ</div> : members.map(m => <div key={m.id} className="flex justify-between p-3 bg-slate-50 rounded-lg mb-2"><div><b>{m.name}</b> <span className="text-xs text-slate-500">{m.role} Â· {calcAge(m.birthdate)}ì„¸</span></div><div className="text-xs space-x-2"><button onClick={() => remove(m.id, 'UNASSIGN')} className="text-amber-600">ì œì™¸</button><button onClick={() => remove(m.id, 'DELETE')} className="text-red-600">ì‚­ì œ</button></div></div>)}</div><div className="p-4 border-t text-right"><button onClick={onClose} className="px-4 py-2 border rounded-lg">ë‹«ê¸°</button></div></div></div>)
        };

        // ì •ë³´ ìˆ˜ì • ëª¨ë‹¬
        const EditModal = ({ item, type, leaders, onClose, onUpdate }) => {
            const [form, setForm] = useState({ ...item });
            const [saving, setSaving] = useState(false);
            const [addressChanged, setAddressChanged] = useState(false);

            const handleChange = (key, value) => {
                setForm(prev => ({ ...prev, [key]: value }));
                if (key === 'address') setAddressChanged(true);
            };

            const save = async () => {
                setSaving(true);
                try {
                    let updates = {};
                    const fields = type === 'leader'
                        ? ['name', 'role', 'gender', 'birthdate', 'contact', 'address', 'max_capacity']
                        : ['name', 'role', 'gender', 'birthdate', 'contact', 'address', 'leader_id'];

                    for (const f of fields) {
                        if (String(form[f] ?? '') !== String(item[f] ?? '')) {
                            updates[f] = form[f];
                        }
                    }

                    // ì£¼ì†Œê°€ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ì¢Œí‘œ ì—…ë°ì´íŠ¸
                    if (addressChanged && updates.address) {
                        console.log('[EditModal] ì£¼ì†Œ ë³€ê²½ ê°ì§€, geocode í˜¸ì¶œ:', updates.address);
                        try {
                            const geo = await geocodeAddress(updates.address);
                            console.log('[EditModal] geocode ì„±ê³µ:', geo);
                            updates.address = geo.formattedAddress;
                            updates.lat = geo.lat;
                            updates.lng = geo.lng;
                        } catch (geoErr) {
                            console.error('[EditModal] geocode ì‹¤íŒ¨:', geoErr);
                            alert(`ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨: ${geoErr.message}\nì…ë ¥í•œ ì£¼ì†Œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`);
                            setSaving(false);
                            return;
                        }
                    }

                    if (Object.keys(updates).length === 0) {
                        alert("ë³€ê²½ì‚¬í•­ ì—†ìŒ");
                        setSaving(false);
                        return;
                    }

                    console.log('[EditModal] ì„œë²„ë¡œ ì „ì†¡í•  updates:', updates);

                    if (type === 'leader') {
                        await updateLeader(item.id, updates);
                    } else {
                        await updateMember(item.id, updates);
                    }

                    alert("ìˆ˜ì • ì™„ë£Œ");
                    onUpdate();
                    onClose();
                } catch (e) {
                    console.error('[EditModal] ì €ì¥ ì‹¤íŒ¨:', e);
                    alert(`ì €ì¥ ì‹¤íŒ¨: ${e.message}`);
                } finally {
                    setSaving(false);
                }
            };

            const ic = "block w-full rounded-md border shadow-sm py-2 px-3 text-sm";

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
                        <div className="px-6 py-4 border-b flex justify-between bg-slate-50">
                            <b className="text-lg">âœï¸ {type === 'leader' ? 'ë¦¬ë”' : 'ìˆœì›'} ì •ë³´ ìˆ˜ì •</b>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600">âœ•</button>
                        </div>
                        <div className="p-6 space-y-4">
                            <div>
                                <label className="text-xs font-bold text-slate-500 block mb-1">ì´ë¦„</label>
                                <input value={form.name || ''} onChange={e => handleChange('name', e.target.value)} className={ic} />
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-xs font-bold text-slate-500 block mb-1">ì§ë¶„</label>
                                    <input value={form.role || ''} onChange={e => handleChange('role', e.target.value)} className={ic} />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-500 block mb-1">ìƒë…„ì›”ì¼</label>
                                    <input type="date" value={form.birthdate || ''} onChange={e => handleChange('birthdate', e.target.value)} className={ic} />
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-xs font-bold text-slate-500 block mb-1">ì„±ë³„</label>
                                    <select value={form.gender || 'Male'} onChange={e => handleChange('gender', e.target.value)} className={ic}>
                                        <option value="Male">ë‚¨</option>
                                        <option value="Female">ì—¬</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-500 block mb-1">ì—°ë½ì²˜</label>
                                    <input value={form.contact || ''} onChange={e => handleChange('contact', e.target.value)} className={ic} placeholder="010-0000-0000" />
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 block mb-1">ì£¼ì†Œ</label>
                                <input value={form.address || ''} onChange={e => handleChange('address', e.target.value)} className={ic} />
                                {addressChanged && <p className="text-xs text-amber-600 mt-1">âš ï¸ ì£¼ì†Œ ë³€ê²½ ì‹œ ì¢Œí‘œê°€ ë‹¤ì‹œ ê³„ì‚°ë©ë‹ˆë‹¤</p>}
                            </div>
                            {type === 'leader' ? (
                                <div>
                                    <label className="text-xs font-bold text-slate-500 block mb-1">ì •ì›</label>
                                    <input type="number" value={form.max_capacity || ''} onChange={e => handleChange('max_capacity', e.target.value)} className={ic} />
                                </div>
                            ) : (
                                <div>
                                    <label className="text-xs font-bold text-slate-500 block mb-1">ì†Œì† ë¦¬ë”</label>
                                    <select value={form.leader_id || ''} onChange={e => handleChange('leader_id', e.target.value)} className={ic}>
                                        <option value="">ë¯¸ë°°ì •</option>
                                        {leaders?.map(l => <option key={l.id} value={l.id}>{l.name} ({l.current_members}/{l.max_capacity}ëª…){l.current_members >= l.max_capacity ? ' [ë§Œì„]' : ''}</option>)}
                                    </select>
                                </div>
                            )}
                        </div>
                        <div className="p-4 border-t bg-slate-50 flex gap-2 justify-end">
                            <button onClick={onClose} className="px-4 py-2 border rounded-lg">ì·¨ì†Œ</button>
                            <button onClick={save} disabled={saving} className="px-4 py-2 bg-brand-600 text-white rounded-lg font-bold disabled:opacity-50">
                                {saving ? 'ì €ì¥ì¤‘...' : 'ì €ì¥'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const DuplicateCheckModal = ({ onClose, onUpdate }) => {
            const [loading, setLoading] = useState(true), [duplicates, setDuplicates] = useState({ nameContactDups: [], leaderAsMember: [] });
            useEffect(() => { checkDuplicates() }, []);
            const checkDuplicates = async () => {
                setLoading(true);
                try {
                    const { leaders, members } = await fetchFullData();
                    // 1. ì´ë¦„+ì—°ë½ì²˜ ê¸°ì¤€ ì¤‘ë³µ ì²´í¬ (ë¦¬ë” ê°„, ìˆœì› ê°„, ë¦¬ë”-ìˆœì› ê°„)
                    const allPeople = [...leaders.map(l => ({ ...l, type: 'leader' })), ...members.map(m => ({ ...m, type: 'member' }))];
                    const keyMap = {};
                    allPeople.forEach(p => {
                        const key = `${(p.name || '').trim()}_${(p.contact || '').trim()}`;
                        if (key === '_') return;
                        if (!keyMap[key]) keyMap[key] = [];
                        keyMap[key].push(p);
                    });
                    const nameContactDups = Object.entries(keyMap).filter(([k, v]) => v.length > 1).map(([k, v]) => ({ key: k, people: v }));
                    // 2. ë¦¬ë”ê°€ ìˆœì›ìœ¼ë¡œë„ ë“±ë¡ëœ ê²½ìš° (ì´ë¦„+ì—°ë½ì²˜ ê¸°ì¤€)
                    const leaderKeys = new Set(leaders.map(l => `${(l.name || '').trim()}_${(l.contact || '').trim()}`));
                    const leaderAsMember = members.filter(m => {
                        const key = `${(m.name || '').trim()}_${(m.contact || '').trim()}`;
                        return key !== '_' && leaderKeys.has(key);
                    }).map(m => {
                        const matchedLeader = leaders.find(l => `${(l.name || '').trim()}_${(l.contact || '').trim()}` === `${(m.name || '').trim()}_${(m.contact || '').trim()}`);
                        return { member: m, leader: matchedLeader };
                    });
                    setDuplicates({ nameContactDups, leaderAsMember });
                } catch (e) { alert(e.message) }
                finally { setLoading(false) }
            };
            const deleteMember = async (id) => { if (!confirm("ì´ ìˆœì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; await removeMember(id, null, 'DELETE'); await checkDuplicates(); onUpdate() };
            const deleteLeader = async (id) => { if (!confirm("ì´ ë¦¬ë”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì†Œì† ìˆœì›ì€ ë¯¸ë°°ì • ìƒíƒœê°€ ë©ë‹ˆë‹¤)")) return; await request('DELETE_LEADER', { id }); await checkDuplicates(); onUpdate() };
            const totalIssues = duplicates.nameContactDups.length + duplicates.leaderAsMember.length;
            return (<div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50"><div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[85vh] overflow-hidden flex flex-col"><div className="px-6 py-4 border-b flex justify-between bg-slate-50"><div><b className="text-lg">ğŸ” ì¤‘ë³µ ê²€ì‚¬ ê²°ê³¼</b> {!loading && <span className={`ml-2 text-sm ${totalIssues > 0 ? 'text-red-600' : 'text-green-600'}`}>{totalIssues > 0 ? `${totalIssues}ê±´ ë°œê²¬` : 'ì´ìƒ ì—†ìŒ âœ“'}</span>}</div><button onClick={onClose} className="text-slate-400 hover:text-slate-600">âœ•</button></div><div className="flex-1 overflow-auto p-6 space-y-6">{loading ? <div className="text-center py-12"><div className="w-8 h-8 border-4 border-brand-200 border-t-brand-600 rounded-full animate-spin mx-auto mb-4" />ê²€ì‚¬ì¤‘...</div> : <>{duplicates.leaderAsMember.length > 0 && <div className="space-y-3"><div className="flex items-center gap-2 text-red-600 font-bold"><span className="text-lg">âš ï¸</span> ë¦¬ë”ê°€ ìˆœì›ìœ¼ë¡œ ë“±ë¡ë¨ ({duplicates.leaderAsMember.length}ê±´)</div><div className="text-xs text-slate-500 mb-2">ë¦¬ë”ê°€ ë‹¤ë¥¸ ê·¸ë£¹ì˜ ìˆœì›ìœ¼ë¡œë„ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ìˆœì› ê¸°ë¡ì„ ì‚­ì œí•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.</div>{duplicates.leaderAsMember.map((d, i) => <div key={i} className="bg-red-50 border border-red-200 rounded-xl p-4"><div className="flex justify-between items-start"><div><div className="font-bold text-red-700">{d.member.name} <span className="text-xs font-normal">({d.member.contact})</span></div><div className="text-xs text-slate-600 mt-1"><span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded mr-2">ë¦¬ë”</span> {d.leader?.role} Â· {d.leader?.address}</div><div className="text-xs text-slate-600 mt-1"><span className="bg-amber-100 text-amber-700 px-2 py-0.5 rounded mr-2">ìˆœì›</span> {d.member.role} Â· {d.member.address}</div></div><button onClick={() => deleteMember(d.member.id)} className="text-xs bg-red-600 text-white px-3 py-1.5 rounded-lg hover:bg-red-700">ìˆœì› ì‚­ì œ</button></div></div>)}</div>}{duplicates.nameContactDups.length > 0 && <div className="space-y-3"><div className="flex items-center gap-2 text-amber-600 font-bold"><span className="text-lg">ğŸ“‹</span> ë™ì¼ì¸ ì¤‘ë³µ ë“±ë¡ ({duplicates.nameContactDups.length}ê±´)</div><div className="text-xs text-slate-500 mb-2">ê°™ì€ ì´ë¦„ê³¼ ì—°ë½ì²˜ë¥¼ ê°€ì§„ ì‚¬ëŒì´ ì—¬ëŸ¬ ë²ˆ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</div>{duplicates.nameContactDups.map((dup, i) => <div key={i} className="bg-amber-50 border border-amber-200 rounded-xl p-4"><div className="font-bold text-amber-700 mb-2">{dup.people[0]?.name} <span className="text-xs font-normal">({dup.people[0]?.contact})</span> - {dup.people.length}ê°œ ë ˆì½”ë“œ</div><div className="space-y-2">{dup.people.map((p, j) => <div key={j} className="flex justify-between items-center bg-white rounded-lg p-2 text-sm"><div><span className={`text-xs px-2 py-0.5 rounded mr-2 ${p.type === 'leader' ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-600'}`}>{p.type === 'leader' ? 'ë¦¬ë”' : 'ìˆœì›'}</span>{p.role} Â· {calcAge(p.birthdate)}ì„¸ Â· {p.address}</div><button onClick={() => p.type === 'leader' ? deleteLeader(p.id) : deleteMember(p.id)} className="text-xs text-red-600 hover:text-red-800 px-2">ì‚­ì œ</button></div>)}</div></div>)}</div>}{totalIssues === 0 && <div className="text-center py-12"><div className="text-6xl mb-4">âœ…</div><div className="text-xl font-bold text-green-600">ì¤‘ë³µ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div><div className="text-sm text-slate-500 mt-2">ëª¨ë“  ë°ì´í„°ê°€ ì •ìƒì…ë‹ˆë‹¤.</div></div>}</>}</div><div className="p-4 border-t bg-slate-50 flex justify-between"><button onClick={checkDuplicates} disabled={loading} className="text-sm bg-white border px-4 py-2 rounded-lg hover:bg-slate-50">ğŸ”„ ë‹¤ì‹œ ê²€ì‚¬</button><button onClick={onClose} className="px-4 py-2 bg-brand-600 text-white rounded-lg font-bold">ë‹«ê¸°</button></div></div></div>)
        };

        const LeaderUpload = ({ globalData, onRefresh }) => {
            const getStoredLeaderForm = () => { try { const s = sessionStorage.getItem('LEADER_FORM'); return s ? JSON.parse(s) : null } catch { return null } };
            const getStoredMemberForm = () => { try { const s = sessionStorage.getItem('MEMBER_FORM'); return s ? JSON.parse(s) : null } catch { return null } };
            const [scope, setScope] = useState('LEADER'), [mode, setMode] = useState('csv'), [listTab, setListTab] = useState('LEADER');
            // ì „ì—­ ë°ì´í„° ì‚¬ìš©
            const leaders = globalData?.leaders || [];
            const members = globalData?.members || [];
            const [processing, setProcessing] = useState(false), [logs, setLogs] = useState([]), [progress, setProgress] = useState(0);
            const [form, setForm] = useState(() => getStoredLeaderForm() || { name: '', role: 'ì§‘ì‚¬', gender: 'Male', birthdate: '', contact: '', address: '', max_capacity: 10 });
            const [mForm, setMForm] = useState(() => getStoredMemberForm() || { name: '', role: 'ì„±ë„', gender: 'Male', birthdate: '', contact: '', address: '', leader_id: '' });
            const [saving, setSaving] = useState(false), [selected, setSelected] = useState(null), [showDupCheck, setShowDupCheck] = useState(false);
            const [editItem, setEditItem] = useState(null), [editType, setEditType] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [sortBy, setSortBy] = useState('name'); // 'name' | 'age'

            // ë°ì´í„° ë³€ê²½ í›„ ìƒˆë¡œê³ ì¹¨ì€ onRefresh í˜¸ì¶œ
            const loadData = () => onRefresh?.();

            useEffect(() => { sessionStorage.setItem('LEADER_FORM', JSON.stringify(form)) }, [form]);
            useEffect(() => { sessionStorage.setItem('MEMBER_FORM', JSON.stringify(mForm)) }, [mForm]);

            const log = m => setLogs(p => [m, ...p]);

            // ì •ë ¬ í•¨ìˆ˜
            const sortItems = (items) => {
                return [...items].sort((a, b) => {
                    if (sortBy === 'age') return calcAge(b.birthdate) - calcAge(a.birthdate);
                    return (a.name || '').localeCompare(b.name || '', 'ko');
                });
            };

            // ê²€ìƒ‰ í•„í„°ë§ + ì •ë ¬
            const filteredLeaders = sortItems(leaders.filter(l => {
                if (!searchQuery.trim()) return true;
                const q = searchQuery.toLowerCase();
                return l.name?.toLowerCase().includes(q) || l.contact?.includes(q) || l.address?.toLowerCase().includes(q);
            }));

            const filteredMembers = sortItems(members.filter(m => {
                if (!searchQuery.trim()) return true;
                const q = searchQuery.toLowerCase();
                return m.name?.toLowerCase().includes(q) || m.contact?.includes(q) || m.address?.toLowerCase().includes(q);
            }));

            const downloadSampleCSV = () => {
                let csvContent, filename;
                if (scope === 'LEADER') {
                    csvContent = "name,role,gender,birthdate,contact,address,max_capacity\ní™ê¸¸ë™,ì§‘ì‚¬,Male,1980-03-15,010-1234-5678,ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™ 123,10\nê¹€ì˜í¬,ê¶Œì‚¬,Female,1973-08-22,010-9876-5432,ì„œìš¸ì‹œ ì„œì´ˆêµ¬ ì„œì´ˆë™ 456,8";
                    filename = "ë¦¬ë”_ìƒ˜í”Œ.csv";
                } else {
                    csvContent = "name,role,gender,birthdate,contact,address,leader_name\nì´ì² ìˆ˜,ì„±ë„,Male,1990-05-10,010-1111-2222,ì„œìš¸ì‹œ ì†¡íŒŒêµ¬ ì ì‹¤ë™ 789,í™ê¸¸ë™\në°•ë¯¼ì˜,ì²­ë…„,Female,1997-12-03,010-3333-4444,ì„œìš¸ì‹œ ê°•ë™êµ¬ ì²œí˜¸ë™ 321,";
                    filename = "ìˆœì›_ìƒ˜í”Œ.csv";
                }
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
            };

            const upload = e => { const file = e.target.files?.[0]; if (!file) return; setProcessing(true); setLogs([]); setProgress(0); Papa.parse(file, { header: true, skipEmptyLines: true, complete: async r => { const rows = r.data; log(`${rows.length}ê°œ ì²˜ë¦¬ ì‹œì‘`); for (let i = 0; i < rows.length; i++) { const row = rows[i]; if (!row.name || !row.address) { log(`[SKIP] ${i + 1}í–‰`); continue } try { const geo = await geocodeAddress(row.address); if (scope === 'LEADER') await insertLeader({ name: row.name, role: row.role || 'ì„±ë„', gender: row.gender || 'Male', birthdate: row.birthdate || '', contact: row.contact || '', address: row.address, lat: geo.lat, lng: geo.lng, max_capacity: parseInt(row.max_capacity) || 10, current_members: 0 }); else { let lid = null; if (row.leader_name) { const m = leaders.find(l => l.name === row.leader_name); if (m) lid = m.id } await insertMember({ name: row.name, role: row.role || 'ì„±ë„', gender: row.gender || 'Male', birthdate: row.birthdate || '', contact: row.contact || '', address: row.address, lat: geo.lat, lng: geo.lng, leader_id: lid }) } log(`[OK] ${row.name}`) } catch (err) { log(`[ERR] ${row.name}`) } setProgress(Math.round((i + 1) / rows.length * 100)); await sleep(GEOCODE_DELAY_MS) } setProcessing(false); loadData(); e.target.value = '' } }) };

            const submit = async e => { e.preventDefault(); setSaving(true); try { if (scope === 'LEADER') { const geo = await geocodeAddress(form.address); await insertLeader({ ...form, max_capacity: parseInt(form.max_capacity), lat: geo.lat, lng: geo.lng, current_members: 0 }); alert("ë“±ë¡ ì™„ë£Œ"); setForm({ name: '', role: 'ì§‘ì‚¬', gender: 'Male', birthdate: '', contact: '', address: '', max_capacity: 10 }) } else { const geo = await geocodeAddress(mForm.address); await insertMember({ ...mForm, lat: geo.lat, lng: geo.lng, leader_id: mForm.leader_id ? parseInt(mForm.leader_id) : null }); alert("ë“±ë¡ ì™„ë£Œ"); setMForm({ name: '', role: 'ì„±ë„', gender: 'Male', birthdate: '', contact: '', address: '', leader_id: '' }) } loadData() } catch (err) { alert(err.message) } finally { setSaving(false) } };

            const delLeader = async (id, e) => { e.stopPropagation(); if (!confirm("ì‚­ì œ? ì†Œì† ìˆœì›ì€ ë¯¸ë°°ì • ìƒíƒœê°€ ë©ë‹ˆë‹¤.")) return; await deleteLeader(id); loadData() };
            const delMember = async (id, e) => { e.stopPropagation(); if (!confirm("ì‚­ì œ?")) return; await removeMember(id, null, 'DELETE'); loadData() };

            const openEdit = (item, type, e) => { e?.stopPropagation(); setEditItem(item); setEditType(type); };

            const exp = async () => { const { leaders, members } = await fetchFullData(); const data = []; leaders.forEach(l => { const ms = members.filter(m => m.leader_id === l.id); if (!ms.length) data.push({ 'ë¦¬ë”': l.name, 'ìˆœì›': '(ì—†ìŒ)' }); else ms.forEach(m => data.push({ 'ë¦¬ë”': l.name, 'ìˆœì›': m.name, 'ì£¼ì†Œ': m.address })) }); members.filter(m => !m.leader_id).forEach(m => data.push({ 'ë¦¬ë”': '(ë¯¸ë°°ì •)', 'ìˆœì›': m.name })); XLSX.writeFile(XLSX.utils.book_new().concat ?? (wb => { XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "í¸ì„±í‘œ"); return wb })(XLSX.utils.book_new()), `ì†Œê·¸ë£¹_${new Date().toISOString().slice(0, 10)}.xlsx`) };

            const getLeaderName = (leaderId) => { const l = leaders.find(x => x.id === leaderId); return l ? l.name : 'ë¯¸ë°°ì •'; };

            const ic = "block w-full rounded-md border shadow-sm py-2 px-3 text-sm";

            return (<div className="grid grid-cols-1 lg:grid-cols-3 gap-8 pb-12">
                {selected && <Modal leader={selected} onClose={() => setSelected(null)} onUpdate={loadData} />}
                {showDupCheck && <DuplicateCheckModal onClose={() => setShowDupCheck(false)} onUpdate={loadData} />}
                {editItem && <EditModal item={editItem} type={editType} leaders={leaders} onClose={() => { setEditItem(null); setEditType(null); }} onUpdate={loadData} />}

                {/* ì™¼ìª½: ë“±ë¡ í¼ */}
                <div className="space-y-4">
                    <div className="bg-slate-100 p-1 rounded-xl flex">
                        <button onClick={() => setScope('LEADER')} className={`flex-1 py-2 text-sm font-bold rounded-lg ${scope === 'LEADER' ? 'bg-white text-brand-600' : 'text-slate-500'}`}>ë¦¬ë”</button>
                        <button onClick={() => setScope('MEMBER')} className={`flex-1 py-2 text-sm font-bold rounded-lg ${scope === 'MEMBER' ? 'bg-white text-brand-600' : 'text-slate-500'}`}>ìˆœì›</button>
                    </div>
                    <div className="bg-white p-1 rounded-xl border flex">
                        <button onClick={() => setMode('csv')} className={`flex-1 py-2 text-sm rounded-lg ${mode === 'csv' ? 'bg-brand-50 text-brand-700' : 'text-slate-500'}`}>CSV</button>
                        <button onClick={() => setMode('manual')} className={`flex-1 py-2 text-sm rounded-lg ${mode === 'manual' ? 'bg-brand-50 text-brand-700' : 'text-slate-500'}`}>ì§ì ‘</button>
                    </div>
                    {mode === 'csv' ? (
                        <div className="bg-white rounded-2xl border p-6 space-y-4">
                            <button onClick={downloadSampleCSV} className="w-full text-xs bg-amber-50 text-amber-700 px-4 py-2 rounded-lg border border-amber-200 hover:bg-amber-100 font-medium">ğŸ“¥ {scope === 'LEADER' ? 'ë¦¬ë”' : 'ìˆœì›'} ìƒ˜í”Œ CSV ë‹¤ìš´ë¡œë“œ</button>
                            <label className="block border-2 border-dashed rounded-xl p-6 text-center cursor-pointer border-brand-200 hover:border-brand-400">
                                <input type="file" accept=".csv" onChange={upload} className="hidden" disabled={processing} />
                                <span className="text-brand-600 font-medium">CSV ì„ íƒ</span>
                            </label>
                            {processing && <div className="h-2 bg-slate-100 rounded-full"><div className="h-full bg-brand-500 rounded-full" style={{ width: `${progress}%` }} /></div>}
                            <div className="h-40 bg-slate-900 rounded-lg p-3 overflow-auto font-mono text-xs text-green-400">{logs.map((l, i) => <div key={i}>{l}</div>)}</div>
                        </div>
                    ) : (
                        <form onSubmit={submit} className="bg-white rounded-2xl border p-6 space-y-3">
                            {scope === 'LEADER' ? <>
                                <input required value={form.name} onChange={e => setForm({ ...form, name: e.target.value })} className={ic} placeholder="ì´ë¦„" />
                                <input required value={form.address} onChange={e => setForm({ ...form, address: e.target.value })} className={ic} placeholder="ì£¼ì†Œ" />
                                <div className="grid grid-cols-2 gap-2">
                                    <input type="date" required value={form.birthdate} onChange={e => setForm({ ...form, birthdate: e.target.value })} className={ic} title="ìƒë…„ì›”ì¼" />
                                    <select value={form.gender} onChange={e => setForm({ ...form, gender: e.target.value })} className={ic}><option value="Male">ë‚¨</option><option value="Female">ì—¬</option></select>
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                    <input value={form.role} onChange={e => setForm({ ...form, role: e.target.value })} className={ic} placeholder="ì§ë¶„ (ì˜ˆ: ì§‘ì‚¬)" />
                                    <input value={form.contact} onChange={e => setForm({ ...form, contact: formatPhone(e.target.value) })} className={ic} placeholder="ì—°ë½ì²˜" />
                                </div>
                                <input type="number" value={form.max_capacity} onChange={e => setForm({ ...form, max_capacity: e.target.value })} className={ic} placeholder="ì •ì› (ê¸°ë³¸ 10ëª…)" min="1" />
                            </> : <>
                                <input required value={mForm.name} onChange={e => setMForm({ ...mForm, name: e.target.value })} className={ic} placeholder="ì´ë¦„" />
                                <input required value={mForm.address} onChange={e => setMForm({ ...mForm, address: e.target.value })} className={ic} placeholder="ì£¼ì†Œ" />
                                <div className="grid grid-cols-2 gap-2">
                                    <input type="date" required value={mForm.birthdate} onChange={e => setMForm({ ...mForm, birthdate: e.target.value })} className={ic} title="ìƒë…„ì›”ì¼" />
                                    <select value={mForm.gender} onChange={e => setMForm({ ...mForm, gender: e.target.value })} className={ic}><option value="Male">ë‚¨</option><option value="Female">ì—¬</option></select>
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                    <input value={mForm.role} onChange={e => setMForm({ ...mForm, role: e.target.value })} className={ic} placeholder="ì§ë¶„ (ì˜ˆ: ì„±ë„)" />
                                    <input value={mForm.contact} onChange={e => setMForm({ ...mForm, contact: formatPhone(e.target.value) })} className={ic} placeholder="ì—°ë½ì²˜" />
                                </div>
                                <select value={mForm.leader_id} onChange={e => setMForm({ ...mForm, leader_id: e.target.value })} className={ic}>
                                    <option value="">ë¯¸ë°°ì • (ë¦¬ë” ì„ íƒ)</option>
                                    {leaders.map(l => <option key={l.id} value={l.id}>{l.name} ({l.current_members}/{l.max_capacity}ëª…){l.current_members >= l.max_capacity ? ' [ë§Œì„]' : ''}</option>)}
                                </select>
                            </>}
                            <button disabled={saving} className="w-full bg-brand-600 text-white py-2 rounded-lg font-bold">{saving ? 'ì €ì¥ì¤‘...' : 'ë“±ë¡'}</button>
                        </form>
                    )}
                </div>

                {/* ì˜¤ë¥¸ìª½: ë¦¬ìŠ¤íŠ¸ (ë¦¬ë”/ìˆœì› íƒ­) */}
                <div className="lg:col-span-2 bg-white rounded-2xl border flex flex-col h-[600px]">
                    <div className="px-4 py-3 border-b bg-slate-50 space-y-3">
                        {/* íƒ­ + ê²€ìƒ‰ */}
                        <div className="flex items-center justify-between gap-4">
                            <div className="flex bg-slate-200 p-0.5 rounded-lg">
                                <button onClick={() => setListTab('LEADER')} className={`px-3 py-1 text-sm font-medium rounded ${listTab === 'LEADER' ? 'bg-white text-brand-600' : 'text-slate-500'}`}>ë¦¬ë” ({leaders.length})</button>
                                <button onClick={() => setListTab('MEMBER')} className={`px-3 py-1 text-sm font-medium rounded ${listTab === 'MEMBER' ? 'bg-white text-brand-600' : 'text-slate-500'}`}>ìˆœì› ({members.length})</button>
                                <button onClick={() => setListTab('UNASSIGNED')} className={`px-3 py-1 text-sm font-medium rounded ${listTab === 'UNASSIGNED' ? 'bg-white text-red-600' : 'text-slate-500'}`}>ë¯¸ë°°ì • ({members.filter(m => !m.leader_id).length})</button>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setShowDupCheck(true)} className="text-xs bg-red-50 text-red-600 px-3 py-1 rounded border border-red-200 hover:bg-red-100 font-medium">ğŸ” ì¤‘ë³µê²€ì‚¬</button>
                                <button onClick={exp} className="text-xs bg-green-50 text-green-700 px-3 py-1 rounded border border-green-200">ì—‘ì…€</button>
                                <button onClick={loadData} className="text-xs bg-white px-2 py-1 rounded border">ìƒˆë¡œê³ ì¹¨</button>
                            </div>
                        </div>
                        {/* ê²€ìƒ‰ì°½ + ì •ë ¬ */}
                        <div className="flex gap-2 items-center">
                            <input
                                type="text"
                                value={searchQuery}
                                onChange={e => setSearchQuery(e.target.value)}
                                placeholder="ğŸ” ì´ë¦„, ì—°ë½ì²˜, ì£¼ì†Œë¡œ ê²€ìƒ‰..."
                                className="flex-1 text-sm border rounded-lg px-3 py-2"
                            />
                            <div className="flex bg-slate-100 p-0.5 rounded text-xs">
                                <button onClick={() => setSortBy('name')} className={`px-2 py-1 rounded ${sortBy === 'name' ? 'bg-white text-brand-600 font-bold' : 'text-slate-500'}`}>ì´ë¦„ìˆœ</button>
                                <button onClick={() => setSortBy('age')} className={`px-2 py-1 rounded ${sortBy === 'age' ? 'bg-white text-brand-600 font-bold' : 'text-slate-500'}`}>ë‚˜ì´ìˆœ</button>
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 overflow-auto">
                        {listTab === 'LEADER' ? (
                            filteredLeaders.length === 0 ? <div className="p-8 text-center text-slate-400"><div className="text-4xl mb-2">ğŸ‘¤</div><div className="font-medium">ë“±ë¡ëœ ë¦¬ë”ê°€ ì—†ìŠµë‹ˆë‹¤</div><div className="text-sm mt-1">ì¢Œì¸¡ì—ì„œ ë¦¬ë”ë¥¼ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.</div></div> :
                                filteredLeaders.map(l => (
                                    <div key={l.id} onClick={() => setSelected(l)} className="p-4 border-b hover:bg-slate-50 cursor-pointer flex justify-between">
                                        <div>
                                            <b>{genderIcon(l.gender)} {l.name}</b> <span className="text-xs text-slate-500">{formatRole(l.role)} Â· {calcAge(l.birthdate)}ì„¸ ({formatBirthdate(l.birthdate)})</span>
                                            {l.contact && <span className="text-xs text-slate-400 ml-2">ğŸ“ {l.contact}</span>}
                                            <div className="text-sm text-slate-500">{l.address}</div>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className={`text-xs px-2 py-1 rounded-full ${l.current_members >= l.max_capacity ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>{l.current_members}/{l.max_capacity}</span>
                                            <button onClick={e => openEdit(l, 'leader', e)} className="text-slate-400 hover:text-brand-600">âœï¸</button>
                                            <button onClick={e => delLeader(l.id, e)} className="text-slate-400 hover:text-red-600">ğŸ—‘ï¸</button>
                                        </div>
                                    </div>
                                ))
                        ) : listTab === 'MEMBER' ? (
                            filteredMembers.length === 0 ? <div className="p-8 text-center text-slate-400"><div className="text-4xl mb-2">ğŸ‘¥</div><div className="font-medium">ë“±ë¡ëœ ìˆœì›ì´ ì—†ìŠµë‹ˆë‹¤</div><div className="text-sm mt-1">ì¢Œì¸¡ì—ì„œ ìˆœì›ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.</div></div> :
                                filteredMembers.map(m => (
                                    <div key={m.id} className="p-4 border-b hover:bg-slate-50 flex justify-between">
                                        <div>
                                            <b>{genderIcon(m.gender)} {m.name}</b> <span className="text-xs text-slate-500">{formatRole(m.role)} Â· {calcAge(m.birthdate)}ì„¸ ({formatBirthdate(m.birthdate)})</span>
                                            {m.contact && <span className="text-xs text-slate-400 ml-2">ğŸ“ {m.contact}</span>}
                                            <div className="text-sm text-slate-500">{m.address}</div>
                                            <div className="text-xs mt-1">
                                                <span className={`px-2 py-0.5 rounded ${m.leader_id ? 'bg-blue-100 text-blue-700' : 'bg-red-100 text-red-600'}`}>
                                                    {m.leader_id ? `ğŸ‘¤ ${getLeaderName(m.leader_id)}` : 'ë¯¸ë°°ì •'}
                                                </span>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <button onClick={e => openEdit(m, 'member', e)} className="text-slate-400 hover:text-brand-600">âœï¸</button>
                                            <button onClick={e => delMember(m.id, e)} className="text-slate-400 hover:text-red-600">ğŸ—‘ï¸</button>
                                        </div>
                                    </div>
                                ))
                        ) : (
                            /* ë¯¸ë°°ì • íƒ­ */
                            (() => {
                                const unassigned = members.filter(m => !m.leader_id).filter(m => {
                                    const q = searchQuery.toLowerCase();
                                    return m.name?.toLowerCase().includes(q) || m.contact?.toLowerCase().includes(q) || m.address?.toLowerCase().includes(q);
                                });
                                return unassigned.length === 0 ? <div className="p-8 text-center text-slate-400">ë¯¸ë°°ì • ìˆœì› ì—†ìŒ âœ“</div> :
                                    unassigned.map(m => (
                                        <div key={m.id} className="p-4 border-b hover:bg-red-50 flex justify-between bg-red-50/30">
                                            <div>
                                                <b>{genderIcon(m.gender)} {m.name}</b> <span className="text-xs text-slate-500">{formatRole(m.role)} Â· {calcAge(m.birthdate)}ì„¸ ({formatBirthdate(m.birthdate)})</span>
                                                {m.contact && <span className="text-xs text-slate-400 ml-2">ğŸ“ {m.contact}</span>}
                                                <div className="text-sm text-slate-500">{m.address}</div>
                                                <div className="text-xs mt-1">
                                                    <span className="px-2 py-0.5 rounded bg-red-100 text-red-600 font-medium">âš ï¸ ë¯¸ë°°ì •</span>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <button onClick={e => openEdit(m, 'member', e)} className="text-slate-400 hover:text-brand-600">âœï¸</button>
                                                <button onClick={e => delMember(m.id, e)} className="text-slate-400 hover:text-red-600">ğŸ—‘ï¸</button>
                                            </div>
                                        </div>
                                    ))
                            })()
                        )}
                    </div>
                </div>
            </div>)
        };

        const MemberMatching = ({ globalData, onRefresh }) => {
            const getStoredForm = () => { try { const s = sessionStorage.getItem('MATCH_FORM'); return s ? JSON.parse(s) : null } catch { return null } };
            const [form, setForm] = useState(() => getStoredForm() || { name: '', role: 'ì„±ë„', birthdate: '', gender: 'Male', address: '' }), [loading, setLoading] = useState(false), [candidates, setCandidates] = useState([]), [target, setTarget] = useState(null), [selId, setSelId] = useState(null); const mapRef = useRef(null), mapInst = useRef(null), markers = useRef([]);
            const [showUnassigned, setShowUnassigned] = useState(false);
            const [unassignedList, setUnassignedList] = useState([]);
            const [selectedMemberId, setSelectedMemberId] = useState(null);

            // ì „ì—­ ë°ì´í„°ì—ì„œ ë¦¬ë”ì™€ ë¯¸ë°°ì • ìˆœì› ê°€ì ¸ì˜¤ê¸°
            const leaders = globalData?.leaders || [];
            const allMembers = globalData?.members || [];

            useEffect(() => { sessionStorage.setItem('MATCH_FORM', JSON.stringify(form)) }, [form]);
            useEffect(() => { if (mapRef.current && window.google && !mapInst.current) mapInst.current = new window.google.maps.Map(mapRef.current, { center: { lat: 37.5665, lng: 126.9780 }, zoom: 12, disableDefaultUI: true, zoomControl: true, styles: MAP_STYLES }) }, []);
            useEffect(() => { if (!mapInst.current || !window.google) return; markers.current.forEach(m => m.setMap(null)); markers.current = []; const bounds = new window.google.maps.LatLngBounds(); if (target) { const m = new window.google.maps.Marker({ position: target, map: mapInst.current, animation: window.google.maps.Animation.DROP, icon: { path: window.google.maps.SymbolPath.CIRCLE, fillColor: '#dc2626', fillOpacity: 1, strokeColor: '#fff', strokeWeight: 2, scale: 12 } }); const info = new window.google.maps.InfoWindow({ content: '<div style="padding:8px;font-family:sans-serif"><b style="color:#dc2626">ğŸ“ ì‹ ê·œ ìˆœì› ìœ„ì¹˜</b></div>' }); m.addListener('mouseover', () => info.open(mapInst.current, m)); m.addListener('mouseout', () => info.close()); markers.current.push(m); bounds.extend(target) } candidates.forEach((l, i) => { const full = l.current_members >= l.max_capacity; const m = new window.google.maps.Marker({ position: { lat: l.lat, lng: l.lng }, map: mapInst.current, icon: { path: window.google.maps.SymbolPath.CIRCLE, fillColor: full ? '#94a3b8' : '#3b82f6', fillOpacity: 1, strokeColor: '#fff', strokeWeight: 2, scale: 12 }, label: { text: String(i + 1), color: '#fff', fontSize: '11px', fontWeight: 'bold' } }); const info = new window.google.maps.InfoWindow({ content: `<div style="padding:10px;font-family:sans-serif;min-width:180px"><div style="font-size:15px;font-weight:bold;color:#1e40af;margin-bottom:4px">${l.name} ${l.role}</div><div style="font-size:12px;color:#64748b">${calcAge(l.birthdate)}ì„¸ Â· ${l.gender === 'Male' ? 'ë‚¨ì„±' : 'ì—¬ì„±'}</div><div style="font-size:11px;color:#94a3b8;margin:6px 0;padding-top:6px;border-top:1px solid #e2e8f0">${l.address}</div><div style="display:flex;gap:8px;font-size:12px"><span style="background:${full ? '#fee2e2' : '#dcfce7'};color:${full ? '#dc2626' : '#16a34a'};padding:2px 8px;border-radius:4px;font-weight:600">ì •ì›: ${l.current_members}/${l.max_capacity}ëª…</span><span style="background:#f1f5f9;padding:2px 8px;border-radius:4px">ê±°ë¦¬: ${l.distance.toFixed(1)}km</span></div></div>` }); m.addListener('mouseover', () => info.open(mapInst.current, m)); m.addListener('mouseout', () => info.close()); m.addListener('click', () => { info.open(mapInst.current, m); setSelId(l.id) }); markers.current.push(m); bounds.extend({ lat: l.lat, lng: l.lng }) }); if (target || candidates.length) { mapInst.current.fitBounds(bounds); window.google.maps.event.addListenerOnce(mapInst.current, 'idle', () => { if (mapInst.current.getZoom() > 15) mapInst.current.setZoom(15) }) } }, [candidates, target]);

            // ë¯¸ë°°ì • ì¸ì› ë¶ˆëŸ¬ì˜¤ê¸° (ì „ì—­ ë°ì´í„°ì—ì„œ)
            const loadUnassigned = () => {
                if (showUnassigned) { setShowUnassigned(false); return; }
                const unassigned = allMembers.filter(m => !m.leader_id);
                setUnassignedList(unassigned);
                setShowUnassigned(true);
            };

            // ë¯¸ë°°ì • ì¸ì› ì„ íƒ
            const selectUnassigned = async (member) => {
                setSelectedMemberId(member.id);
                setForm({ name: member.name, role: member.role || 'ì„±ë„', birthdate: formatBirthdate(member.birthdate), gender: member.gender || 'Male', address: member.address || '' });
                setShowUnassigned(false);
                // ìë™ìœ¼ë¡œ ë¦¬ë” ê²€ìƒ‰
                if (member.address && member.birthdate) {
                    setLoading(true); setCandidates([]);
                    try {
                        const leaders = await fetchLeaders();
                        if (member.lat && member.lng) {
                            setTarget({ lat: member.lat, lng: member.lng });
                            const res = findClosest(member.lat, member.lng, member.birthdate, leaders, 5);
                            setCandidates(res);
                            if (!res.length) alert("ë¦¬ë” ì—†ìŒ");
                        } else {
                            const geo = await geocodeAddress(member.address);
                            setTarget({ lat: geo.lat, lng: geo.lng });
                            const res = findClosest(geo.lat, geo.lng, member.birthdate, leaders, 5);
                            setCandidates(res);
                            if (!res.length) alert("ë¦¬ë” ì—†ìŒ");
                        }
                    } catch (e) { alert(e.message); }
                    finally { setLoading(false); }
                }
            };

            const search = async e => { e?.preventDefault(); if (!form.address || !form.birthdate) { alert("ì£¼ì†Œ/ìƒë…„ì›”ì¼ í•„ìš”"); return } setLoading(true); setCandidates([]); try { const geo = await geocodeAddress(form.address); setTarget({ lat: geo.lat, lng: geo.lng }); setForm(p => ({ ...p, address: geo.formattedAddress })); const res = findClosest(geo.lat, geo.lng, form.birthdate, leaders, 5); setCandidates(res); if (!res.length) alert("ë¦¬ë” ì—†ìŒ") } catch (e) { alert(e.message) } finally { setLoading(false) } };
            const assign = async () => {
                if (!selId || !target) return;
                const name = candidates.find(c => c.id === selId)?.name;
                if (!confirm(`${form.name}â†’${name} ë°°ì •?`)) return;
                setLoading(true);
                try {
                    if (selectedMemberId) {
                        // ê¸°ì¡´ ë¯¸ë°°ì • ìˆœì› ì—…ë°ì´íŠ¸
                        await updateMember(selectedMemberId, { leader_id: selId });
                    } else {
                        // ìƒˆë¡œìš´ ìˆœì› ì¶”ê°€
                        await insertMember({ name: form.name, role: form.role, birthdate: form.birthdate, gender: form.gender, address: form.address, lat: target.lat, lng: target.lng, leader_id: selId });
                    }
                    alert("ì™„ë£Œ");
                    setForm({ name: '', role: 'ì„±ë„', birthdate: '', gender: 'Male', address: '' });
                    setCandidates([]); setTarget(null); setSelId(null); setSelectedMemberId(null);
                    onRefresh?.();  // ì „ì—­ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                } catch (e) { alert(e.message) } finally { setLoading(false) }
            };
            const ic = "block w-full rounded-lg border bg-slate-50 py-2.5 px-3 text-sm";
            const selectLeader = (leader) => { setSelId(leader.id); if (mapInst.current && window.google) { mapInst.current.panTo({ lat: leader.lat, lng: leader.lng }); mapInst.current.setZoom(14); } };
            return (<div className="grid grid-cols-1 xl:grid-cols-12 gap-6 min-h-[600px]"><div className="xl:col-span-5 space-y-6"><div className="bg-white rounded-2xl border"><div className="px-6 py-4 border-b bg-slate-50 flex justify-between items-center"><b>â‘  ì •ë³´ ì…ë ¥</b><button onClick={loadUnassigned} className={`text-xs px-3 py-1.5 rounded-lg border font-medium ${showUnassigned ? 'bg-red-50 text-red-600 border-red-200' : 'bg-amber-50 text-amber-700 border-amber-200 hover:bg-amber-100'}`}>{showUnassigned ? 'âœ• ë‹«ê¸°' : 'ğŸ“‹ ë¯¸ë°°ì • ì¸ì› ì„ íƒ'}</button></div>
                {showUnassigned && <div className="border-b max-h-[200px] overflow-auto">{unassignedList.length === 0 ? <div className="p-4 text-center text-slate-400 text-sm">ë¯¸ë°°ì • ì¸ì› ì—†ìŒ âœ“</div> : unassignedList.map(m => <div key={m.id} onClick={() => selectUnassigned(m)} className={`p-3 border-b hover:bg-amber-50 cursor-pointer flex justify-between items-center ${selectedMemberId === m.id ? 'bg-amber-100' : ''}`}><div><b className="text-sm">{genderIcon(m.gender)} {m.name}</b> <span className="text-xs text-slate-500">{formatRole(m.role)} Â· {calcAge(m.birthdate)}ì„¸</span><div className="text-xs text-slate-400 mt-0.5">{m.address}</div></div><span className="text-xs text-amber-600">ì„ íƒ â†’</span></div>)}</div>}
                <form onSubmit={search} className="p-6 space-y-4"><div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-slate-500">ì´ë¦„</label><input required value={form.name} onChange={e => setForm({ ...form, name: e.target.value })} className={ic} /></div><div><label className="text-xs font-bold text-slate-500">ì§ë¶„</label><input value={form.role} onChange={e => setForm({ ...form, role: e.target.value })} className={ic} /></div></div><div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-slate-500">ìƒë…„ì›”ì¼</label><input type="date" required value={form.birthdate} onChange={e => setForm({ ...form, birthdate: e.target.value })} className={ic} /></div><div><label className="text-xs font-bold text-slate-500">ì„±ë³„</label><select value={form.gender} onChange={e => setForm({ ...form, gender: e.target.value })} className={ic}><option value="Male">ë‚¨ì„±</option><option value="Female">ì—¬ì„±</option></select></div></div><div><label className="text-xs font-bold text-slate-500">ì£¼ì†Œ</label><input required value={form.address} onChange={e => setForm({ ...form, address: e.target.value })} className={ic} /></div><button disabled={loading} className="w-full bg-brand-600 text-white font-bold py-3 rounded-xl">{loading ? 'ê²€ìƒ‰ì¤‘...' : 'ğŸ” ë¦¬ë” ì°¾ê¸°'}</button></form></div>{candidates.length > 0 && <div className="bg-white rounded-2xl border animate-fade-in-up"><div className="px-6 py-4 border-b bg-slate-50 flex justify-between items-center"><b>â‘¡ ì¶”ì²œ ê²°ê³¼</b><span className="text-xs text-slate-400">ìƒìœ„ 5ìˆœìœ„</span></div><div className="p-4 space-y-3 max-h-[400px] overflow-y-auto">{candidates.map((l, i) => <div key={l.id} onClick={() => selectLeader(l)} className={`p-4 rounded-xl border cursor-pointer ${selId === l.id ? 'border-brand-500 bg-brand-50 ring-1 ring-brand-500' : 'border-slate-200 hover:border-brand-300'}`}><div className="flex justify-between"><div><div className="flex items-center gap-2"><span className="w-5 h-5 rounded-full bg-brand-100 text-brand-600 text-xs font-bold flex items-center justify-center">{i + 1}</span><b>{l.name}</b><span className="text-xs text-slate-500">{l.role} Â· {calcAge(l.birthdate)}ì„¸</span></div><div className="text-xs text-slate-500 mt-1 ml-7">{l.address}</div><div className="flex gap-2 mt-2 text-xs ml-7"><span className={`px-2 py-1 rounded ${l.current_members >= l.max_capacity ? 'bg-red-50 text-red-600' : 'bg-slate-100'}`}>{l.current_members}/{l.max_capacity}ëª…</span><span className="px-2 py-1 rounded bg-slate-100">ë‚˜ì´ì°¨ {l.ageDiff}ì‚´</span></div></div><div className="text-right"><span className="text-xl font-black text-brand-600">{l.distance.toFixed(1)}<span className="text-xs text-slate-400">km</span></span>{selId === l.id && <div className="text-brand-600 mt-1">âœ“</div>}</div></div></div>)}</div><div className="p-4 border-t bg-slate-50"><button onClick={assign} disabled={!selId || loading} className="w-full bg-green-600 text-white font-bold py-3 rounded-xl disabled:bg-slate-300">âœ“ ë°°ì •</button></div></div>}</div><div className="xl:col-span-7 rounded-2xl overflow-hidden border sticky top-24 h-[400px] xl:h-auto"><div ref={mapRef} className="w-full h-full bg-slate-100 min-h-[400px]" /></div></div>)
        };

        const Dashboard = ({ globalData, onRefresh }) => {
            const mapRef = useRef(null), mapInst = useRef(null), markers = useRef([]), memberMarkersMap = useRef({}), polylines = useRef([]), allData = useRef({ leaders: [], members: [] });
            const [loading, setLoading] = useState(false), [stats, setStats] = useState({ leaderCount: 0, memberCount: 0, unassignedCount: 0, occupancyRate: 0, ageGroups: {}, genderRatio: { male: 0, female: 0 } });
            const [searchQuery, setSearchQuery] = useState(''), [searchResults, setSearchResults] = useState([]), [showResults, setShowResults] = useState(false);
            // ë¦¬ë” í´ë¦­ ì‹œ ìˆœì› í‘œì‹œìš©
            const [selectedLeader, setSelectedLeader] = useState(null);
            const selectedLeaderRef = useRef(null);  // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ì—ì„œ ìµœì‹ ê°’ ì°¸ì¡°ìš©
            const [leaderMembers, setLeaderMembers] = useState([]);
            const [memberSortBy, setMemberSortBy] = useState('name'); // 'name' | 'age'
            const [editItem, setEditItem] = useState(null);
            const [editType, setEditType] = useState(null);
            const [mapInitialized, setMapInitialized] = useState(false);

            // selectedLeader ë³€ê²½ ì‹œ refë„ ë™ê¸°í™”
            useEffect(() => { selectedLeaderRef.current = selectedLeader; }, [selectedLeader]);

            // í†µì¼ëœ ìˆœì› ê¸°ë³¸ ìƒ‰ìƒ
            const MEMBER_DEFAULT_COLOR = '#14b8a6';
            const MEMBER_UNASSIGNED_COLOR = '#ef4444';
            const HIGHLIGHT_COLOR = '#fbbf24';

            // globalData ë³€ê²½ ì‹œ í†µê³„ ë° ì§€ë„ ì—…ë°ì´íŠ¸
            useEffect(() => {
                if (!globalData?.loaded) return;
                const leaders = globalData.leaders || [];
                const members = globalData.members || [];
                allData.current = { leaders, members };

                const un = members.filter(m => !m.leader_id).length;
                const cap = leaders.reduce((s, l) => s + (l.max_capacity || 0), 0);
                const occ = cap > 0 ? Math.round((members.length - un) / cap * 100) : 0;
                const ag = { '20ëŒ€': 0, '30ëŒ€': 0, '40ëŒ€': 0, '50ëŒ€': 0, '60ëŒ€+': 0 };
                const gr = { male: 0, female: 0 };
                members.forEach(m => {
                    const a = calcAge(m.birthdate);
                    if (a < 30) ag['20ëŒ€']++; else if (a < 40) ag['30ëŒ€']++; else if (a < 50) ag['40ëŒ€']++; else if (a < 60) ag['50ëŒ€']++; else ag['60ëŒ€+']++;
                    const g = String(m.gender || '').toLowerCase();
                    if (g === 'male' || g === 'm' || g === 'ë‚¨' || g === 'ë‚¨ì„±') gr.male++;
                    else if (g === 'female' || g === 'f' || g === 'ì—¬' || g === 'ì—¬ì„±') gr.female++;
                });
                setStats({ leaderCount: leaders.length, memberCount: members.length, unassignedCount: un, occupancyRate: occ, ageGroups: ag, genderRatio: gr });

                // ì§€ë„ ì´ˆê¸°í™”/ì—…ë°ì´íŠ¸
                if (leaders.length > 0 || members.length > 0) {
                    initMap(leaders, members);
                }

                // ì„ íƒëœ ë¦¬ë”ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ìˆœì› ëª©ë¡ ê°±ì‹ 
                if (selectedLeader) {
                    const updatedLeader = leaders.find(l => String(l.id) === String(selectedLeader.id));
                    if (updatedLeader) {
                        setSelectedLeader(updatedLeader);
                        const updatedMembers = members.filter(m => String(m.leader_id) === String(selectedLeader.id));
                        setLeaderMembers(updatedMembers);
                    } else {
                        setSelectedLeader(null);
                        setLeaderMembers([]);
                    }
                }
            }, [globalData]);

            // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ í•¸ë“¤ëŸ¬
            const load = () => {
                setLoading(true);
                onRefresh?.();
                setTimeout(() => setLoading(false), 500);
            };

            // ê²€ìƒ‰ ê¸°ëŠ¥
            const handleSearch = (query) => {
                setSearchQuery(query);
                if (!query.trim()) { setSearchResults([]); setShowResults(false); return; }
                const q = query.toLowerCase();
                const { leaders, members } = allData.current;
                const results = [];
                leaders.forEach(l => { if (l.name?.toLowerCase().includes(q)) results.push({ ...l, type: 'leader' }); });
                members.forEach(m => { if (m.name?.toLowerCase().includes(q)) results.push({ ...m, type: 'member', leaderName: leaders.find(l => l.id === m.leader_id)?.name || 'ë¯¸ë°°ì •' }); });
                setSearchResults(results.slice(0, 10));
                setShowResults(true);
            };

            // ê²€ìƒ‰ ê²°ê³¼ í´ë¦­ ì‹œ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™
            const focusOnResult = (result) => {
                if (!mapInst.current || !result.lat || !result.lng) return;
                mapInst.current.panTo({ lat: result.lat, lng: result.lng });
                mapInst.current.setZoom(15);
                setShowResults(false);
                setSearchQuery('');
                // í•´ë‹¹ ë§ˆì»¤ ì°¾ì•„ì„œ í•˜ì´ë¼ì´íŠ¸
                const marker = markers.current.find(mk => mk.memberData?.id === result.id || mk.leaderData?.id === result.id);
                if (marker) {
                    marker.setAnimation(window.google.maps.Animation.BOUNCE);
                    setTimeout(() => marker.setAnimation(null), 2000);
                }
                // ë¦¬ë”ì¸ ê²½ìš° í•´ë‹¹ ê·¸ë£¹ ìˆœì›ë„ í•˜ì´ë¼ì´íŠ¸
                if (result.type === 'leader') {
                    const groupMembers = memberMarkersMap.current[result.id] || [];
                    groupMembers.forEach(memberMk => {
                        memberMk.setIcon({ path: window.google.maps.SymbolPath.CIRCLE, fillColor: HIGHLIGHT_COLOR, fillOpacity: 1, strokeColor: '#f59e0b', strokeWeight: 3, scale: 10 });
                        memberMk.setZIndex(150);
                    });
                    // ì—°ê²°ì„  ê·¸ë¦¬ê¸°
                    groupMembers.forEach(memberMk => {
                        const line = new window.google.maps.Polyline({
                            path: [{ lat: result.lat, lng: result.lng }, memberMk.getPosition()],
                            geodesic: true, strokeColor: HIGHLIGHT_COLOR, strokeOpacity: 0.8, strokeWeight: 2, map: mapInst.current
                        });
                        polylines.current.push(line);
                    });
                    // 3ì´ˆ í›„ ì›ë˜ëŒ€ë¡œ
                    setTimeout(() => {
                        groupMembers.forEach(memberMk => { memberMk.setIcon(memberMk.originalIcon); memberMk.setZIndex(50); });
                        polylines.current.forEach(p => p.setMap(null)); polylines.current = [];
                    }, 3000);
                }
            };

            // ë¦¬ë” ì„ íƒ ì‹œ ìˆœì› ëª©ë¡ í‘œì‹œ
            const selectLeaderOnMap = async (leader) => {
                setSelectedLeader(leader);
                const members = allData.current.members.filter(m => String(m.leader_id) === String(leader.id));
                setLeaderMembers(members);
                // ì§€ë„ì—ì„œ í•´ë‹¹ ê·¸ë£¹ í•˜ì´ë¼ì´íŠ¸
                if (mapInst.current) {
                    polylines.current.forEach(p => p.setMap(null)); polylines.current = [];
                    markers.current.forEach(mk => { if (mk.originalIcon) mk.setIcon(mk.originalIcon); mk.setZIndex(mk.leaderData ? 100 : 50); });
                    const groupMembers = memberMarkersMap.current[leader.id] || [];
                    groupMembers.forEach(memberMk => {
                        memberMk.setIcon({ path: window.google.maps.SymbolPath.CIRCLE, fillColor: HIGHLIGHT_COLOR, fillOpacity: 1, strokeColor: '#f59e0b', strokeWeight: 3, scale: 10 });
                        memberMk.setZIndex(150);
                    });
                    groupMembers.forEach(memberMk => {
                        const line = new window.google.maps.Polyline({
                            path: [{ lat: leader.lat, lng: leader.lng }, memberMk.getPosition()],
                            geodesic: true, strokeColor: HIGHLIGHT_COLOR, strokeOpacity: 0.8, strokeWeight: 2, map: mapInst.current
                        });
                        polylines.current.push(line);
                    });
                }
            };

            const closeLeaderPanel = () => {
                setSelectedLeader(null);
                setLeaderMembers([]);
                polylines.current.forEach(p => p.setMap(null)); polylines.current = [];
                markers.current.forEach(mk => { if (mk.originalIcon) mk.setIcon(mk.originalIcon); mk.setZIndex(mk.leaderData ? 100 : 50); });
            };

            // ìˆœì› ëª©ë¡ ì¸ì‡„ í•¨ìˆ˜
            const printMemberList = () => {
                if (!selectedLeader || leaderMembers.length === 0) {
                    alert('ì¸ì‡„í•  ìˆœì›ì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const today = new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });

                const printContent = `
                    <div id="print-area" class="print-container">
                        <div class="print-header">
                            <div class="print-title">ğŸ“‹ ${selectedLeader.name} ${formatRole(selectedLeader.role) || ''} ì†Œê·¸ë£¹ ëª…ë‹¨</div>
                            <div class="print-subtitle">${selectedLeader.address || ''} Â· ì •ì› ${selectedLeader.current_members}/${selectedLeader.max_capacity}ëª… Â· ${today}</div>
                        </div>
                        <table class="print-table">
                            <thead>
                                <tr>
                                    <th style="width:8%">ë²ˆí˜¸</th>
                                    <th style="width:15%">ì´ë¦„</th>
                                    <th style="width:12%">ì§ë¶„</th>
                                    <th style="width:10%">ë‚˜ì´</th>
                                    <th style="width:15%">ì—°ë½ì²˜</th>
                                    <th style="width:40%">ì£¼ì†Œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${leaderMembers.map((m, i) => `
                                    <tr>
                                        <td style="text-align:center">${i + 1}</td>
                                        <td><b>${m.name || ''}</b></td>
                                        <td>${formatRole(m.role) || ''}</td>
                                        <td style="text-align:center">${calcAge(m.birthdate)}ì„¸</td>
                                        <td>${m.contact || '-'}</td>
                                        <td style="font-size:12px">${m.address || ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="print-footer">
                            ì†Œê·¸ë£¹ í¸ì„± ë§¤ë‹ˆì € Â· ì¶œë ¥ì¼: ${today}
                        </div>
                    </div>
                `;

                // ì¸ì‡„ ì°½ ìƒì„±
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${selectedLeader.name} ì†Œê·¸ë£¹ ëª…ë‹¨</title>
                        <style>
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif; }
                            .print-container { max-width: 210mm; margin: 0 auto; padding: 15mm; background: white; }
                            .print-header { border-bottom: 2px solid #1e40af; padding-bottom: 12px; margin-bottom: 20px; }
                            .print-title { font-size: 24px; font-weight: bold; color: #1e40af; }
                            .print-subtitle { font-size: 14px; color: #64748b; margin-top: 4px; }
                            .print-table { width: 100%; border-collapse: collapse; }
                            .print-table th { background: #f1f5f9; padding: 10px 8px; text-align: left; font-size: 12px; font-weight: bold; border-bottom: 2px solid #e2e8f0; }
                            .print-table td { padding: 10px 8px; border-bottom: 1px solid #e2e8f0; font-size: 13px; }
                            .print-table tr:nth-child(even) { background: #f8fafc; }
                            .print-footer { margin-top: 30px; text-align: center; font-size: 11px; color: #94a3b8; }
                            @media print { @page { size: A4; margin: 10mm; } }
                        </style>
                    </head>
                    <body>${printContent}</body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => { printWindow.print(); }, 300);
            };

            const openEditMember = (member) => { setEditItem(member); setEditType('member'); };
            const openEditLeader = () => { if (selectedLeader) { setEditItem(selectedLeader); setEditType('leader'); } };

            const handleDelete = async (member) => {
                if (!confirm(`${member.name}ë‹˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                await removeMember(member.id, selectedLeader?.id, 'DELETE');
                await load();
            };

            const handleUnassign = async (member) => {
                if (!confirm(`${member.name}ë‹˜ì„ ê·¸ë£¹ì—ì„œ ì œì™¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                await removeMember(member.id, selectedLeader?.id, 'UNASSIGN');
                await load();
            };

            const onEditUpdate = async () => {
                await load();
            };

            const initMap = (leaders, members) => {
                if (!mapRef.current || !window.google) return;
                if (!mapInst.current) mapInst.current = new window.google.maps.Map(mapRef.current, { center: { lat: 36.5, lng: 127.8 }, zoom: 7, disableDefaultUI: true, zoomControl: true, styles: MAP_STYLES });
                markers.current.forEach(m => m.setMap(null)); markers.current = [];
                polylines.current.forEach(p => p.setMap(null)); polylines.current = [];
                memberMarkersMap.current = {};
                const bounds = new window.google.maps.LatLngBounds();

                // ìˆœì› ë§ˆì»¤ ìƒì„± (í†µì¼ëœ ìƒ‰ìƒ)
                members.forEach(m => {
                    if (m.lat && m.lng) {
                        const un = !m.leader_id;
                        const leaderName = un ? 'ë¯¸ë°°ì •' : (leaders.find(l => l.id === m.leader_id)?.name || 'ì•Œìˆ˜ì—†ìŒ');
                        const memberColor = un ? MEMBER_UNASSIGNED_COLOR : MEMBER_DEFAULT_COLOR;
                        const mk = new window.google.maps.Marker({
                            position: { lat: m.lat, lng: m.lng },
                            map: mapInst.current,
                            icon: { path: window.google.maps.SymbolPath.CIRCLE, fillColor: memberColor, fillOpacity: 0.9, strokeColor: '#fff', strokeWeight: 2, scale: un ? 8 : 7 },
                            zIndex: 50
                        });
                        mk.originalIcon = { path: window.google.maps.SymbolPath.CIRCLE, fillColor: memberColor, fillOpacity: 0.9, strokeColor: '#fff', strokeWeight: 2, scale: un ? 8 : 7 };
                        mk.memberData = m;
                        const info = new window.google.maps.InfoWindow({ content: `<div style="padding:8px;font-family:sans-serif;min-width:150px"><div style="font-size:13px;font-weight:bold;color:#334155">${m.name}</div><div style="font-size:11px;color:#64748b">${m.role} Â· ${calcAge(m.birthdate)}ì„¸</div><div style="font-size:10px;color:#94a3b8;margin-top:4px">${m.address}</div><div style="margin-top:6px;font-size:11px;padding:3px 6px;border-radius:4px;display:inline-block;${un ? 'background:#fee2e2;color:#dc2626' : 'background:#ccfbf1;color:#0d9488'}">ë¦¬ë”: ${leaderName}</div></div>` });
                        mk.addListener('mouseover', () => info.open(mapInst.current, mk));
                        mk.addListener('mouseout', () => info.close());
                        // ìˆœì› í´ë¦­ ì‹œ í•´ë‹¹ ë¦¬ë” ê·¸ë£¹ í‘œì‹œ
                        mk.addListener('click', () => {
                            if (m.leader_id) {
                                const leader = leaders.find(l => l.id === m.leader_id);
                                if (leader) selectLeaderOnMap(leader);
                            }
                        });
                        markers.current.push(mk);
                        if (m.leader_id) {
                            if (!memberMarkersMap.current[m.leader_id]) memberMarkersMap.current[m.leader_id] = [];
                            memberMarkersMap.current[m.leader_id].push(mk);
                        }
                        bounds.extend({ lat: m.lat, lng: m.lng });
                    }
                });

                // ë¦¬ë” ë§ˆì»¤ ìƒì„± (ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ìˆœì› í•˜ì´ë¼ì´íŠ¸)
                leaders.forEach(l => {
                    if (l.lat && l.lng) {
                        const full = l.current_members >= l.max_capacity;
                        const mk = new window.google.maps.Marker({
                            position: { lat: l.lat, lng: l.lng },
                            map: mapInst.current,
                            icon: { path: window.google.maps.SymbolPath.CIRCLE, fillColor: full ? '#94a3b8' : '#3b82f6', fillOpacity: 1, strokeColor: '#fff', strokeWeight: 3, scale: 14 },
                            label: { text: String(l.current_members), color: '#fff', fontSize: '11px', fontWeight: 'bold' },
                            zIndex: 100
                        });
                        mk.leaderData = l;
                        const info = new window.google.maps.InfoWindow({ content: `<div style="padding:10px;font-family:sans-serif;min-width:180px"><div style="font-size:15px;font-weight:bold;color:#1e40af;margin-bottom:4px">ğŸ‘¤ ${l.name} ${l.role}</div><div style="font-size:12px;color:#64748b">${calcAge(l.birthdate)}ì„¸ Â· ${l.gender === 'Male' ? 'ë‚¨ì„±' : 'ì—¬ì„±'}</div><div style="font-size:11px;color:#94a3b8;margin:6px 0;padding-top:6px;border-top:1px solid #e2e8f0">${l.address}</div><div style="font-size:12px;padding:4px 8px;border-radius:4px;display:inline-block;${full ? 'background:#fee2e2;color:#dc2626' : 'background:#dcfce7;color:#16a34a'};font-weight:600">ì •ì›: ${l.current_members}/${l.max_capacity}ëª…</div><div style="margin-top:6px;font-size:11px;color:#6366f1">ğŸ“Œ í´ë¦­í•˜ì—¬ ìˆœì› ë³´ê¸°</div></div>` });

                        // Hover: InfoWindowë§Œ í‘œì‹œ (ê¹œë¹¡ì„ ë°©ì§€)
                        mk.addListener('mouseover', () => info.open(mapInst.current, mk));
                        mk.addListener('mouseout', () => info.close());

                        // Click: ì „ì²´ íš¨ê³¼ (í•˜ì´ë¼ì´íŠ¸ + ì—°ê²°ì„  + íŒ¨ë„)
                        mk.addListener('click', () => selectLeaderOnMap(l));

                        markers.current.push(mk);
                        bounds.extend({ lat: l.lat, lng: l.lng });
                    }
                });

                if (leaders.length || members.length) { mapInst.current.fitBounds(bounds); window.google.maps.event.addListenerOnce(mapInst.current, 'idle', () => { if (mapInst.current.getZoom() > 14) mapInst.current.setZoom(14) }); }
            };


            const maxA = Math.max(...Object.values(stats.ageGroups), 1);

            return (<div className="space-y-6 pb-8">
                {/* í†µí•© í†µê³„ ë°” */}
                <div className="bg-white rounded-2xl border p-4">
                    <div className="flex flex-wrap items-center justify-between gap-4">
                        <div className="flex items-center gap-8">
                            <div className="text-center">
                                <p className="text-xs text-slate-500">ìˆœì›</p>
                                <p className="text-2xl font-black">{stats.memberCount}</p>
                            </div>
                            <div className="text-center">
                                <p className={`text-xs ${stats.unassignedCount > 0 ? 'text-red-500' : 'text-slate-500'}`}>ë¯¸ë°°ì •</p>
                                <p className={`text-2xl font-black ${stats.unassignedCount > 0 ? 'text-red-600' : ''}`}>{stats.unassignedCount}</p>
                            </div>
                            <div className="text-center">
                                <p className="text-xs text-slate-500">ë¦¬ë”</p>
                                <p className="text-2xl font-black">{stats.leaderCount}</p>
                            </div>
                            <div className="text-center">
                                <p className="text-xs text-slate-500">ìˆ˜ìš©ë¥ </p>
                                <div className="flex items-center gap-2">
                                    <p className="text-2xl font-black">{stats.occupancyRate}%</p>
                                    <div className="w-16 bg-slate-100 h-2 rounded-full"><div className="h-full bg-green-500 rounded-full" style={{ width: `${Math.min(stats.occupancyRate, 100)}%` }} /></div>
                                </div>
                            </div>
                        </div>
                        <div className="h-8 w-px bg-slate-200 hidden md:block" />
                        <div className="flex items-center gap-6">
                            <div className="flex items-center gap-2">
                                <div className="relative w-10 h-10">
                                    <svg viewBox="0 0 36 36" className="w-full h-full -rotate-90">
                                        <circle cx="18" cy="18" r="15" fill="none" stroke="#e2e8f0" strokeWidth="4" />
                                        <circle cx="18" cy="18" r="15" fill="none" stroke="#3b82f6" strokeWidth="4" strokeDasharray={`${stats.genderRatio.male / (stats.genderRatio.male + stats.genderRatio.female || 1) * 94} 94`} strokeLinecap="round" />
                                        <circle cx="18" cy="18" r="15" fill="none" stroke="#ec4899" strokeWidth="4" strokeDasharray={`${stats.genderRatio.female / (stats.genderRatio.male + stats.genderRatio.female || 1) * 94} 94`} strokeDashoffset={`-${stats.genderRatio.male / (stats.genderRatio.male + stats.genderRatio.female || 1) * 94}`} strokeLinecap="round" />
                                    </svg>
                                </div>
                                <div className="text-xs">
                                    <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-blue-500"></span>ë‚¨ {stats.genderRatio.male}ëª…</div>
                                    <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-pink-500"></span>ì—¬ {stats.genderRatio.female}ëª…</div>
                                </div>
                            </div>
                            <div className="text-xs space-y-0.5">
                                {Object.entries(stats.ageGroups).map(([k, v]) => <div key={k} className="flex items-center gap-2"><span className="w-10 text-slate-500">{k}</span><div className="w-16 bg-slate-100 rounded-full h-1.5"><div className="h-full bg-brand-500 rounded-full" style={{ width: `${v / maxA * 100}%` }} /></div><span className="w-8 text-right font-bold">{v}</span></div>)}
                            </div>
                        </div>
                    </div>
                </div>
                {/* ì§€ë„ (ì „ì²´ ë„ˆë¹„) */}
                <div className="bg-white rounded-2xl border overflow-hidden flex flex-col h-[550px]">
                    <div className="px-5 py-3 border-b bg-slate-50 flex justify-between items-center gap-4">
                        <div className="flex items-center gap-4">
                            <b>ì§€ë„</b>
                            <div className="flex items-center gap-3 text-xs text-slate-500">
                                <span className="flex items-center gap-1"><span className="w-2.5 h-2.5 rounded-full bg-blue-500"></span>ë¦¬ë”</span>
                                <span className="flex items-center gap-1"><span className="w-2.5 h-2.5 rounded-full bg-teal-500"></span>ë°°ì •</span>
                                <span className="flex items-center gap-1"><span className="w-2.5 h-2.5 rounded-full bg-red-500"></span>ë¯¸ë°°ì •</span>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className="flex-1 max-w-xs relative">
                                <input
                                    type="text"
                                    value={searchQuery}
                                    onChange={e => handleSearch(e.target.value)}
                                    onFocus={() => searchResults.length > 0 && setShowResults(true)}
                                    placeholder="ğŸ” ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰..."
                                    className="w-full text-sm border rounded-lg px-3 py-1.5 bg-white"
                                />
                                {showResults && searchResults.length > 0 && (
                                    <div className="absolute top-full left-0 right-0 mt-1 bg-white border rounded-lg shadow-lg z-50 max-h-64 overflow-auto">
                                        {searchResults.map((r, i) => (
                                            <div key={i} onClick={() => focusOnResult(r)} className="px-3 py-2 hover:bg-slate-50 cursor-pointer border-b last:border-b-0">
                                                <div className="flex items-center gap-2">
                                                    <span className={`text-xs px-1.5 py-0.5 rounded ${r.type === 'leader' ? 'bg-blue-100 text-blue-700' : 'bg-teal-100 text-teal-700'}`}>{r.type === 'leader' ? 'ë¦¬ë”' : 'ìˆœì›'}</span>
                                                    <b className="text-sm">{r.name}</b>
                                                    <span className="text-xs text-slate-500">{r.role} Â· {calcAge(r.birthdate)}ì„¸</span>
                                                </div>
                                                {r.type === 'member' && <div className="text-xs text-slate-400 mt-1">ì†Œì†: {r.leaderName}</div>}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            <button onClick={load} className="text-xs bg-white border px-3 py-1.5 rounded-lg shrink-0 hover:bg-slate-50">ìƒˆë¡œê³ ì¹¨</button>
                        </div>
                    </div>
                    <div className="flex-1 relative">
                        {loading && <div className="absolute inset-0 z-20 bg-white/80 flex items-center justify-center"><div className="w-8 h-8 border-4 border-brand-200 border-t-brand-600 rounded-full animate-spin" /></div>}
                        <div ref={mapRef} className="w-full h-full bg-slate-100" />
                    </div>
                </div>
                {/* ì„ íƒëœ ë¦¬ë”ì˜ ìˆœì› ëª©ë¡ - ì§€ë„ ì•„ë˜ ë³„ë„ ì„¹ì…˜ */}
                {selectedLeader && (
                    <div className="bg-white rounded-2xl border animate-fade-in-up">
                        <div className="px-5 py-4 border-b bg-slate-50 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="w-12 h-12 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center font-bold text-lg">{selectedLeader.current_members}</div>
                                <div>
                                    <div className="font-bold text-lg">{selectedLeader.name} <span className="text-sm font-normal text-slate-500">{selectedLeader.role}</span></div>
                                    <div className="text-sm text-slate-500">{calcAge(selectedLeader.birthdate)}ì„¸ Â· {selectedLeader.address}</div>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <div className="flex bg-slate-100 p-0.5 rounded text-xs">
                                    <button onClick={() => setMemberSortBy('name')} className={`px-2 py-1 rounded ${memberSortBy === 'name' ? 'bg-white text-brand-600 font-bold' : 'text-slate-500'}`}>ì´ë¦„ìˆœ</button>
                                    <button onClick={() => setMemberSortBy('age')} className={`px-2 py-1 rounded ${memberSortBy === 'age' ? 'bg-white text-brand-600 font-bold' : 'text-slate-500'}`}>ë‚˜ì´ìˆœ</button>
                                </div>
                                <button onClick={printMemberList} className="text-xs bg-blue-100 text-blue-700 px-3 py-1.5 rounded-lg hover:bg-blue-200">ğŸ–¨ï¸ ì¸ì‡„</button>
                                <button onClick={openEditLeader} className="text-xs bg-slate-100 px-3 py-1.5 rounded-lg hover:bg-slate-200">âœï¸ ë¦¬ë” ìˆ˜ì •</button>
                                <button onClick={closeLeaderPanel} className="text-slate-400 hover:text-slate-600 text-xl ml-2">âœ•</button>
                            </div>
                        </div>
                        <div className="p-4">
                            {leaderMembers.length === 0 ? (
                                <div className="text-center text-slate-400 py-8">ì†Œì† ìˆœì›ì´ ì—†ìŠµë‹ˆë‹¤</div>
                            ) : (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    {[...leaderMembers].sort((a, b) => memberSortBy === 'age' ? calcAge(b.birthdate) - calcAge(a.birthdate) : (a.name || '').localeCompare(b.name || '', 'ko')).map(m => (
                                        <div key={m.id} className="flex justify-between items-center p-3 bg-slate-50 rounded-xl hover:bg-slate-100">
                                            <div>
                                                <b>{genderIcon(m.gender)} {m.name}</b> <span className="text-xs text-slate-500">{formatRole(m.role)} Â· {calcAge(m.birthdate)}ì„¸ ({formatBirthdate(m.birthdate)})</span>
                                                {m.contact && <span className="text-xs text-slate-400 ml-2">ğŸ“ {m.contact}</span>}
                                                <div className="text-xs text-slate-400 mt-0.5">{m.address}</div>
                                            </div>
                                            <div className="flex gap-2 shrink-0">
                                                <button onClick={() => openEditMember(m)} className="text-xs bg-white border px-2 py-1 rounded hover:bg-slate-50">âœï¸ ìˆ˜ì •</button>
                                                <button onClick={() => handleUnassign(m)} className="text-xs text-amber-600 hover:text-amber-800 px-2">ì œì™¸</button>
                                                <button onClick={() => handleDelete(m)} className="text-xs text-red-600 hover:text-red-800 px-2">ì‚­ì œ</button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                )}
                {editItem && <EditModal item={editItem} type={editType} leaders={allData.current.leaders} onClose={() => { setEditItem(null); setEditType(null); }} onUpdate={onEditUpdate} />}
            </div>)
        };

        const App = () => {
            const [tab, setTab] = useState('MATCH'), [mapsLoaded, setMapsLoaded] = useState(false), [conn, setConn] = useState(false), [check, setCheck] = useState(true);
            // ì „ì—­ ë°ì´í„° ìƒíƒœ (í•œ ë²ˆë§Œ ë¡œë“œ)
            const [globalData, setGlobalData] = useState({ leaders: [], members: [], loaded: false, loading: false });

            const loadGlobalData = async () => {
                if (globalData.loading) return;
                setGlobalData(prev => ({ ...prev, loading: true }));
                try {
                    const { leaders, members } = await fetchFullData();
                    setGlobalData({ leaders, members, loaded: true, loading: false });
                } catch (err) {
                    console.error('ì „ì—­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', err);
                    setGlobalData(prev => ({ ...prev, loading: false }));
                }
            };

            const refreshGlobalData = async () => {
                setGlobalData(prev => ({ ...prev, loading: true }));
                try {
                    const { leaders, members } = await fetchFullData();
                    setGlobalData({ leaders, members, loaded: true, loading: false });
                } catch (err) {
                    console.error('ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', err);
                    setGlobalData(prev => ({ ...prev, loading: false }));
                }
            };

            const handleTabChange = (newTab) => { setTab(newTab); window.scrollTo(0, 0); };

            useEffect(() => {
                const checkAndLoad = async () => {
                    const storedUrl = localStorage.getItem(SHEET_API_URL_KEY);
                    const storedKey = localStorage.getItem(MAPS_API_KEY_STORAGE);

                    if (storedUrl && storedKey) {
                        setConn(true);
                        loadMaps(storedKey);
                    }
                    setCheck(false);
                };
                checkAndLoad();
            }, []);

            const loadMaps = (key) => {
                if (document.getElementById('gm')) return;
                const s = document.createElement('script');
                s.id = 'gm';
                s.src = `https://maps.googleapis.com/maps/api/js?key=${key}&libraries=places`;
                s.async = true;
                s.onload = () => setTimeout(() => setMapsLoaded(true), 100);
                s.onerror = () => { alert("Google Maps ë¡œë“œ ì‹¤íŒ¨. API Keyë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."); setMapsLoaded(false); };
                document.head.appendChild(s);
            };

            // ì—°ê²° í›„ ìµœì´ˆ 1íšŒ ë°ì´í„° ë¡œë“œ
            useEffect(() => {
                if (conn && mapsLoaded && !globalData.loaded && !globalData.loading) {
                    loadGlobalData();
                }
            }, [conn, mapsLoaded, globalData.loaded, globalData.loading]);

            const disconnect = () => { if (confirm("ì—°ê²° í•´ì œ?")) { localStorage.removeItem(SHEET_API_URL_KEY); localStorage.removeItem(MAPS_API_KEY_STORAGE); setConn(false); setGlobalData({ leaders: [], members: [], loaded: false, loading: false }); } };

            if (check) return null;
            if (!conn) return <SetupScreen onComplete={(key) => { setConn(true); loadMaps(key); }} />;

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col">
                    <header className="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2.5 cursor-pointer" onClick={disconnect}>
                                <div className="bg-green-600 p-1.5 rounded-lg text-white">ğŸ“‹</div>
                                <div>
                                    <b>ì†Œê·¸ë£¹ í¸ì„±</b>
                                    <p className="text-[10px] text-green-600 flex items-center gap-1">
                                        <span className="w-1.5 h-1.5 rounded-full bg-green-500" />ì—°ê²°ë¨
                                    </p>
                                </div>
                            </div>
                            <nav className="flex bg-slate-100/80 p-1 rounded-xl">
                                <button onClick={() => handleTabChange('MATCH')} className={`px-4 py-1.5 rounded-lg text-sm font-semibold ${tab === 'MATCH' ? 'bg-white text-brand-600' : 'text-slate-500'}`}>ë°°ì •</button>
                                <button onClick={() => handleTabChange('UPLOAD')} className={`px-4 py-1.5 rounded-lg text-sm font-semibold ${tab === 'UPLOAD' ? 'bg-white text-brand-600' : 'text-slate-500'}`}>ê´€ë¦¬</button>
                                <button onClick={() => handleTabChange('DASHBOARD')} className={`px-4 py-1.5 rounded-lg text-sm font-semibold ${tab === 'DASHBOARD' ? 'bg-white text-brand-600' : 'text-slate-500'}`}>í˜„í™©</button>
                            </nav>
                        </div>
                    </header>
                    <main className="flex-1 max-w-7xl mx-auto w-full p-6">
                        {!mapsLoaded ? (
                            <div className="flex flex-col items-center justify-center h-[60vh] text-slate-400">
                                <div className="w-12 h-12 border-4 border-brand-100 border-t-brand-600 rounded-full animate-spin mb-4" />
                                ì§€ë„ ë¡œë”©ì¤‘...
                            </div>
                        ) : globalData.loading && !globalData.loaded ? (
                            <div className="flex flex-col items-center justify-center h-[60vh] text-slate-400">
                                <div className="w-12 h-12 border-4 border-brand-100 border-t-brand-600 rounded-full animate-spin mb-4" />
                                ë°ì´í„° ë¡œë”©ì¤‘...
                            </div>
                        ) : (
                            <div className="animate-fade-in-up">
                                {tab === 'MATCH' && <MemberMatching globalData={globalData} onRefresh={refreshGlobalData} />}
                                {tab === 'UPLOAD' && <LeaderUpload globalData={globalData} onRefresh={refreshGlobalData} />}
                                {tab === 'DASHBOARD' && <Dashboard globalData={globalData} onRefresh={refreshGlobalData} />}
                            </div>
                        )}
                    </main>
                    <footer className="border-t bg-white py-6 text-center text-xs text-slate-400">
                        Â© {new Date().getFullYear()} Church Small Group Manager
                    </footer>
                </div>
            );
        };
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>