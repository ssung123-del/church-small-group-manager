<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†Œê·¸ë£¹ í¸ì„± ë§¤ë‹ˆì €</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { theme: { extend: { colors: { brand: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' } } } } }</script>
    <style>
        @keyframes fade-in {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(10px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .animate-fade-in {
            animation: fade-in .3s ease-out
        }

        .animate-fade-in-up {
            animation: fade-in-up .4s ease-out
        }

        @media print {
            body * {
                visibility: hidden
            }

            #print-area,
            #print-area * {
                visibility: visible
            }

            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: #fff
            }

            .no-print {
                display: none !important
            }
        }

        .print-container {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 210mm;
            margin: 0 auto;
            padding: 15mm;
            background: #fff
        }

        .print-header {
            border-bottom: 2px solid #1e40af;
            padding-bottom: 12px;
            margin-bottom: 20px
        }

        .print-title {
            font-size: 24px;
            font-weight: bold;
            color: #1e40af
        }

        .print-subtitle {
            font-size: 14px;
            color: #64748b;
            margin-top: 4px
        }

        .print-table {
            width: 100%;
            border-collapse: collapse
        }

        .print-table th {
            background: #f1f5f9;
            padding: 10px 8px;
            text-align: left;
            font-size: 12px;
            font-weight: bold;
            border-bottom: 2px solid #e2e8f0
        }

        .print-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 13px
        }

        .print-table tr:nth-child(even) {
            background: #f8fafc
        }

        .print-footer {
            margin-top: 30px;
            text-align: center;
            font-size: 11px;
            color: #94a3b8
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const FIREBASE_CONFIG_KEY = 'CHURCH_GROUP_FIREBASE_CONFIG', BACKEND_MODE_KEY = 'CHURCH_GROUP_BACKEND_MODE', MAPS_API_KEY_STORAGE = 'CHURCH_GROUP_MAPS_API_KEY', GEOCODE_DELAY_MS = 250;

        // ë¯¸ë‹ˆë©€ ê·¸ë ˆì´ìŠ¤ì¼€ì¼ ë§µ ìŠ¤íƒ€ì¼
        const MAP_STYLES = [
            { elementType: "geometry", stylers: [{ color: "#f8fafc" }] },
            { elementType: "labels.icon", stylers: [{ visibility: "off" }] },
            { elementType: "labels.text.fill", stylers: [{ color: "#64748b" }] },
            { elementType: "labels.text.stroke", stylers: [{ color: "#f8fafc" }] },
            { featureType: "poi", stylers: [{ visibility: "off" }] },
            { featureType: "road", elementType: "geometry", stylers: [{ color: "#ffffff" }] },
            { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#e2e8f0" }] },
            { featureType: "transit", stylers: [{ visibility: "off" }] },
            { featureType: "water", elementType: "geometry", stylers: [{ color: "#e2e8f0" }] }
        ];

        let firebaseDb = null;
        const getStoredValue = key => sessionStorage.getItem(key) || localStorage.getItem(key);
        const setStoredValue = (key, value, persist = true) => {
            if (persist) {
                localStorage.setItem(key, value);
                sessionStorage.removeItem(key);
            } else {
                sessionStorage.setItem(key, value);
                localStorage.removeItem(key);
            }
        };
        const clearStoredValue = key => {
            localStorage.removeItem(key);
            sessionStorage.removeItem(key);
        };

        const sleep = ms => new Promise(r => setTimeout(r, ms)),
            getMapsApiKey = () => getStoredValue(MAPS_API_KEY_STORAGE),
            getFirebaseConfigRaw = () => getStoredValue(FIREBASE_CONFIG_KEY),
            getBackendMode = () => getStoredValue(BACKEND_MODE_KEY) || 'firebase';
        const parseFirebaseConfig = raw => {
            if (!raw) throw new Error("Firebase ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.");
            try { return JSON.parse(raw); } catch { throw new Error("Firebase ì„¤ì • JSON í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤."); }
        };
        const ensureFirebaseDb = (configRaw = null) => {
            if (firebaseDb) return firebaseDb;
            if (!window.firebase) throw new Error("Firebase SDK ë¡œë”© ì‹¤íŒ¨");
            const cfg = parseFirebaseConfig(configRaw || getFirebaseConfigRaw());
            const app = window.firebase.apps?.length ? window.firebase.app() : window.firebase.initializeApp(cfg);
            firebaseDb = app.firestore();
            return firebaseDb;
        };
        const newNumericId = () => Date.now() + Math.floor(Math.random() * 100000);
        const docToItem = doc => {
            const data = doc.data() || {};
            const fallbackId = Number.isFinite(Number(doc.id)) ? Number(doc.id) : doc.id;
            return { ...data, id: data.id ?? fallbackId };
        };
        const recalcLeaderCount = async (db, leaderId) => {
            if (leaderId === undefined || leaderId === null || String(leaderId) === '') return;
            const membersSnapshot = await db.collection('members').get();
            let count = 0;
            membersSnapshot.forEach(d => { if (String(d.data()?.leader_id || '') === String(leaderId)) count++; });
            await db.collection('leaders').doc(String(leaderId)).set({ current_members: count }, { merge: true });
        };
        const refreshAllLeaderCounts = async () => {
            const db = ensureFirebaseDb();
            const membersSnapshot = await db.collection('members').get();
            const countMap = {};
            membersSnapshot.forEach(doc => {
                const row = doc.data() || {};
                const key = String(row.leader_id || '');
                if (!key) return;
                countMap[key] = (countMap[key] || 0) + 1;
            });
            const leadersSnapshot = await db.collection('leaders').get();
            const batch = db.batch();
            leadersSnapshot.forEach(doc => {
                const leaderId = String(doc.data()?.id ?? doc.id);
                batch.set(doc.ref, { current_members: countMap[leaderId] || 0 }, { merge: true });
            });
            await batch.commit();
        };
        const firebaseRequest = async (action, payload = {}) => {
            const db = ensureFirebaseDb();
            if (action === 'PING') return 'PONG';
            if (action === 'GET_LEADERS') {
                const leadersSnap = await db.collection('leaders').get();
                return leadersSnap.docs.map(docToItem);
            }
            if (action === 'ADD_LEADER') {
                const id = payload.leader?.id || newNumericId();
                const leader = { ...payload.leader, id, max_capacity: Number(payload.leader?.max_capacity || 10), current_members: Number(payload.leader?.current_members || 0) };
                await db.collection('leaders').doc(String(id)).set(leader);
                return "OK";
            }
            if (action === 'DELETE_LEADER') {
                const id = payload.id;
                const membersSnap = await db.collection('members').get();
                const batch = db.batch();
                membersSnap.forEach(doc => {
                    const row = doc.data() || {};
                    if (String(row.leader_id || '') === String(id)) batch.set(doc.ref, { leader_id: '' }, { merge: true });
                });
                batch.delete(db.collection('leaders').doc(String(id)));
                await batch.commit();
                return "OK";
            }
            if (action === 'UPDATE_LEADER') {
                await db.collection('leaders').doc(String(payload.id)).set(payload.updates || {}, { merge: true });
                return "OK";
            }
            if (action === 'ADD_MEMBER') {
                const id = payload.member?.id || newNumericId();
                const member = { ...payload.member, id, leader_id: payload.member?.leader_id || '', status: payload.member?.status || 'wants_group' };
                await db.collection('members').doc(String(id)).set(member);
                if (member.leader_id) await recalcLeaderCount(db, member.leader_id);
                return "OK";
            }
            if (action === 'UPDATE_MEMBER') {
                const ref = db.collection('members').doc(String(payload.id));
                const oldSnap = await ref.get();
                const oldRow = oldSnap.exists ? (oldSnap.data() || {}) : {};
                await ref.set(payload.updates || {}, { merge: true });
                const oldLeaderId = oldRow.leader_id || '';
                const newLeaderId = payload.updates?.leader_id !== undefined ? payload.updates.leader_id : oldLeaderId;
                if (String(oldLeaderId) !== String(newLeaderId)) {
                    if (oldLeaderId) await recalcLeaderCount(db, oldLeaderId);
                    if (newLeaderId) await recalcLeaderCount(db, newLeaderId);
                }
                return "OK";
            }
            if (action === 'GET_MEMBERS_BY_LEADER') {
                const membersSnap = await db.collection('members').get();
                return membersSnap.docs.map(docToItem).filter(m => String(m.leader_id || '') === String(payload.leaderId || ''));
            }
            if (action === 'GET_ALL_MEMBERS') {
                const membersSnap = await db.collection('members').get();
                return membersSnap.docs.map(docToItem);
            }
            if (action === 'REMOVE_MEMBER') {
                const memberRef = db.collection('members').doc(String(payload.memberId));
                const memberSnap = await memberRef.get();
                const old = memberSnap.exists ? (memberSnap.data() || {}) : {};
                if (payload.mode === 'DELETE') await memberRef.delete();
                else await memberRef.set({ leader_id: '' }, { merge: true });
                const oldLeader = old.leader_id || payload.leaderId || '';
                if (oldLeader) await recalcLeaderCount(db, oldLeader);
                return "OK";
            }
            throw new Error(`ì§€ì›í•˜ì§€ ì•ŠëŠ” ì•¡ì…˜: ${action}`);
        };
        const request = async (action, payload = {}) => {
            if (getBackendMode() !== 'firebase') throw new Error("ì§€ì›ë˜ì§€ ì•ŠëŠ” ë°±ì—”ë“œ ëª¨ë“œì…ë‹ˆë‹¤. Firebaseë¡œ ë‹¤ì‹œ ì—°ê²°í•˜ì„¸ìš”.");
            return await firebaseRequest(action, payload);
        };
        const fetchLeaders = async () => await request('GET_LEADERS'),
            insertLeader = async l => await request('ADD_LEADER', { leader: l }),
            deleteLeader = async id => await request('DELETE_LEADER', { id }),
            updateLeader = async (id, updates) => await request('UPDATE_LEADER', { id, updates }),
            insertMember = async m => await request('ADD_MEMBER', { member: m }),
            updateMember = async (id, updates) => await request('UPDATE_MEMBER', { id, updates }),
            fetchMembersByLeader = async id => await request('GET_MEMBERS_BY_LEADER', { leaderId: id }),
            fetchFullData = async () => ({ leaders: await request('GET_LEADERS'), members: await request('GET_ALL_MEMBERS') }),
            removeMember = async (mid, lid, mode) => await request('REMOVE_MEMBER', { memberId: mid, leaderId: lid, mode }),
            checkConnection = async (configRaw) => { try { ensureFirebaseDb(configRaw); await request('PING'); return true } catch { return false } };
        const bulkInsert = async (collectionName, rows) => {
            if (!rows.length) return;
            const db = ensureFirebaseDb();
            for (let i = 0; i < rows.length; i += 400) {
                const chunk = rows.slice(i, i + 400);
                const batch = db.batch();
                chunk.forEach(row => {
                    const id = row.id || newNumericId();
                    const payload = { ...row, id };
                    batch.set(db.collection(collectionName).doc(String(id)), payload);
                });
                await batch.commit();
            }
        };
        const geocodeAddress = async addr => { if (!window.google?.maps) throw new Error("Maps not loaded"); return new Promise((res, rej) => { new window.google.maps.Geocoder().geocode({ address: addr }, (r, s) => { if (s === 'OK' && r[0]) res({ lat: r[0].geometry.location.lat(), lng: r[0].geometry.location.lng(), formattedAddress: r[0].formatted_address }); else rej(new Error(`Geocode: ${s}`)) }) }) };
        const calcDist = (a, b, c, d) => { const R = 6371, dLat = (c - a) * Math.PI / 180, dLng = (d - b) * Math.PI / 180, x = Math.sin(dLat / 2) ** 2 + Math.cos(a * Math.PI / 180) * Math.cos(c * Math.PI / 180) * Math.sin(dLng / 2) ** 2; return R * 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1 - x)) };
        // ìƒë…„ì›”ì¼ì—ì„œ ë‚˜ì´ ê³„ì‚° (ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›)
        const calcAge = (birthdate) => {
            if (!birthdate) return 0;
            let bd;
            // ìˆ«ì ì‹œë¦¬ì–¼ í˜•ì‹ (Google Sheets ë‚ ì§œ)
            if (typeof birthdate === 'number') {
                // Excel/Sheets ë‚ ì§œ ì‹œë¦¬ì–¼: 1900-01-01ì„ 1ë¡œ ì‹œì‘
                bd = new Date((birthdate - 25569) * 86400 * 1000);
            } else if (birthdate instanceof Date) {
                bd = birthdate;
            } else {
                const str = String(birthdate).trim();
                // ISO íƒ€ì„ìŠ¤íƒ¬í”„ì—ì„œ ë‚ ì§œ ë¶€ë¶„ë§Œ ì¶”ì¶œ
                if (str.includes('T')) {
                    bd = new Date(str.split('T')[0]);
                } else if (str.includes('.') || str.includes('/') || str.includes('-')) {
                    // YYYY.MM.DD, YYYY/MM/DD, YYYY-MM-DD í˜•ì‹ ìˆ˜ë™ íŒŒì‹±
                    const parts = str.split(/[.\/-]/);
                    if (parts.length >= 3) {
                        const year = parseInt(parts[0]);
                        const month = parseInt(parts[1]) - 1; // ì›”ì€ 0ë¶€í„° ì‹œì‘
                        const day = parseInt(parts[2]);
                        if (!isNaN(year) && !isNaN(month) && !isNaN(day)) {
                            bd = new Date(year, month, day);
                        }
                    }
                } else {
                    bd = new Date(str);
                }
            }
            if (isNaN(bd) || bd.getFullYear() < 1900) return 0;

            const today = new Date();
            let age = today.getFullYear() - bd.getFullYear();
            const m = today.getMonth() - bd.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < bd.getDate())) age--;
            return age;
        };

        // ì¶”ì²œ ë¡œì§ (ë©¤ë²„ -> ë¦¬ë” ì¶”ì²œ)
        const getDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371; // Radius of Earth in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        };

        const findClosest = (lat, lng, birthdate, leaders, topN = 3) => {
            if (!lat || !lng) return [];
            const candidates = leaders.filter(l => l.id && l.lat && l.lng).map(l => {
                const dist = getDistance(lat, lng, l.lat, l.lng);
                const ageDiff = Math.abs(calcAge(birthdate || '2000-01-01') - calcAge(l.birthdate || '1980-01-01'));
                // ê±°ë¦¬ ìš°ì„  + ë‚˜ì´ ì°¨ì´ ë³´ì • (10km ì´ë‚´ë©´ ë‚˜ì´ ì°¨ì´ ì ìˆ˜ ë°˜ì˜ ë“± - í˜„ì¬ëŠ” ë‹¨ìˆœ ê±°ë¦¬ìˆœ)
                // ê±°ë¦¬ ì ìˆ˜(km) + ë‚˜ì´ì°¨ì´/10 (10ì‚´ ì°¨ì´ = 1km íŒ¨ë„í‹°)
                const score = dist + (ageDiff / 10);
                return { ...l, distance: dist, ageDiff, score };
            });
            return candidates.sort((a, b) => a.score - b.score).slice(0, topN);
        };

        // ì¶”ì²œ ë¡œì§ (ë¦¬ë” -> ë©¤ë²„ ëª¨ì§‘)
        const findRecruits = (leader, members, topN = 5) => {
            if (!leader || !leader.lat || !leader.lng) return { unassigned: [], assigned: [] };

            // ëª¨ë“  ë©¤ë²„ ìŠ¤ì½”ì–´ë§ (ë°°ì •ëœ ë©¤ë²„ëŠ” ìê¸° ì‹êµ¬ ì œì™¸)
            const candidates = members.filter(m => String(m.leader_id) !== String(leader.id) && m.lat && m.lng).map(m => {
                const dist = getDistance(leader.lat, leader.lng, m.lat, m.lng);
                const ageDiff = Math.abs(calcAge(leader.birthdate || '1980-01-01') - calcAge(m.birthdate || '2000-01-01'));
                // ì ìˆ˜: ê±°ë¦¬(km) + (ë‚˜ì´ì°¨ì´/10) -- ê°€ê¹Œìš´ ìˆœì¸ë° ë‚˜ì´ ë¹„ìŠ·í•˜ë©´ ê°€ì‚°ì 
                const score = dist + (ageDiff / 20); // ì—¬ê¸°ì„  ë‚˜ì´ ë¹„ì¤‘ ë” ë‚®ì¶¤ (ê±°ë¦¬ê°€ ë” ì¤‘ìš”)
                return { ...m, distance: dist, ageDiff, score };
            });

            // ë¯¸ë°°ì • / ë°°ì • ë¶„ë¦¬ ì •ë ¬
            const unassigned = candidates.filter(m => !m.leader_id).sort((a, b) => a.score - b.score).slice(0, topN);
            const assigned = candidates.filter(m => m.leader_id).sort((a, b) => a.score - b.score).slice(0, topN);

            return { unassigned, assigned };
        };
        // ìƒë…„ì›”ì¼ í¬ë§·íŒ… (ë‹¤ì–‘í•œ í˜•ì‹ì—ì„œ YYYY-MM-DD ì¶”ì¶œ)
        const formatBirthdate = (birthdate) => {
            if (!birthdate) return '-';
            let year, month, day;
            if (typeof birthdate === 'number') {
                // ìˆ«ì ì‹œë¦¬ì–¼ í˜•ì‹ ë³€í™˜
                const date = new Date((birthdate - 25569) * 86400 * 1000);
                year = date.getFullYear();
                month = date.getMonth() + 1;
                day = date.getDate();
            } else {
                const str = String(birthdate).trim();
                if (str.includes('T')) return str.split('T')[0];
                // YYYY.MM.DD, YYYY/MM/DD, YYYY-MM-DD í˜•ì‹ ìˆ˜ë™ íŒŒì‹±
                const parts = str.split(/[.\/-]/);
                if (parts.length >= 3) {
                    year = parseInt(parts[0]);
                    month = parseInt(parts[1]);
                    day = parseInt(parts[2]);
                }
            }
            if (year && month && day) {
                return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            }
            return String(birthdate).slice(0, 10);
        };
        // ì„±ë³„ ì•„ì´ì½˜ (ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›: Female, ì—¬, ì—¬ì„±, F, å¥³)
        const genderIcon = (g) => { const s = String(g || '').toLowerCase(); if (['male', 'ë‚¨', 'ë‚¨ì„±', 'm', 'ç”·'].some(v => s.includes(v))) return 'ğŸ‘¨'; if (['female', 'ì—¬', 'ì—¬ì„±', 'f', 'å¥³'].some(v => s.includes(v))) return 'ğŸ‘©'; return 'ğŸ‘¤'; };
        // ì„±ë³„ ì •ê·œí™”: ë‚¨/ì—¬, ë‚¨ì„±/ì—¬ì„±, M/F ë“±ì„ Male/Femaleë¡œ í†µì¼
        const normalizeGender = (g) => {
            const s = String(g || '').trim().toLowerCase();
            if (!s) return 'Male';
            if (['male', 'm', 'ë‚¨', 'ë‚¨ì„±', 'man', 'ë‚¨ì', 'ç”·'].includes(s)) return 'Male';
            if (['female', 'f', 'ì—¬', 'ì—¬ì„±', 'woman', 'ì—¬ì', 'å¥³'].includes(s)) return 'Female';
            return 'Male';
        };
        // ì§ë¶„ ê°„ì†Œí™” (ê¶Œì‚¬ í¬í•¨â†’ê¶Œì‚¬, ì•ˆìˆ˜ì§‘ì‚¬ í¬í•¨â†’ì•ˆìˆ˜ì§‘ì‚¬, ì„œë¦¬ì§‘ì‚¬ëŠ” ìœ ì§€)
        const formatRole = (r) => { if (!r) return ''; const s = String(r); if (s.includes('ì„œë¦¬ì§‘ì‚¬')) return s; if (s.includes('ì•ˆìˆ˜ì§‘ì‚¬')) return 'ì•ˆìˆ˜ì§‘ì‚¬'; if (s.includes('ê¶Œì‚¬')) return 'ê¶Œì‚¬'; return s; };
        // ì—°ë½ì²˜ ìë™ í¬ë§·íŒ… (010-0000-0000 í˜•íƒœ)
        const formatPhone = (value) => { const nums = value.replace(/[^0-9]/g, '').slice(0, 11); if (nums.length <= 3) return nums; if (nums.length <= 7) return `${nums.slice(0, 3)}-${nums.slice(3)}`; return `${nums.slice(0, 3)}-${nums.slice(3, 7)}-${nums.slice(7)}`; };

        const SetupScreen = ({ onComplete }) => {
            const [firebaseConfig, setFirebaseConfig] = useState(getFirebaseConfigRaw() || '');
            const [mapsApiKey, setMapsApiKey] = useState(getMapsApiKey() || '');
            const [rememberConfig, setRememberConfig] = useState(!!localStorage.getItem(FIREBASE_CONFIG_KEY));
            const [loading, setLoading] = useState(false);

            const normalizeConfig = (text) => {
                const parsed = parseFirebaseConfig(text);
                const required = ['apiKey', 'authDomain', 'projectId', 'appId'];
                const missing = required.filter(k => !parsed[k]);
                if (missing.length) throw new Error(`Firebase ì„¤ì • ëˆ„ë½: ${missing.join(', ')}`);
                return JSON.stringify(parsed);
            };

            const connect = async () => {
                if (!firebaseConfig.trim()) { alert("Firebase ì„¤ì • JSONì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
                if (!mapsApiKey.trim()) { alert("Google Maps API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }
                setLoading(true);
                try {
                    const normalized = normalizeConfig(firebaseConfig.trim());
                    firebaseDb = null;
                    if (!(await checkConnection(normalized))) throw new Error("Firestore ì—°ê²° ì‹¤íŒ¨");
                    setStoredValue(FIREBASE_CONFIG_KEY, normalized, rememberConfig);
                    setStoredValue(BACKEND_MODE_KEY, 'firebase', rememberConfig);
                    setStoredValue(MAPS_API_KEY_STORAGE, mapsApiKey.trim(), rememberConfig);
                    onComplete();
                } catch (e) {
                    alert(`ì—°ê²° ì‹¤íŒ¨: ${e.message}`);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-2xl overflow-hidden">
                        <div className="bg-brand-600 p-6 text-white text-center">
                            <h1 className="text-2xl font-bold">Firebase ì—°ê²°</h1>
                        </div>
                        <div className="p-8 space-y-6">
                            <div className="bg-blue-50 p-4 rounded-lg text-sm border border-blue-100">
                                <b>1.</b> Firebase í”„ë¡œì íŠ¸ ìƒì„± í›„ Firestore Databaseë¥¼ í™œì„±í™”í•˜ì„¸ìš”.<br />
                                <b>2.</b> í”„ë¡œì íŠ¸ ì„¤ì •ì˜ Web ì•± Firebase Config(JSON)ë¥¼ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.<br />
                                <b>3.</b> Google Maps JavaScript API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.<br />
                                <b>4.</b> [ì—°ê²°]ì„ ëˆ„ë¥´ë©´ ì´í›„ ëª¨ë“  ë°ì´í„°ëŠ” Firestoreë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                            </div>
                            <textarea value={firebaseConfig} onChange={e => setFirebaseConfig(e.target.value)} placeholder='{"apiKey":"...","authDomain":"...","projectId":"...","appId":"..."}' className="w-full border rounded-lg px-3 py-2 h-40 font-mono text-xs" />
                            <input value={mapsApiKey} onChange={e => setMapsApiKey(e.target.value)} placeholder="Google Maps JavaScript API í‚¤" className="w-full border rounded-lg px-3 py-2" />
                            <label className="flex items-center gap-2 text-sm text-slate-600">
                                <input type="checkbox" checked={rememberConfig} onChange={e => setRememberConfig(e.target.checked)} />
                                ì´ ë¸Œë¼ìš°ì €ì— ì„¤ì • ì €ì¥ (í•´ì œ ì‹œ íƒ­ ì¢…ë£Œê¹Œì§€ ìœ ì§€)
                            </label>
                            <div className="text-right">
                                <button onClick={connect} disabled={loading || !firebaseConfig || !mapsApiKey} className="bg-brand-600 text-white px-6 py-2 rounded-lg font-bold disabled:opacity-50">
                                    {loading ? 'í™•ì¸ ì¤‘...' : 'ì—°ê²°'}
                                </button>
                            </div>
                            <div className="text-[11px] text-slate-500">
                                ë³´ì•ˆ ê¶Œì¥: Firestore Rulesë¥¼ ìš´ì˜ ì •ì±…ì— ë§ê²Œ ì„¤ì •í•˜ê³ , Maps API í‚¤ëŠ” referrer/API ì œí•œì„ ë°˜ë“œì‹œ ì ìš©í•˜ì„¸ìš”.
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Modal = ({ leader, onClose, onUpdate }) => {
            const [members, setMembers] = useState([]), [loading, setLoading] = useState(true);
            useEffect(() => { if (leader.id) { setLoading(true); fetchMembersByLeader(leader.id).then(setMembers).finally(() => setLoading(false)) } }, [leader]);
            const remove = async (id, mode) => { if (!confirm(mode === 'DELETE' ? "ì‚­ì œ?" : "ì œì™¸?")) return; await removeMember(id, leader.id, mode); setMembers(await fetchMembersByLeader(leader.id)); onUpdate() };
            return (<div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50"><div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col"><div className="px-6 py-4 border-b flex justify-between bg-slate-50"><div><b className="text-lg">{leader.name}</b> ì†Œê·¸ë£¹ì› ({members.length}ëª…)</div><button onClick={onClose}>âœ•</button></div><div className="flex-1 overflow-auto p-4">{loading ? <div className="text-center py-8">ë¡œë”©...</div> : members.length === 0 ? <div className="text-center text-slate-400 py-8">ì—†ìŒ</div> : members.map(m => <div key={m.id} className="flex justify-between p-3 bg-slate-50 rounded-lg mb-2"><div><b>{m.name}</b> <span className="text-xs text-slate-500">{m.role} Â· {calcAge(m.birthdate)}ì„¸</span></div><div className="text-xs space-x-2"><button onClick={() => remove(m.id, 'UNASSIGN')} className="text-amber-600">ì œì™¸</button><button onClick={() => remove(m.id, 'DELETE')} className="text-red-600">ì‚­ì œ</button></div></div>)}</div><div className="p-4 border-t text-right"><button onClick={onClose} className="px-4 py-2 border rounded-lg">ë‹«ê¸°</button></div></div></div>)
        };

        // ì •ë³´ ìˆ˜ì • ëª¨ë‹¬
        const EditModal = ({ item, type, leaders, onClose, onUpdate }) => {
            const [form, setForm] = useState({ ...item });
            const [saving, setSaving] = useState(false);
            const [addressChanged, setAddressChanged] = useState(false);

            const handleChange = (key, value) => {
                setForm(prev => ({ ...prev, [key]: value }));
                if (key === 'address') setAddressChanged(true);
            };

            const save = async () => {
                setSaving(true);
                try {
                    let updates = {};
                    const fields = type === 'leader'
                        ? ['name', 'role', 'gender', 'birthdate', 'contact', 'address', 'max_capacity']
                        : ['name', 'role', 'gender', 'birthdate', 'contact', 'address', 'leader_id'];

                    for (const f of fields) {
                        if (String(form[f] ?? '') !== String(item[f] ?? '')) {
                            updates[f] = form[f];
                        }
                    }

                    // ì£¼ì†Œê°€ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ì¢Œí‘œ ì—…ë°ì´íŠ¸
                    if (addressChanged && updates.address) {
                        console.log('[EditModal] ì£¼ì†Œ ë³€ê²½ ê°ì§€, geocode í˜¸ì¶œ:', updates.address);
                        try {
                            const geo = await geocodeAddress(updates.address);
                            console.log('[EditModal] geocode ì„±ê³µ:', geo);
                            updates.address = geo.formattedAddress;
                            updates.lat = geo.lat;
                            updates.lng = geo.lng;
                        } catch (geoErr) {
                            console.error('[EditModal] geocode ì‹¤íŒ¨:', geoErr);
                            alert(`ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨: ${geoErr.message}\nì…ë ¥í•œ ì£¼ì†Œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`);
                            setSaving(false);
                            return;
                        }
                    }

                    if (Object.keys(updates).length === 0) {
                        alert("ë³€ê²½ì‚¬í•­ ì—†ìŒ");
                        setSaving(false);
                        return;
                    }

                    console.log('[EditModal] ì„œë²„ë¡œ ì „ì†¡í•  updates:', updates);

                    if (type === 'leader') {
                        await updateLeader(item.id, updates);
                    } else {
                        await updateMember(item.id, updates);
                    }

                    alert("ìˆ˜ì • ì™„ë£Œ");
                    onUpdate();
                    onClose();
                } catch (e) {
                    console.error('[EditModal] ì €ì¥ ì‹¤íŒ¨:', e);
                    alert(`ì €ì¥ ì‹¤íŒ¨: ${e.message}`);
                } finally {
                    setSaving(false);
                }
            };

            const ic = "block w-full rounded-md border shadow-sm py-2 px-3 text-sm";

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
                        <div className="px-6 py-4 border-b flex justify-between bg-slate-50">
                            <b className="text-lg">âœï¸ {type === 'leader' ? 'ë¦¬ë”' : 'ìˆœì›'} ì •ë³´ ìˆ˜ì •</b>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600">âœ•</button>
                        </div>
                        <div className="p-6 space-y-4">
                            <div>
                                <label className="text-xs font-bold text-slate-500 block mb-1">ì´ë¦„</label>
                                <input value={form.name || ''} onChange={e => handleChange('name', e.target.value)} className={ic} />
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-xs font-bold text-slate-500 block mb-1">ì§ë¶„</label>
                                    <input value={form.role || ''} onChange={e => handleChange('role', e.target.value)} className={ic} />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-500 block mb-1">ìƒë…„ì›”ì¼</label>
                                    <input type="date" value={form.birthdate || ''} onChange={e => handleChange('birthdate', e.target.value)} className={ic} />
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-xs font-bold text-slate-500 block mb-1">ì„±ë³„</label>
                                    <select value={form.gender || 'Male'} onChange={e => handleChange('gender', e.target.value)} className={ic}>
                                        <option value="Male">ë‚¨</option>
                                        <option value="Female">ì—¬</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-500 block mb-1">ì—°ë½ì²˜</label>
                                    <input value={form.contact || ''} onChange={e => handleChange('contact', e.target.value)} className={ic} placeholder="010-0000-0000" />
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 block mb-1">ì£¼ì†Œ</label>
                                <input value={form.address || ''} onChange={e => handleChange('address', e.target.value)} className={ic} />
                                {addressChanged && <p className="text-xs text-amber-600 mt-1">âš ï¸ ì£¼ì†Œ ë³€ê²½ ì‹œ ì¢Œí‘œê°€ ë‹¤ì‹œ ê³„ì‚°ë©ë‹ˆë‹¤</p>}
                            </div>
                            {type === 'leader' ? (
                                <div>
                                    <label className="text-xs font-bold text-slate-500 block mb-1">ì •ì›</label>
                                    <input type="number" value={form.max_capacity || ''} onChange={e => handleChange('max_capacity', e.target.value)} className={ic} />
                                </div>
                            ) : (
                                <>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 block mb-1">ì†Œì† ë¦¬ë”</label>
                                        <select value={form.leader_id || ''} onChange={e => handleChange('leader_id', e.target.value)} className={ic}>
                                            <option value="">ë¯¸ë°°ì •</option>
                                            {leaders?.map(l => <option key={l.id} value={l.id}>{l.name} ({l.current_members}/{l.max_capacity}ëª…){l.current_members >= l.max_capacity ? ' [ë§Œì„]' : ''}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 block mb-1">ì°¸ì—¬ ìƒíƒœ</label>
                                        <select value={form.status || 'wants_group'} onChange={e => handleChange('status', e.target.value)} className={ic}>
                                            <option value="wants_group">ì°¸ì—¬í¬ë§ (B-1)</option>
                                            <option value="no_group">ì°¸ì—¬ì•ˆí•¨ (B-2)</option>
                                        </select>
                                        <p className="text-xs text-slate-400 mt-1">ë¦¬ë”ê°€ ë°°ì •ë˜ë©´ ìë™ìœ¼ë¡œ 'ì†Œì†ë¨'ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤</p>
                                    </div>
                                </>
                            )}
                        </div>
                        <div className="p-4 border-t bg-slate-50 flex gap-2 justify-end">
                            <button onClick={onClose} className="px-4 py-2 border rounded-lg">ì·¨ì†Œ</button>
                            <button onClick={save} disabled={saving} className="px-4 py-2 bg-brand-600 text-white rounded-lg font-bold disabled:opacity-50">
                                {saving ? 'ì €ì¥ì¤‘...' : 'ì €ì¥'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const DuplicateCheckModal = ({ onClose, onUpdate }) => {
            const [loading, setLoading] = useState(true), [duplicates, setDuplicates] = useState({ nameContactDups: [], leaderAsMember: [] });
            useEffect(() => { checkDuplicates() }, []);
            const checkDuplicates = async () => {
                setLoading(true);
                try {
                    const { leaders, members } = await fetchFullData();
                    // 1. ì´ë¦„+ì—°ë½ì²˜ ê¸°ì¤€ ì¤‘ë³µ ì²´í¬ (ë¦¬ë” ê°„, ìˆœì› ê°„, ë¦¬ë”-ìˆœì› ê°„)
                    const allPeople = [...leaders.map(l => ({ ...l, type: 'leader' })), ...members.map(m => ({ ...m, type: 'member' }))];
                    const keyMap = {};
                    allPeople.forEach(p => {
                        const key = `${(p.name || '').trim()}_${(p.contact || '').trim()}`;
                        if (key === '_') return;
                        if (!keyMap[key]) keyMap[key] = [];
                        keyMap[key].push(p);
                    });
                    const nameContactDups = Object.entries(keyMap).filter(([k, v]) => v.length > 1).map(([k, v]) => ({ key: k, people: v }));
                    // 2. ë¦¬ë”ê°€ ìˆœì›ìœ¼ë¡œë„ ë“±ë¡ëœ ê²½ìš° (ì´ë¦„+ì—°ë½ì²˜ ê¸°ì¤€)
                    const leaderKeys = new Set(leaders.map(l => `${(l.name || '').trim()}_${(l.contact || '').trim()}`));
                    const leaderAsMember = members.filter(m => {
                        const key = `${(m.name || '').trim()}_${(m.contact || '').trim()}`;
                        return key !== '_' && leaderKeys.has(key);
                    }).map(m => {
                        const matchedLeader = leaders.find(l => `${(l.name || '').trim()}_${(l.contact || '').trim()}` === `${(m.name || '').trim()}_${(m.contact || '').trim()}`);
                        return { member: m, leader: matchedLeader };
                    });
                    setDuplicates({ nameContactDups, leaderAsMember });
                } catch (e) { alert(e.message) }
                finally { setLoading(false) }
            };
            const deleteMember = async (id) => { if (!confirm("ì´ ìˆœì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; await removeMember(id, null, 'DELETE'); await checkDuplicates(); onUpdate() };
            const deleteLeader = async (id) => { if (!confirm("ì´ ë¦¬ë”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì†Œì† ìˆœì›ì€ ë¯¸ë°°ì • ìƒíƒœê°€ ë©ë‹ˆë‹¤)")) return; await request('DELETE_LEADER', { id }); await checkDuplicates(); onUpdate() };
            const totalIssues = duplicates.nameContactDups.length + duplicates.leaderAsMember.length;
            return (<div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50"><div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[85vh] overflow-hidden flex flex-col"><div className="px-6 py-4 border-b flex justify-between bg-slate-50"><div><b className="text-lg">ğŸ” ì¤‘ë³µ ê²€ì‚¬ ê²°ê³¼</b> {!loading && <span className={`ml-2 text-sm ${totalIssues > 0 ? 'text-red-600' : 'text-green-600'}`}>{totalIssues > 0 ? `${totalIssues}ê±´ ë°œê²¬` : 'ì´ìƒ ì—†ìŒ âœ“'}</span>}</div><button onClick={onClose} className="text-slate-400 hover:text-slate-600">âœ•</button></div><div className="flex-1 overflow-auto p-6 space-y-6">{loading ? <div className="text-center py-12"><div className="w-8 h-8 border-4 border-brand-200 border-t-brand-600 rounded-full animate-spin mx-auto mb-4" />ê²€ì‚¬ì¤‘...</div> : <>{duplicates.leaderAsMember.length > 0 && <div className="space-y-3"><div className="flex items-center gap-2 text-red-600 font-bold"><span className="text-lg">âš ï¸</span> ë¦¬ë”ê°€ ìˆœì›ìœ¼ë¡œ ë“±ë¡ë¨ ({duplicates.leaderAsMember.length}ê±´)</div><div className="text-xs text-slate-500 mb-2">ë¦¬ë”ê°€ ë‹¤ë¥¸ ê·¸ë£¹ì˜ ìˆœì›ìœ¼ë¡œë„ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ìˆœì› ê¸°ë¡ì„ ì‚­ì œí•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.</div>{duplicates.leaderAsMember.map((d, i) => <div key={i} className="bg-red-50 border border-red-200 rounded-xl p-4"><div className="flex justify-between items-start"><div><div className="font-bold text-red-700">{d.member.name} <span className="text-xs font-normal">({d.member.contact})</span></div><div className="text-xs text-slate-600 mt-1"><span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded mr-2">ë¦¬ë”</span> {d.leader?.role} Â· {d.leader?.address}</div><div className="text-xs text-slate-600 mt-1"><span className="bg-amber-100 text-amber-700 px-2 py-0.5 rounded mr-2">ìˆœì›</span> {d.member.role} Â· {d.member.address}</div></div><button onClick={() => deleteMember(d.member.id)} className="text-xs bg-red-600 text-white px-3 py-1.5 rounded-lg hover:bg-red-700">ìˆœì› ì‚­ì œ</button></div></div>)}</div>}{duplicates.nameContactDups.length > 0 && <div className="space-y-3"><div className="flex items-center gap-2 text-amber-600 font-bold"><span className="text-lg">ğŸ“‹</span> ë™ì¼ì¸ ì¤‘ë³µ ë“±ë¡ ({duplicates.nameContactDups.length}ê±´)</div><div className="text-xs text-slate-500 mb-2">ê°™ì€ ì´ë¦„ê³¼ ì—°ë½ì²˜ë¥¼ ê°€ì§„ ì‚¬ëŒì´ ì—¬ëŸ¬ ë²ˆ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</div>{duplicates.nameContactDups.map((dup, i) => <div key={i} className="bg-amber-50 border border-amber-200 rounded-xl p-4"><div className="font-bold text-amber-700 mb-2">{dup.people[0]?.name} <span className="text-xs font-normal">({dup.people[0]?.contact})</span> - {dup.people.length}ê°œ ë ˆì½”ë“œ</div><div className="space-y-2">{dup.people.map((p, j) => <div key={j} className="flex justify-between items-center bg-white rounded-lg p-2 text-sm"><div><span className={`text-xs px-2 py-0.5 rounded mr-2 ${p.type === 'leader' ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-600'}`}>{p.type === 'leader' ? 'ë¦¬ë”' : 'ìˆœì›'}</span>{p.role} Â· {calcAge(p.birthdate)}ì„¸ Â· {p.address}</div><button onClick={() => p.type === 'leader' ? deleteLeader(p.id) : deleteMember(p.id)} className="text-xs text-red-600 hover:text-red-800 px-2">ì‚­ì œ</button></div>)}</div></div>)}</div>}{totalIssues === 0 && <div className="text-center py-12"><div className="text-6xl mb-4">âœ…</div><div className="text-xl font-bold text-green-600">ì¤‘ë³µ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div><div className="text-sm text-slate-500 mt-2">ëª¨ë“  ë°ì´í„°ê°€ ì •ìƒì…ë‹ˆë‹¤.</div></div>}</>}</div><div className="p-4 border-t bg-slate-50 flex justify-between"><button onClick={checkDuplicates} disabled={loading} className="text-sm bg-white border px-4 py-2 rounded-lg hover:bg-slate-50">ğŸ”„ ë‹¤ì‹œ ê²€ì‚¬</button><button onClick={onClose} className="px-4 py-2 bg-brand-600 text-white rounded-lg font-bold">ë‹«ê¸°</button></div></div></div>)
        };

        const LeaderUpload = ({ globalData, onRefresh }) => {
            const getStoredLeaderForm = () => { try { const s = sessionStorage.getItem('LEADER_FORM'); return s ? JSON.parse(s) : null } catch { return null } };
            const getStoredMemberForm = () => { try { const s = sessionStorage.getItem('MEMBER_FORM'); return s ? JSON.parse(s) : null } catch { return null } };
            const [scope, setScope] = useState('LEADER'), [mode, setMode] = useState('csv'), [listTab, setListTab] = useState('LEADER');
            // ì „ì—­ ë°ì´í„° ì‚¬ìš©
            const leaders = globalData?.leaders || [];
            const members = globalData?.members || [];
            const [processing, setProcessing] = useState(false), [logs, setLogs] = useState([]), [progress, setProgress] = useState(0);
            const [form, setForm] = useState(() => getStoredLeaderForm() || { name: '', role: 'ì§‘ì‚¬', gender: 'Male', birthdate: '', contact: '', address: '', max_capacity: 10 });
            const [mForm, setMForm] = useState(() => getStoredMemberForm() || { name: '', role: 'ì„±ë„', gender: 'Male', birthdate: '', contact: '', address: '', leader_id: '', status: 'wants_group' });
            const [saving, setSaving] = useState(false), [selected, setSelected] = useState(null), [showDupCheck, setShowDupCheck] = useState(false);
            const [editItem, setEditItem] = useState(null), [editType, setEditType] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [sortBy, setSortBy] = useState('name'); // 'name' | 'age'

            // ë°ì´í„° ë³€ê²½ í›„ ìƒˆë¡œê³ ì¹¨ì€ onRefresh í˜¸ì¶œ
            const loadData = () => onRefresh?.();

            useEffect(() => { sessionStorage.setItem('LEADER_FORM', JSON.stringify(form)) }, [form]);
            useEffect(() => { sessionStorage.setItem('MEMBER_FORM', JSON.stringify(mForm)) }, [mForm]);

            const log = m => setLogs(p => [m, ...p]);

            // ì •ë ¬ í•¨ìˆ˜
            const sortItems = (items) => {
                return [...items].sort((a, b) => {
                    if (sortBy === 'age') return calcAge(b.birthdate) - calcAge(a.birthdate);
                    return (a.name || '').localeCompare(b.name || '', 'ko');
                });
            };

            // ê²€ìƒ‰ í•„í„°ë§ + ì •ë ¬
            const filteredLeaders = sortItems(leaders.filter(l => {
                if (!searchQuery.trim()) return true;
                const q = searchQuery.toLowerCase();
                return l.name?.toLowerCase().includes(q) || l.contact?.includes(q) || l.address?.toLowerCase().includes(q);
            }));

            const filteredMembers = sortItems(members.filter(m => {
                if (!searchQuery.trim()) return true;
                const q = searchQuery.toLowerCase();
                return m.name?.toLowerCase().includes(q) || m.contact?.includes(q) || m.address?.toLowerCase().includes(q);
            }));

            const downloadSampleCSV = () => {
                let csvContent, filename;
                if (scope === 'LEADER') {
                    csvContent = "name,role,gender,birthdate,contact,address,lat,lng,max_capacity\ní™ê¸¸ë™,ì§‘ì‚¬,Male,1980-03-15,010-1234-5678,ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™ 123,,,10\nê¹€ì˜í¬,ê¶Œì‚¬,Female,1973-08-22,010-9876-5432,ì„œìš¸ì‹œ ì„œì´ˆêµ¬ ì„œì´ˆë™ 456,37.483569,127.032598,8";
                    filename = "ë¦¬ë”_ìƒ˜í”Œ.csv";
                } else {
                    csvContent = "name,role,gender,birthdate,contact,address,lat,lng,leader_name,status\nì´ì² ìˆ˜,ì„±ë„,Male,1990-05-10,010-1111-2222,ì„œìš¸ì‹œ ì†¡íŒŒêµ¬ ì ì‹¤ë™ 789,,,,wants_group\në°•ë¯¼ì˜,ì²­ë…„,Female,1997-12-03,010-3333-4444,ì„œìš¸ì‹œ ê°•ë™êµ¬ ì²œí˜¸ë™ 321,37.538484,127.123636,,no_group";
                    filename = "ìˆœì›_ìƒ˜í”Œ.csv";
                }
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
            };

            const shouldRetryGeocode = message => {
                const m = String(message || '').toUpperCase();
                return m.includes('OVER_QUERY_LIMIT') || m.includes('UNKNOWN_ERROR') || m.includes('ERROR');
            };

            const geocodeWithRetry = async (address, maxRetries = 2) => {
                let lastError = null;
                for (let attempt = 0; attempt <= maxRetries; attempt++) {
                    try {
                        return await geocodeAddress(address);
                    } catch (err) {
                        lastError = err;
                        if (!shouldRetryGeocode(err?.message) || attempt === maxRetries) break;
                        const backoffMs = 700 * (2 ** attempt);
                        await sleep(backoffMs);
                    }
                }
                throw lastError || new Error('Geocode failed');
            };

            const downloadFailedRowsCSV = (failedRows) => {
                if (!failedRows?.length) return;
                const ws = XLSX.utils.json_to_sheet(failedRows);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "ì‹¤íŒ¨í–‰");
                const fileName = `ì—…ë¡œë“œì‹¤íŒ¨_${scope}_${new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-')}.csv`;
                XLSX.writeFile(wb, fileName, { bookType: 'csv' });
            };

            const upload = e => {
                const file = e.target.files?.[0];
                if (!file) return;
                setProcessing(true);
                setLogs([]);
                setProgress(0);
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: async r => {
                        const rows = r.data || [];
                        const toNumber = v => {
                            const n = Number(v);
                            return Number.isFinite(n) ? n : null;
                        };
                        const leaderRows = [];
                        const memberRows = [];
                        const failedRows = [];
                        log(`${rows.length}ê°œ ì²˜ë¦¬ ì‹œì‘`);

                        for (let i = 0; i < rows.length; i++) {
                            const row = rows[i] || {};
                            const name = String(row.name || '').trim();
                            const address = String(row.address || '').trim();
                            const csvLat = toNumber(row.lat);
                            const csvLng = toNumber(row.lng);
                            const hasCoords = csvLat !== null && csvLng !== null;

                            if (!name) {
                                log(`[SKIP] ${i + 1}í–‰: ì´ë¦„ ì—†ìŒ`);
                                continue;
                            }
                            if (!address && !hasCoords) {
                                log(`[SKIP] ${i + 1}í–‰: ì£¼ì†Œ/ì¢Œí‘œ ì—†ìŒ`);
                                continue;
                            }

                            try {
                                let geo = null;
                                if (hasCoords) {
                                    geo = { lat: csvLat, lng: csvLng, formattedAddress: address || '' };
                                } else {
                                    geo = await geocodeWithRetry(address, 2);
                                    await sleep(GEOCODE_DELAY_MS);
                                }
                                if (scope === 'LEADER') {
                                    leaderRows.push({
                                        id: newNumericId(),
                                        name,
                                        role: row.role || 'ì„±ë„',
                                        gender: normalizeGender(row.gender),
                                        birthdate: row.birthdate || '',
                                        contact: row.contact || '',
                                        address: geo.formattedAddress || address,
                                        lat: geo.lat,
                                        lng: geo.lng,
                                        max_capacity: parseInt(row.max_capacity, 10) || 10,
                                        current_members: 0
                                    });
                                } else {
                                    let leaderId = '';
                                    if (row.leader_name) {
                                        const found = leaders.find(l => String(l.name || '').trim() === String(row.leader_name || '').trim());
                                        if (found) leaderId = found.id;
                                    }
                                    memberRows.push({
                                        id: newNumericId(),
                                        name,
                                        role: row.role || 'ì„±ë„',
                                        gender: normalizeGender(row.gender),
                                        birthdate: row.birthdate || '',
                                        contact: row.contact || '',
                                        address: geo.formattedAddress || address,
                                        lat: geo.lat,
                                        lng: geo.lng,
                                        leader_id: leaderId || '',
                                        status: row.status || 'wants_group'
                                    });
                                }
                                log(`[OK] ${name}`);
                            } catch (err) {
                                const reason = err?.message || String(err) || 'unknown';
                                log(`[ERR] ${name}: ${reason}`);
                                failedRows.push({
                                    ...row,
                                    error_reason: reason
                                });
                            }
                            setProgress(Math.round(((i + 1) / rows.length) * 100));
                        }

                        try {
                            if (scope === 'LEADER' && leaderRows.length) await bulkInsert('leaders', leaderRows);
                            if (scope === 'MEMBER' && memberRows.length) {
                                await bulkInsert('members', memberRows);
                                await refreshAllLeaderCounts();
                            }
                            log(`ì™„ë£Œ: ${scope === 'LEADER' ? leaderRows.length : memberRows.length}ê±´ ì €ì¥`);
                            if (failedRows.length) {
                                log(`ì‹¤íŒ¨ ${failedRows.length}ê±´: ì‹¤íŒ¨ CSV ë‹¤ìš´ë¡œë“œ`);
                                downloadFailedRowsCSV(failedRows);
                            }
                        } catch (saveErr) {
                            log(`[ERR] ì €ì¥ ì‹¤íŒ¨: ${saveErr.message}`);
                        } finally {
                            setProcessing(false);
                            loadData();
                            e.target.value = '';
                        }
                    }
                });
            };

            const submit = async e => { e.preventDefault(); setSaving(true); try { if (scope === 'LEADER') { const geo = await geocodeAddress(form.address); await insertLeader({ ...form, gender: normalizeGender(form.gender), max_capacity: parseInt(form.max_capacity), lat: geo.lat, lng: geo.lng, current_members: 0 }); alert("ë“±ë¡ ì™„ë£Œ"); setForm({ name: '', role: 'ì§‘ì‚¬', gender: 'Male', birthdate: '', contact: '', address: '', max_capacity: 10 }) } else { const geo = await geocodeAddress(mForm.address); await insertMember({ ...mForm, gender: normalizeGender(mForm.gender), lat: geo.lat, lng: geo.lng, leader_id: mForm.leader_id ? parseInt(mForm.leader_id) : null, status: mForm.status || 'wants_group' }); alert("ë“±ë¡ ì™„ë£Œ"); setMForm({ name: '', role: 'ì„±ë„', gender: 'Male', birthdate: '', contact: '', address: '', leader_id: '', status: 'wants_group' }) } loadData() } catch (err) { alert(err.message) } finally { setSaving(false) } };

            const delLeader = async (id, e) => { e.stopPropagation(); if (!confirm("ì‚­ì œ? ì†Œì† ìˆœì›ì€ ë¯¸ë°°ì • ìƒíƒœê°€ ë©ë‹ˆë‹¤.")) return; await deleteLeader(id); loadData() };
            const delMember = async (id, e) => { e.stopPropagation(); if (!confirm("ì‚­ì œ?")) return; await removeMember(id, null, 'DELETE'); loadData() };

            const openEdit = (item, type, e) => { e?.stopPropagation(); setEditItem(item); setEditType(type); };

            // ìˆœì›ì„ ë¦¬ë”ë¡œ ìŠ¹ê²©ì‹œí‚¤ëŠ” í•¨ìˆ˜
            const promoteToLeader = async (member, e) => {
                e?.stopPropagation();
                if (!confirm(`${member.name}ë‹˜ì„ ë¦¬ë”ë¡œ ì„¸ìš°ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€¢ ìˆœì› ëª©ë¡ì—ì„œ ì‚­ì œë©ë‹ˆë‹¤\nâ€¢ ë¦¬ë” ëª©ë¡ì— ì¶”ê°€ë©ë‹ˆë‹¤`)) return;
                setProcessing(true);
                try {
                    // 1. ë¦¬ë”ë¡œ ë“±ë¡
                    await insertLeader({
                        name: member.name,
                        role: member.role || 'ì§‘ì‚¬',
                        gender: normalizeGender(member.gender),
                        birthdate: member.birthdate || '',
                        contact: member.contact || '',
                        address: member.address || '',
                        lat: member.lat || 0,
                        lng: member.lng || 0,
                        max_capacity: 10,
                        current_members: 0
                    });
                    // 2. ìˆœì›ì—ì„œ ì‚­ì œ
                    await removeMember(member.id, member.leader_id, 'DELETE');
                    alert(`${member.name}ë‹˜ì´ ë¦¬ë”ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                    loadData();
                } catch (err) {
                    alert(`ì‹¤íŒ¨: ${err.message}`);
                } finally {
                    setProcessing(false);
                }
            };

            // íƒ­ì— ë”°ë¼ CSV í˜•ì‹ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ (ì—…ë¡œë“œ í˜•ì‹ê³¼ ë™ì¼)
            const exportLeadersCSV = () => {
                const csvData = leaders.map(l => ({
                    name: l.name,
                    role: l.role || '',
                    gender: normalizeGender(l.gender),
                    birthdate: formatBirthdate(l.birthdate),
                    contact: l.contact || '',
                    address: l.address || '',
                    max_capacity: l.max_capacity || 10
                }));
                const ws = XLSX.utils.json_to_sheet(csvData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "ë¦¬ë”");
                XLSX.writeFile(wb, `ë¦¬ë”_${new Date().toISOString().slice(0, 10)}.csv`, { bookType: 'csv' });
            };

            const exportMembersCSV = () => {
                const csvData = members.map(m => {
                    // status ê²°ì •: leader_idê°€ ìˆìœ¼ë©´ assigned, ì—†ìœ¼ë©´ ê¸°ì¡´ status ì‚¬ìš©
                    const effectiveStatus = m.leader_id ? 'assigned' : (m.status || 'wants_group');
                    return {
                        name: m.name,
                        role: m.role || '',
                        gender: normalizeGender(m.gender),
                        birthdate: formatBirthdate(m.birthdate),
                        contact: m.contact || '',
                        address: m.address || '',
                        leader_name: getLeaderName(m.leader_id) === 'ë¯¸ë°°ì •' ? '' : getLeaderName(m.leader_id),
                        status: effectiveStatus
                    };
                });
                const ws = XLSX.utils.json_to_sheet(csvData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "ìˆœì›");
                XLSX.writeFile(wb, `ìˆœì›_${new Date().toISOString().slice(0, 10)}.csv`, { bookType: 'csv' });
            };

            // ì¼ê´„ ì‚­ì œ í•¨ìˆ˜
            const deleteAllLeaders = async () => {
                if (leaders.length === 0) { alert('ì‚­ì œí•  ë¦¬ë”ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
                if (!confirm(`ì •ë§ë¡œ ë¦¬ë” ${leaders.length}ëª…ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì£¼ì˜: ì†Œì† ìˆœì›ë“¤ì€ ë¯¸ë°°ì • ìƒíƒœê°€ ë©ë‹ˆë‹¤.`)) return;
                if (!confirm('âš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì •ë§ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                setProcessing(true);
                log('ë¦¬ë” ì¼ê´„ ì‚­ì œ ì‹œì‘...');
                for (let i = 0; i < leaders.length; i++) {
                    try {
                        await deleteLeader(leaders[i].id);
                        log(`[ì‚­ì œ] ${leaders[i].name}`);
                    } catch (e) {
                        log(`[ì˜¤ë¥˜] ${leaders[i].name}: ${e.message}`);
                    }
                    setProgress(Math.round((i + 1) / leaders.length * 100));
                }
                setProcessing(false);
                loadData();
                alert('ë¦¬ë” ì¼ê´„ ì‚­ì œ ì™„ë£Œ');
            };

            const deleteAllMembers = async () => {
                if (members.length === 0) { alert('ì‚­ì œí•  ìˆœì›ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
                if (!confirm(`ì •ë§ë¡œ ìˆœì› ${members.length}ëª…ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                if (!confirm('âš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì •ë§ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                setProcessing(true);
                log('ìˆœì› ì¼ê´„ ì‚­ì œ ì‹œì‘...');
                for (let i = 0; i < members.length; i++) {
                    try {
                        await removeMember(members[i].id, null, 'DELETE');
                    } catch (e) {
                        log(`[ì˜¤ë¥˜] ${members[i].name}: ${e.message}`);
                    }
                    setProgress(Math.round((i + 1) / members.length * 100));
                }
                setProcessing(false);
                loadData();
                alert('ìˆœì› ì¼ê´„ ì‚­ì œ ì™„ë£Œ');
            };

            const deleteAllUnassigned = async () => {
                const unassignedMembers = members.filter(m => !m.leader_id);
                if (unassignedMembers.length === 0) { alert('ì‚­ì œí•  ë¯¸ë°°ì • ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
                if (!confirm(`ì •ë§ë¡œ ë¯¸ë°°ì • ì¸ì› ${unassignedMembers.length}ëª…ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                if (!confirm('âš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì •ë§ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                setProcessing(true);
                log('ë¯¸ë°°ì • ì¸ì› ì¼ê´„ ì‚­ì œ ì‹œì‘...');
                for (let i = 0; i < unassignedMembers.length; i++) {
                    try {
                        await removeMember(unassignedMembers[i].id, null, 'DELETE');
                        log(`[ì‚­ì œ] ${unassignedMembers[i].name}`);
                    } catch (e) {
                        log(`[ì˜¤ë¥˜] ${unassignedMembers[i].name}: ${e.message}`);
                    }
                    setProgress(Math.round((i + 1) / unassignedMembers.length * 100));
                }
                setProcessing(false);
                loadData();
                alert('ë¯¸ë°°ì • ì¸ì› ì¼ê´„ ì‚­ì œ ì™„ë£Œ');
            };

            const getLeaderName = (leaderId) => { const l = leaders.find(x => x.id === leaderId); return l ? l.name : 'ë¯¸ë°°ì •'; };

            const ic = "block w-full rounded-md border shadow-sm py-2 px-3 text-sm";

            return (<div className="grid grid-cols-1 lg:grid-cols-3 gap-8 pb-12">
                {selected && <Modal leader={selected} onClose={() => setSelected(null)} onUpdate={loadData} />}
                {showDupCheck && <DuplicateCheckModal onClose={() => setShowDupCheck(false)} onUpdate={loadData} />}
                {editItem && <EditModal item={editItem} type={editType} leaders={leaders} onClose={() => { setEditItem(null); setEditType(null); }} onUpdate={loadData} />}

                {/* ì™¼ìª½: ë“±ë¡ í¼ */}
                <div className="space-y-4">
                    <div className="bg-slate-100 p-1 rounded-xl flex">
                        <button onClick={() => setScope('LEADER')} className={`flex-1 py-2 text-sm font-bold rounded-lg ${scope === 'LEADER' ? 'bg-white text-brand-600' : 'text-slate-500'}`}>ë¦¬ë”</button>
                        <button onClick={() => setScope('MEMBER')} className={`flex-1 py-2 text-sm font-bold rounded-lg ${scope === 'MEMBER' ? 'bg-white text-brand-600' : 'text-slate-500'}`}>ì†Œì†ì›</button>
                    </div>
                    <div className="bg-white p-1 rounded-xl border flex">
                        <button onClick={() => setMode('csv')} className={`flex-1 py-2 text-sm rounded-lg ${mode === 'csv' ? 'bg-brand-50 text-brand-700' : 'text-slate-500'}`}>CSV</button>
                        <button onClick={() => setMode('manual')} className={`flex-1 py-2 text-sm rounded-lg ${mode === 'manual' ? 'bg-brand-50 text-brand-700' : 'text-slate-500'}`}>ì§ì ‘</button>
                    </div>
                    {mode === 'csv' ? (
                        <div className="bg-white rounded-2xl border p-6 space-y-4">
                            <button onClick={downloadSampleCSV} className="w-full text-xs bg-amber-50 text-amber-700 px-4 py-2 rounded-lg border border-amber-200 hover:bg-amber-100 font-medium">ğŸ“¥ {scope === 'LEADER' ? 'ë¦¬ë”' : 'ì†Œì†ì›'} ìƒ˜í”Œ CSV ë‹¤ìš´ë¡œë“œ</button>
                            <label className="block border-2 border-dashed rounded-xl p-6 text-center cursor-pointer border-brand-200 hover:border-brand-400">
                                <input type="file" accept=".csv" onChange={upload} className="hidden" disabled={processing} />
                                <span className="text-brand-600 font-medium">CSV ì„ íƒ</span>
                            </label>
                            {processing && <div className="h-2 bg-slate-100 rounded-full"><div className="h-full bg-brand-500 rounded-full" style={{ width: `${progress}%` }} /></div>}
                            <div className="h-40 bg-slate-900 rounded-lg p-3 overflow-auto font-mono text-xs text-green-400">{logs.map((l, i) => <div key={i}>{l}</div>)}</div>
                        </div>
                    ) : (
                        <form onSubmit={submit} className="bg-white rounded-2xl border p-6 space-y-3">
                            {scope === 'LEADER' ? <>
                                <input required value={form.name} onChange={e => setForm({ ...form, name: e.target.value })} className={ic} placeholder="ì´ë¦„" />
                                <input required value={form.address} onChange={e => setForm({ ...form, address: e.target.value })} className={ic} placeholder="ì£¼ì†Œ" />
                                <div className="grid grid-cols-2 gap-2">
                                    <input type="date" required value={form.birthdate} onChange={e => setForm({ ...form, birthdate: e.target.value })} className={ic} title="ìƒë…„ì›”ì¼" />
                                    <select value={form.gender} onChange={e => setForm({ ...form, gender: e.target.value })} className={ic}><option value="Male">ë‚¨</option><option value="Female">ì—¬</option></select>
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                    <input value={form.role} onChange={e => setForm({ ...form, role: e.target.value })} className={ic} placeholder="ì§ë¶„ (ì˜ˆ: ì§‘ì‚¬)" />
                                    <input value={form.contact} onChange={e => setForm({ ...form, contact: formatPhone(e.target.value) })} className={ic} placeholder="ì—°ë½ì²˜" />
                                </div>
                                <input type="number" value={form.max_capacity} onChange={e => setForm({ ...form, max_capacity: e.target.value })} className={ic} placeholder="ì •ì› (ê¸°ë³¸ 10ëª…)" min="1" />
                            </> : <>
                                <input required value={mForm.name} onChange={e => setMForm({ ...mForm, name: e.target.value })} className={ic} placeholder="ì´ë¦„" />
                                <input required value={mForm.address} onChange={e => setMForm({ ...mForm, address: e.target.value })} className={ic} placeholder="ì£¼ì†Œ" />
                                <div className="grid grid-cols-2 gap-2">
                                    <input type="date" required value={mForm.birthdate} onChange={e => setMForm({ ...mForm, birthdate: e.target.value })} className={ic} title="ìƒë…„ì›”ì¼" />
                                    <select value={mForm.gender} onChange={e => setMForm({ ...mForm, gender: e.target.value })} className={ic}><option value="Male">ë‚¨</option><option value="Female">ì—¬</option></select>
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                    <input value={mForm.role} onChange={e => setMForm({ ...mForm, role: e.target.value })} className={ic} placeholder="ì§ë¶„ (ì˜ˆ: ì„±ë„)" />
                                    <input value={mForm.contact} onChange={e => setMForm({ ...mForm, contact: formatPhone(e.target.value) })} className={ic} placeholder="ì—°ë½ì²˜" />
                                </div>
                                <select value={mForm.leader_id} onChange={e => setMForm({ ...mForm, leader_id: e.target.value })} className={ic}>
                                    <option value="">ë¯¸ë°°ì • (ë¦¬ë” ì„ íƒ)</option>
                                    {leaders.map(l => <option key={l.id} value={l.id}>{l.name} ({l.current_members}/{l.max_capacity}ëª…){l.current_members >= l.max_capacity ? ' [ë§Œì„]' : ''}</option>)}
                                </select>
                            </>}
                            <button disabled={saving} className="w-full bg-brand-600 text-white py-2 rounded-lg font-bold">{saving ? 'ì €ì¥ì¤‘...' : 'ë“±ë¡'}</button>
                        </form>
                    )}
                </div>

                {/* ì˜¤ë¥¸ìª½: ë¦¬ìŠ¤íŠ¸ (ë¦¬ë”/ìˆœì› íƒ­) */}
                <div className="lg:col-span-2 bg-white rounded-2xl border flex flex-col h-[600px]">
                    <div className="px-4 py-3 border-b bg-slate-50 space-y-3">
                        {/* íƒ­ + ê²€ìƒ‰ */}
                        <div className="flex items-center justify-between gap-4">
                            <div className="flex bg-slate-200 p-0.5 rounded-lg flex-wrap">
                                <button onClick={() => setListTab('LEADER')} className={`px-3 py-1 text-sm font-medium rounded ${listTab === 'LEADER' ? 'bg-white text-brand-600' : 'text-slate-500'}`}>ë¦¬ë” ({leaders.length})</button>
                                <button onClick={() => setListTab('ASSIGNED')} className={`px-3 py-1 text-sm font-medium rounded ${listTab === 'ASSIGNED' ? 'bg-white text-blue-600' : 'text-slate-500'}`}>ë°°ì • ({members.filter(m => m.leader_id).length})</button>
                                <button onClick={() => setListTab('UNASSIGNED')} className={`px-3 py-1 text-sm font-medium rounded ${listTab === 'UNASSIGNED' ? 'bg-white text-purple-600' : 'text-slate-500'}`}>ë¯¸ë°°ì • ({members.filter(m => !m.leader_id).length})</button>
                            </div>
                            <div className="flex gap-2 flex-wrap">
                                <button onClick={() => setShowDupCheck(true)} className="text-xs bg-red-50 text-red-600 px-3 py-1 rounded border border-red-200 hover:bg-red-100 font-medium">ğŸ” ì¤‘ë³µê²€ì‚¬</button>
                                {listTab === 'LEADER' && <button onClick={exportLeadersCSV} className="text-xs bg-green-50 text-green-700 px-3 py-1 rounded border border-green-200">ğŸ“¥ ë¦¬ë” CSV</button>}
                                {(listTab === 'ASSIGNED' || listTab === 'UNASSIGNED') && <button onClick={exportMembersCSV} className="text-xs bg-green-50 text-green-700 px-3 py-1 rounded border border-green-200">ğŸ“¥ ì†Œì†ì› CSV</button>}
                                {listTab === 'LEADER' && <button onClick={deleteAllLeaders} disabled={processing} className="text-xs bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 disabled:opacity-50">ğŸ—‘ï¸ ë¦¬ë” ì „ì²´ì‚­ì œ</button>}
                                {listTab === 'ASSIGNED' && <button onClick={deleteAllMembers} disabled={processing} className="text-xs bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 disabled:opacity-50">ğŸ—‘ï¸ ì†Œì†ì› ì „ì²´ì‚­ì œ</button>}
                                {listTab === 'UNASSIGNED' && <button onClick={deleteAllUnassigned} disabled={processing} className="text-xs bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 disabled:opacity-50">ğŸ—‘ï¸ ë¯¸ë°°ì • ì „ì²´ì‚­ì œ</button>}
                                <button onClick={loadData} className="text-xs bg-white px-2 py-1 rounded border">ìƒˆë¡œê³ ì¹¨</button>
                            </div>
                        </div>
                        {/* ê²€ìƒ‰ì°½ + ì •ë ¬ */}
                        <div className="flex gap-2 items-center">
                            <input
                                type="text"
                                value={searchQuery}
                                onChange={e => setSearchQuery(e.target.value)}
                                placeholder="ğŸ” ì´ë¦„, ì—°ë½ì²˜, ì£¼ì†Œë¡œ ê²€ìƒ‰..."
                                className="flex-1 text-sm border rounded-lg px-3 py-2"
                            />
                            <div className="flex bg-slate-100 p-0.5 rounded text-xs">
                                <button onClick={() => setSortBy('name')} className={`px-2 py-1 rounded ${sortBy === 'name' ? 'bg-white text-brand-600 font-bold' : 'text-slate-500'}`}>ì´ë¦„ìˆœ</button>
                                <button onClick={() => setSortBy('age')} className={`px-2 py-1 rounded ${sortBy === 'age' ? 'bg-white text-brand-600 font-bold' : 'text-slate-500'}`}>ë‚˜ì´ìˆœ</button>
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 overflow-auto">
                        {listTab === 'LEADER' ? (
                            filteredLeaders.length === 0 ? <div className="p-8 text-center text-slate-400"><div className="text-4xl mb-2">ğŸ‘¤</div><div className="font-medium">ë“±ë¡ëœ ë¦¬ë”ê°€ ì—†ìŠµë‹ˆë‹¤</div><div className="text-sm mt-1">ì¢Œì¸¡ì—ì„œ ë¦¬ë”ë¥¼ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.</div></div> :
                                filteredLeaders.map(l => (
                                    <div key={l.id} onClick={() => setSelected(l)} className="p-4 border-b hover:bg-slate-50 cursor-pointer flex justify-between">
                                        <div>
                                            <b>{genderIcon(l.gender)} {l.name}</b> <span className="text-xs text-slate-500">{formatRole(l.role)} Â· {calcAge(l.birthdate)}ì„¸ ({formatBirthdate(l.birthdate)})</span>
                                            {l.contact && <span className="text-xs text-slate-400 ml-2">ğŸ“ {l.contact}</span>}
                                            <div className="text-sm text-slate-500">{l.address}</div>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className={`text-xs px-2 py-1 rounded-full ${l.current_members >= l.max_capacity ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>{l.current_members}/{l.max_capacity}</span>
                                            <button onClick={e => openEdit(l, 'leader', e)} className="text-slate-400 hover:text-brand-600">âœï¸</button>
                                            <button onClick={e => delLeader(l.id, e)} className="text-slate-400 hover:text-red-600">ğŸ—‘ï¸</button>
                                        </div>
                                    </div>
                                ))
                        ) : listTab === 'ASSIGNED' ? (
                            /* ì†Œì†ë¨ íƒ­ (ë¦¬ë”ì—ê²Œ ë°°ì •ëœ ìˆœì›) */
                            (() => {
                                const assigned = sortItems(members.filter(m => m.leader_id).filter(m => {
                                    const q = searchQuery.toLowerCase();
                                    return m.name?.toLowerCase().includes(q) || m.contact?.toLowerCase().includes(q) || m.address?.toLowerCase().includes(q);
                                }));
                                return assigned.length === 0 ? <div className="p-8 text-center text-slate-400"><div className="text-4xl mb-2">ğŸ‘¥</div><div className="font-medium">ë°°ì •ëœ ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤</div></div> :
                                    assigned.map(m => (
                                        <div key={m.id} className="p-4 border-b hover:bg-blue-50 flex justify-between bg-blue-50/20">
                                            <div>
                                                <b>{genderIcon(m.gender)} {m.name}</b> <span className="text-xs text-slate-500">{formatRole(m.role)} Â· {calcAge(m.birthdate)}ì„¸ ({formatBirthdate(m.birthdate)})</span>
                                                {m.contact && <span className="text-xs text-slate-400 ml-2">ğŸ“ {m.contact}</span>}
                                                <div className="text-sm text-slate-500">{m.address}</div>
                                                <div className="text-xs mt-1">
                                                    <span className="px-2 py-0.5 rounded bg-blue-100 text-blue-700">ğŸ‘¤ {getLeaderName(m.leader_id)}</span>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <button onClick={e => promoteToLeader(m, e)} className="text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded hover:bg-amber-200" title="ë¦¬ë”ë¡œ ì„¸ìš°ê¸°">ğŸ‘‘</button>
                                                <button onClick={e => openEdit(m, 'member', e)} className="text-slate-400 hover:text-brand-600">âœï¸</button>
                                                <button onClick={e => delMember(m.id, e)} className="text-slate-400 hover:text-red-600">ğŸ—‘ï¸</button>
                                            </div>
                                        </div>
                                    ))
                            })()
                        ) : (
                            /* ë¯¸ë°°ì • íƒ­ */
                            (() => {
                                const unassigned = sortItems(members.filter(m => !m.leader_id).filter(m => {
                                    const q = searchQuery.toLowerCase();
                                    return m.name?.toLowerCase().includes(q) || m.contact?.toLowerCase().includes(q) || m.address?.toLowerCase().includes(q);
                                }));
                                return unassigned.length === 0 ? (
                                    <div className="text-center text-slate-400 py-8">ë¯¸ë°°ì • ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤</div>
                                ) : unassigned.map(m => (
                                    <div key={m.id} className="p-3 border-b hover:bg-slate-50 flex justify-between items-start">
                                        <div className="flex-1 min-w-0">
                                            <div className="flex items-center gap-2 flex-wrap">
                                                <b className="truncate">{genderIcon(m.gender)} {m.name}</b>
                                                <span className="text-xs text-slate-500">{calcAge(m.birthdate)}ì„¸</span>
                                            </div>
                                            <div className="text-xs text-slate-400 truncate">{m.address}</div>
                                        </div>
                                        <div className="flex items-center gap-1 ml-2">
                                            <button onClick={(e) => promoteToLeader(m, e)} className="text-xs bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded hover:bg-amber-200" title="ë¦¬ë”ë¡œ ì„¸ìš°ê¸°">ğŸ‘‘</button>
                                            <button onClick={(e) => { e.stopPropagation(); openEdit(m, 'member'); }} className="text-slate-400 hover:text-brand-600 text-sm">âœï¸</button>
                                            <button onClick={(e) => delMember(m.id, e)} className="text-slate-400 hover:text-red-600 text-sm">ğŸ—‘ï¸</button>
                                        </div>
                                    </div>
                                ));
                            })()
                        )}
                    </div>
                </div>
            </div>)
        };

        // ë©¤ë²„ì—ê²Œ ì í•©í•œ ë¦¬ë” ì¶”ì²œ (ì¹´í…Œê³ ë¦¬ë³„)
        const findBestLeaders = (member, leaders, category, topN = 5) => {
            if (!member || !member.lat || !member.lng) return [];

            const candidates = leaders.filter(l => l.lat && l.lng).map(l => {
                const dist = getDistance(member.lat, member.lng, l.lat, l.lng);
                const ageDiff = Math.abs(calcAge(l.birthdate || '1980-01-01') - calcAge(member.birthdate || '2000-01-01'));
                const score = dist + (ageDiff / 20);
                return { ...l, distance: dist, ageDiff, score };
            });

            return candidates.sort((a, b) => a.score - b.score).slice(0, topN);
        };

        // ë¦¬ë” ëª¨ì§‘ ëª¨ë‹¬ (ê³µìš©)
        const RecruitmentModal = ({ leader, members, leaders, onClose, onAssign }) => {
            const [candidates, setCandidates] = useState({ unassigned: [], assigned: [] });

            useEffect(() => {
                setCandidates(findRecruits(leader, members, 5)); // 5ëª…ì”© ì¶”ì²œìœ¼ë¡œ ë³€ê²½
            }, [leader, members]);

            const CandidateRow = ({ m, type }) => (
                <div className="flex justify-between items-center p-2 hover:bg-slate-50 border-b border-slate-100 last:border-0">
                    <div>
                        <div className="flex items-center gap-2">
                            <b>{m.name}</b>
                            <span className="text-xs text-slate-500">{m.role}Â·{calcAge(m.birthdate)}ì„¸</span>
                            {type === 'assigned' && <span className="text-[10px] bg-sky-100 text-sky-700 px-1 rounded">í˜„: {leaders.find(l => l.id === m.leader_id)?.name}</span>}
                        </div>
                        <div className="text-[10px] text-slate-400 mt-0.5">
                            {Number(m.distance).toFixed(1)}km Â· ë‚˜ì´ì°¨ {m.ageDiff}ì„¸ Â· {m.address}
                        </div>
                    </div>
                    <button
                        onClick={() => onAssign(m)}
                        className="bg-blue-50 text-blue-600 hover:bg-blue-100 w-12 py-1.5 rounded text-xs font-bold transition-colors flex-none flex items-center justify-center"
                    >
                        ì´ë™
                    </button>
                </div>
            )

            return (
                <div className="fixed inset-0 bg-black/50 z-[9999] flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="bg-gradient-to-r from-blue-600 to-indigo-600 p-4 text-white flex justify-between items-center">
                            <h2 className="font-bold text-lg">ğŸ“¢ {leader.name} ë¦¬ë”ì› ëª¨ì§‘ ì¶”ì²œ</h2>
                            <button onClick={onClose} className="text-white/70 hover:text-white text-2xl">&times;</button>
                        </div>
                        {(!leader.lat || !leader.lng) && (
                            <div className="bg-amber-50 border-b border-amber-200 px-4 py-2 text-amber-800 text-xs">
                                âš ï¸ ë¦¬ë”ì˜ ìœ„ì¹˜ ì •ë³´ê°€ ì—†ì–´ ê±°ë¦¬ ê¸°ë°˜ ì¶”ì²œì´ ë¶ˆì™„ì „í•©ë‹ˆë‹¤. ë¦¬ë” ì •ë³´ ìˆ˜ì •ì—ì„œ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
                            </div>
                        )}
                        <div className="p-4 max-h-[70vh] overflow-y-auto">
                            <div className="mb-6">
                                <h3 className="text-sm font-bold text-red-600 border-b border-red-100 pb-2 mb-2 flex items-center gap-2">
                                    <span className="bg-red-100 px-2 py-0.5 rounded-full text-[10px]">1ìˆœìœ„</span> ë¯¸ë°°ì • ì¸ì› ì¶”ì²œ
                                </h3>
                                {candidates.unassigned.length === 0 ? <p className="text-center text-slate-400 text-xs py-4">ì¶”ì²œí•  ë¯¸ë°°ì • ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤ (ê±°ë¦¬/ìœ„ì¹˜í™•ì¸)</p> :
                                    candidates.unassigned.map(m => <CandidateRow key={m.id} m={m} type="unassigned" />)
                                }
                            </div>

                            <div>
                                <h3 className="text-sm font-bold text-sky-600 border-b border-sky-100 pb-2 mb-2 flex items-center gap-2">
                                    <span className="bg-sky-100 px-2 py-0.5 rounded-full text-[10px]">2ìˆœìœ„</span> íƒ€ ê·¸ë£¹ ì¸ì› ì¶”ì²œ (ì´ë™/êµí™˜)
                                </h3>
                                {candidates.assigned.length === 0 ? <p className="text-center text-slate-400 text-xs py-4">ì¶”ì²œí•  ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤</p> :
                                    candidates.assigned.map(m => <CandidateRow key={m.id} m={m} type="assigned" />)
                                }
                            </div>
                        </div>
                    </div>
                </div>
            )
        }

        // ë©¤ë²„ ë°°ì • ì¶”ì²œ ëª¨ë‹¬ (PlacementModal)
        const PlacementModal = ({ member, leaders, getGroupOrder, onClose, onAssign }) => {
            const [activeTab, setActiveTab] = useState(0); // 0: ì¼ë°˜, 1: ì§ì¥, 2: ê´€ë¦¬, 3: ë‚¨ì„± (ìˆœì„œ ì£¼ì˜: index.htmlì˜ getGroupOrderì™€ ì¼ì¹˜í•´ì•¼í•¨)
            const [recommendations, setRecommendations] = useState([]);

            useEffect(() => {
                if (!member) return;
                // ì„ íƒëœ íƒ­(category)ì— í•´ë‹¹í•˜ëŠ” ë¦¬ë” í•„í„°ë§
                const filteredLeaders = leaders.filter(l => getGroupOrder(l) === activeTab);
                const best = findBestLeaders(member, filteredLeaders, activeTab, 5);
                setRecommendations(best);
            }, [member, leaders, activeTab, getGroupOrder]);

            return (
                <div className="fixed inset-0 bg-black/50 z-[9999] flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="bg-gradient-to-r from-emerald-600 to-teal-600 p-4 text-white flex justify-between items-center">
                            <h2 className="font-bold text-lg">âœ¨ {member.name}ë‹˜ì—ê²Œ ì í•©í•œ ë¦¬ë” ì¶”ì²œ</h2>
                            <button onClick={onClose} className="text-white/70 hover:text-white text-2xl">&times;</button>
                        </div>

                        <div className="flex border-b border-slate-200">
                            {[
                                { id: 0, label: 'ì¼ë°˜' },
                                { id: 1, label: 'ì§ì¥' },
                                { id: 2, label: 'ê´€ë¦¬' },
                                { id: 3, label: 'ë‚¨ì„±' },
                            ].map(tab => (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`flex-1 py-3 text-sm font-bold transition-colors border-b-2 
                                         ${activeTab === tab.id ? 'border-emerald-600 text-emerald-700 bg-emerald-50' : 'border-transparent text-slate-500 hover:bg-slate-50'}
                                     `}
                                >
                                    {tab.label}
                                </button>
                            ))}
                        </div>

                        <div className="p-4 max-h-[60vh] overflow-y-auto bg-slate-50">
                            {(!member.lat || !member.lng) && (
                                <div className="bg-amber-50 border border-amber-200 px-4 py-2 text-amber-800 text-xs rounded mb-3">
                                    âš ï¸ ë©¤ë²„ì˜ ìœ„ì¹˜ ì •ë³´ê°€ ì—†ì–´ ê±°ë¦¬ ê¸°ë°˜ ì¶”ì²œì´ ë¶ˆì™„ì „í•©ë‹ˆë‹¤.
                                </div>
                            )}

                            {recommendations.length === 0 ? (
                                <div className="text-center py-8 text-slate-400">
                                    ì¶”ì²œí•  ë¦¬ë”ê°€ ì—†ìŠµë‹ˆë‹¤.
                                </div>
                            ) : (
                                <div className="space-y-2">
                                    {recommendations.map(leader => (
                                        <div key={leader.id} className="bg-white p-3 rounded-lg border border-slate-200 shadow-sm flex justify-between items-center hover:shadow-md transition-shadow">
                                            <div>
                                                <div className="flex items-center gap-2">
                                                    <span className="font-bold text-slate-700">{leader.name}</span>
                                                    <span className={`text-xs px-1.5 py-0.5 rounded ${leader.current_members >= leader.max_capacity ? 'bg-red-100 text-red-600' : 'bg-emerald-100 text-emerald-600'}`}>
                                                        {leader.current_members || 0}/{leader.max_capacity || 5}ëª…
                                                    </span>
                                                </div>
                                                <div className="text-xs text-slate-400 mt-1">
                                                    {leader.address || 'ì£¼ì†Œì—†ìŒ'} Â· {Number(leader.distance).toFixed(1)}km Â· ë‚˜ì´ì°¨ {leader.ageDiff}ì„¸
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => onAssign(member, leader)}
                                                className="bg-emerald-50 text-emerald-600 hover:bg-emerald-100 hover:text-emerald-700 w-16 py-1.5 rounded text-xs font-bold transition-colors flex-none flex items-center justify-center"
                                            >
                                                ë°°ì •
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };




        const MemberMatching = ({ globalData, onRefresh, setGlobalData, setSyncing }) => {
            const getStoredForm = () => { try { const s = sessionStorage.getItem('MATCH_FORM'); return s ? JSON.parse(s) : null } catch { return null } };
            const [form, setForm] = useState(() => getStoredForm() || { name: '', role: 'ì„±ë„', birthdate: '', gender: 'Male', address: '' }), [loading, setLoading] = useState(false), [candidates, setCandidates] = useState([]), [target, setTarget] = useState(null), [selId, setSelId] = useState(null); const mapRef = useRef(null), mapInst = useRef(null), markers = useRef([]);
            // const [showUnassigned, setShowUnassigned] = useState(false); // Removed: Always visible in footer
            // const [unassignedList, setUnassignedList] = useState([]); // Derived directly from globalData
            const [selectedMemberId, setSelectedMemberId] = useState(null);
            const [unassignedSort, setUnassignedSort] = useState('name'); // 'name' | 'age'

            const leaders = globalData?.leaders || [];
            const allMembers = globalData?.members || [];

            // Calculate and sort unassigned list (ì°¸ì—¬í¬ë§ë§Œ í‘œì‹œ)
            const unassignedList = useMemo(() => {
                const list = allMembers.filter(m => !m.leader_id && (m.status || 'wants_group') === 'wants_group');
                return list.sort((a, b) => {
                    if (unassignedSort === 'name') return (a.name || '').localeCompare(b.name || '');
                    if (unassignedSort === 'age') return (a.birthdate || '').localeCompare(b.birthdate || ''); // Birthdate string compare works for YYYY-MM-DD (older first)
                    return 0;
                });
            }, [allMembers, unassignedSort]);

            useEffect(() => { sessionStorage.setItem('MATCH_FORM', JSON.stringify(form)) }, [form]);
            useEffect(() => { if (mapRef.current && window.google && !mapInst.current) mapInst.current = new window.google.maps.Map(mapRef.current, { center: { lat: 37.5665, lng: 126.9780 }, zoom: 12, disableDefaultUI: true, zoomControl: true, styles: MAP_STYLES }) }, []);
            useEffect(() => {
                if (!mapInst.current || !window.google) return;
                markers.current.forEach(m => m.setMap(null));
                markers.current = [];
                const bounds = new window.google.maps.LatLngBounds();

                // ì‹ ê·œ/ê²€ìƒ‰ ìœ„ì¹˜ ë§ˆì»¤
                if (target) {
                    const m = new window.google.maps.Marker({
                        position: target,
                        map: mapInst.current,
                        animation: window.google.maps.Animation.DROP,
                        icon: { path: window.google.maps.SymbolPath.CIRCLE, fillColor: '#dc2626', fillOpacity: 1, strokeColor: '#fff', strokeWeight: 2, scale: 12 }
                    });
                    const info = new window.google.maps.InfoWindow({ content: '<div style="padding:8px;font-family:sans-serif"><b style="color:#dc2626">ğŸ“ ì‹ ê·œ ì¸ì› ìœ„ì¹˜</b></div>' });
                    m.addListener('mouseover', () => info.open(mapInst.current, m));
                    m.addListener('mouseout', () => info.close());
                    markers.current.push(m);
                    bounds.extend(target);
                }

                // ì¶”ì²œ ë¦¬ë”(Candidates) ë§ˆì»¤
                candidates.forEach((l, i) => {
                    const full = l.current_members >= l.max_capacity;
                    const m = new window.google.maps.Marker({
                        position: { lat: l.lat, lng: l.lng },
                        map: mapInst.current,
                        icon: { path: window.google.maps.SymbolPath.CIRCLE, fillColor: full ? '#94a3b8' : '#3b82f6', fillOpacity: 1, strokeColor: '#fff', strokeWeight: 2, scale: 12 },
                        label: { text: String(i + 1), color: '#fff', fontSize: '11px', fontWeight: 'bold' }
                    });
                    const info = new window.google.maps.InfoWindow({
                        content: `<div style="padding:10px;font-family:sans-serif;min-width:180px"><div style="font-size:15px;font-weight:bold;color:#1e40af;margin-bottom:4px">${l.name} ${l.role}</div><div style="font-size:12px;color:#64748b">${calcAge(l.birthdate)}ì„¸ Â· ${['male', 'ë‚¨', 'ë‚¨ì„±', 'm'].some(v => String(l.gender || '').toLowerCase().includes(v)) ? 'ë‚¨ì„±' : 'ì—¬ì„±'}</div><div style="font-size:11px;color:#94a3b8;margin:6px 0;padding-top:6px;border-top:1px solid #e2e8f0">${l.address}</div><div style="display:flex;gap:8px;font-size:12px"><span style="background:${full ? '#fee2e2' : '#dcfce7'};color:${full ? '#dc2626' : '#16a34a'};padding:2px 8px;border-radius:4px;font-weight:600">ì •ì›: ${l.current_members}/${l.max_capacity}ëª…</span><span style="background:#f1f5f9;padding:2px 8px;border-radius:4px">ê±°ë¦¬: ${l.distance.toFixed(1)}km</span></div></div>`
                    });
                    m.addListener('mouseover', () => info.open(mapInst.current, m));
                    m.addListener('mouseout', () => info.close());
                    m.addListener('click', () => { info.open(mapInst.current, m); setSelId(l.id); });
                    markers.current.push(m);
                    bounds.extend({ lat: l.lat, lng: l.lng });
                });

                if (target || candidates.length) {
                    mapInst.current.fitBounds(bounds);
                    window.google.maps.event.addListenerOnce(mapInst.current, 'idle', () => { if (mapInst.current.getZoom() > 15) mapInst.current.setZoom(15); });
                }
            }, [candidates, target]);

            // ë¯¸ë°°ì • ì¸ì› ì„ íƒ
            const selectUnassigned = async (member) => {
                setSelectedMemberId(member.id);
                setForm({ name: member.name, role: member.role || 'ì„±ë„', birthdate: formatBirthdate(member.birthdate), gender: normalizeGender(member.gender), address: member.address || '' });
                // setShowUnassigned(false); // Removed
                // ìë™ìœ¼ë¡œ ë¦¬ë” ê²€ìƒ‰ (Direct Action)
                if (member.address && member.birthdate) {
                    setLoading(true); setCandidates([]);
                    try {
                        // Optimizing: Use local 'leaders' data instead of fetching
                        // const leaders = await fetchLeaders();

                        if (member.lat && member.lng) {
                            setTarget({ lat: member.lat, lng: member.lng });
                            const res = findClosest(member.lat, member.lng, member.birthdate, leaders, 5);
                            setCandidates(res);
                            if (!res.length) alert("ë¦¬ë” ì—†ìŒ");
                        } else {
                            const geo = await geocodeAddress(member.address);
                            setTarget({ lat: geo.lat, lng: geo.lng });
                            const res = findClosest(geo.lat, geo.lng, member.birthdate, leaders, 5);
                            setCandidates(res);
                            if (!res.length) alert("ë¦¬ë” ì—†ìŒ");
                        }
                    } catch (e) { alert(e.message); }
                    finally { setLoading(false); }
                }
            };

            const search = async e => { e?.preventDefault(); if (!form.address || !form.birthdate) { alert("ì£¼ì†Œ/ìƒë…„ì›”ì¼ í•„ìš”"); return } setLoading(true); setCandidates([]); try { const geo = await geocodeAddress(form.address); setTarget({ lat: geo.lat, lng: geo.lng }); setForm(p => ({ ...p, address: geo.formattedAddress })); const res = findClosest(geo.lat, geo.lng, form.birthdate, leaders, 5); setCandidates(res); if (!res.length) alert("ë¦¬ë” ì—†ìŒ") } catch (e) { alert(e.message) } finally { setLoading(false) } };



            const assign = async () => {
                if (!selId || !target) return;
                const name = candidates.find(c => c.id === selId)?.name;
                if (!confirm(`${form.name}â†’${name} ë°°ì •?`)) return;

                // Optimistic Update
                const backup = { ...globalData };
                const newMember = {
                    id: selectedMemberId || Date.now(), // Temporary ID if new
                    name: form.name, role: form.role, birthdate: form.birthdate,
                    gender: form.gender, address: form.address,
                    lat: target.lat, lng: target.lng, leader_id: selId
                };

                let newMembers = [...allMembers];
                if (selectedMemberId) {
                    newMembers = newMembers.map(m => m.id === selectedMemberId ? newMember : m);
                } else {
                    newMembers.push(newMember);
                }

                const newLeaders = leaders.map(l => String(l.id) === String(selId) ? { ...l, current_members: (l.current_members || 0) + 1 } : l);

                setGlobalData({ ...globalData, members: newMembers, leaders: newLeaders });
                setLoading(true);
                setSyncing?.(true);

                try {
                    if (selectedMemberId) {
                        await updateMember(selectedMemberId, { leader_id: selId });
                    } else {
                        await insertMember(newMember);
                    }
                    // alert("ì™„ë£Œ"); // No alert for speed
                    setForm({ name: '', role: 'ì„±ë„', birthdate: '', gender: 'Male', address: '' });
                    setCandidates([]); setTarget(null); setSelId(null); setSelectedMemberId(null);
                    // onRefresh?.(); // Skip refresh
                } catch (e) {
                    alert(e.message);
                    setGlobalData(backup); // Revert
                } finally {
                    setLoading(false);
                    setSyncing?.(false);
                }
            };

            const assignUnassigned = async () => {
                if (!form.name || !form.birthdate) { alert("ì´ë¦„/ìƒë…„ì›”ì¼ í•„ìš”"); return; }
                if (!confirm(`${form.name}ë‹˜ì„ ë¯¸ë°°ì •ìœ¼ë¡œ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

                // Optimistic Logic
                const backup = { ...globalData };
                let lat = target?.lat, lng = target?.lng;

                // Note: Geocoding is sync-blocking if we need it for optimistic update.
                // Alternatively, we optimistically add without coords first, or clear coords if not provided.
                // For simplicity, we'll try to use what we have or placeholder.
                // Real coordinate fetch happens in background is harder, so we just wait for explicit geocoding in 'search' usually.
                // If user didn't search, we might not have lat/lng. Optimistic update might lack lat/lng.
                // We will rely on server response/refresh for full consistency, but updating list immediately.

                const newMember = {
                    id: selectedMemberId || Date.now(),
                    name: form.name, role: form.role, birthdate: form.birthdate,
                    gender: form.gender, address: form.address,
                    lat: lat || 0, lng: lng || 0, leader_id: ''
                };

                let newMembers = [...allMembers];
                if (selectedMemberId) {
                    newMembers = newMembers.map(m => m.id === selectedMemberId ? newMember : m);
                } else {
                    newMembers.push(newMember);
                }

                setGlobalData({ ...globalData, members: newMembers });
                setLoading(true);
                setSyncing?.(true);

                try {
                    if (!lat && form.address) {
                        try {
                            const geo = await geocodeAddress(form.address);
                            lat = geo.lat; lng = geo.lng;
                            newMember.lat = lat; newMember.lng = lng; // Refine for accurate insert
                        } catch (e) { console.warn("ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨:", e); }
                    }

                    if (selectedMemberId) {
                        await updateMember(selectedMemberId, {
                            name: form.name, role: form.role, birthdate: form.birthdate,
                            gender: form.gender, address: form.address,
                            lat: lat, lng: lng, leader_id: ''
                        });
                    } else {
                        await insertMember({ ...newMember, lat: lat, lng: lng });
                    }
                    // alert("ë¯¸ë°°ì • ë“±ë¡ ì™„ë£Œ");
                    setForm({ name: '', role: 'ì„±ë„', birthdate: '', gender: 'Male', address: '' });
                    setCandidates([]); setTarget(null); setSelId(null); setSelectedMemberId(null);
                    // onRefresh?.();
                } catch (e) {
                    alert(e.message);
                    setGlobalData(backup);
                } finally {
                    setLoading(false);
                    setSyncing?.(false);
                }
            };

            const ic = "block w-full rounded-lg border bg-slate-50 py-2.5 px-3 text-sm";
            const selectLeader = (leader) => { setSelId(leader.id); if (mapInst.current && window.google) { mapInst.current.panTo({ lat: leader.lat, lng: leader.lng }); mapInst.current.setZoom(14); } };
            return (<div className="pb-12"><div className="grid grid-cols-1 xl:grid-cols-12 gap-6 min-h-[600px]"><div className="xl:col-span-5 space-y-6"><div className="bg-white rounded-2xl border"><div className="px-6 py-4 border-b bg-slate-50 flex justify-between items-center"><b>â‘  ì •ë³´ ì…ë ¥</b></div>
                <form onSubmit={search} className="p-6 space-y-4"><div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-slate-500">ì´ë¦„</label><input required value={form.name} onChange={e => setForm({ ...form, name: e.target.value })} className={ic} /></div><div><label className="text-xs font-bold text-slate-500">ì§ë¶„</label><input value={form.role} onChange={e => setForm({ ...form, role: e.target.value })} className={ic} /></div></div><div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-slate-500">ìƒë…„ì›”ì¼</label><input type="date" required value={form.birthdate} onChange={e => setForm({ ...form, birthdate: e.target.value })} className={ic} /></div><div><label className="text-xs font-bold text-slate-500">ì„±ë³„</label><select value={form.gender} onChange={e => setForm({ ...form, gender: e.target.value })} className={ic}><option value="Male">ë‚¨ì„±</option><option value="Female">ì—¬ì„±</option></select></div></div><div><label className="text-xs font-bold text-slate-500">ì£¼ì†Œ</label><input required value={form.address} onChange={e => setForm({ ...form, address: e.target.value })} className={ic} /></div>
                    <div className="flex gap-2">
                        <button disabled={loading} className="flex-1 bg-brand-600 text-white font-bold py-3 rounded-xl">{loading ? 'ê²€ìƒ‰ì¤‘...' : 'ğŸ” ë¦¬ë” ì°¾ê¸°'}</button>
                        <button type="button" onClick={assignUnassigned} disabled={loading} className="w-24 bg-slate-100 text-slate-600 font-bold py-3 rounded-xl hover:bg-slate-200">ë¯¸ë°°ì • ì €ì¥</button>
                    </div>
                </form></div>{candidates.length > 0 && <div className="bg-white rounded-2xl border animate-fade-in-up"><div className="px-6 py-4 border-b bg-slate-50 flex justify-between items-center"><b>â‘¡ ì¶”ì²œ ê²°ê³¼</b><span className="text-xs text-slate-400">ìƒìœ„ 5ìˆœìœ„</span></div><div className="p-4 space-y-3 max-h-[400px] overflow-y-auto">{candidates.map((l, i) => <div key={l.id} onClick={() => selectLeader(l)} className={`p-4 rounded-xl border cursor-pointer ${selId === l.id ? 'border-brand-500 bg-brand-50 ring-1 ring-brand-500' : 'border-slate-200 hover:border-brand-300'}`}><div className="flex justify-between"><div><div className="flex items-center gap-2"><span className="w-5 h-5 rounded-full bg-brand-100 text-brand-600 text-xs font-bold flex items-center justify-center">{i + 1}</span><b>{l.name}</b><span className="text-xs text-slate-500">{l.role} Â· {calcAge(l.birthdate)}ì„¸</span></div><div className="text-xs text-slate-500 mt-1 ml-7">{l.address}</div><div className="flex gap-2 mt-2 text-xs ml-7"><span className={`px-2 py-1 rounded ${l.current_members >= l.max_capacity ? 'bg-red-50 text-red-600' : 'bg-slate-100'}`}>{l.current_members}/{l.max_capacity}ëª…</span><span className="px-2 py-1 rounded bg-slate-100">ë‚˜ì´ì°¨ {l.ageDiff}ì‚´</span></div></div><div className="text-right"><span className="text-xl font-black text-brand-600">{l.distance.toFixed(1)}<span className="text-xs text-slate-400">km</span></span>{selId === l.id && <div className="text-brand-600 mt-1">âœ“</div>}</div></div></div>)}</div><div className="p-4 border-t bg-slate-50"><button onClick={assign} disabled={!selId || loading} className="w-full bg-green-600 text-white font-bold py-3 rounded-xl disabled:bg-slate-300">âœ“ ë°°ì •</button></div></div>}</div>

                <div className="xl:col-span-7 space-y-6">
                    {/* Map Card */}
                    <div className="bg-white rounded-2xl border overflow-hidden h-[400px] xl:h-[500px] shadow-sm"><div ref={mapRef} className="w-full h-full bg-slate-100" /></div>

                    {/* Unassigned List Card */}
                    <div className="bg-white rounded-2xl border p-5 shadow-sm">
                        <div className="flex justify-between items-center mb-4">
                            <div className="text-base font-bold text-slate-700 flex items-center gap-2">
                                <span>ğŸ“‹</span> ë¯¸ë°°ì • ì¸ì› ({unassignedList.length})
                            </div>
                            <div className="flex bg-slate-100 rounded-lg p-1">
                                <button onClick={() => setUnassignedSort('name')} className={`px-3 py-1 text-xs rounded-md transition-all font-bold ${unassignedSort === 'name' ? 'bg-white shadow text-slate-700' : 'text-slate-400 hover:text-slate-600'}`}>ì´ë¦„ìˆœ</button>
                                <button onClick={() => setUnassignedSort('age')} className={`px-3 py-1 text-xs rounded-md transition-all font-bold ${unassignedSort === 'age' ? 'bg-white shadow text-slate-700' : 'text-slate-400 hover:text-slate-600'}`}>ìƒë…„ì›”ì¼ìˆœ</button>
                            </div>
                        </div>
                        {unassignedList.length === 0 ? (
                            <div className="text-center text-slate-400 text-sm py-4 italic bg-slate-50 rounded-lg">ë¯¸ë°°ì • ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                        ) : (
                            <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 max-h-[300px] overflow-y-auto pr-2 scrollbar-thin">
                                {unassignedList.map(m => (
                                    <div key={m.id} onClick={() => selectUnassigned(m)} className={`p-2.5 border rounded-lg cursor-pointer hover:bg-slate-50 hover:shadow-sm transition-all flex flex-col gap-1 ${selectedMemberId === m.id ? 'bg-amber-50 border-amber-300 ring-1 ring-amber-300' : 'border-slate-100'}`}>
                                        <div className="flex justify-between items-center">
                                            <b className="text-sm text-slate-700 truncate">{m.name}</b>
                                            <span className="text-xs text-slate-400">{formatRole(m.role)}</span>
                                        </div>
                                        <div className="text-[10px] text-slate-400 flex justify-between">
                                            <span>{genderIcon(m.gender)} {calcAge(m.birthdate)}ì„¸</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div></div></div>)
        };

        const Dashboard = ({ globalData, onRefresh, setGlobalData }) => {
            // ì§€ë„ ê´€ë ¨ ìƒíƒœ
            const mapRef = useRef(null);
            const mapInst = useRef(null);
            const markers = useRef([]);
            const polylines = useRef([]);
            const memberMarkersMap = useRef({}); // { memberId: markerInstance }
            const leaderMemberGroupMarkers = useRef({}); // { leaderId: [memberMarkerInstance] }
            const [unmappedCount, setUnmappedCount] = useState(0); // ìœ„ì¹˜ ì •ë³´ ì—†ëŠ” ë¯¸ë°°ì • ì¸ì› ìˆ˜
            const allData = useRef({ leaders: [], members: [] });
            const [loading, setLoading] = useState(false), [stats, setStats] = useState({ leaderCount: 0, memberCount: 0, unassignedCount: 0, occupancyRate: 0, ageGroups: {}, genderRatio: { male: 0, female: 0 } });
            const [dongStats, setDongStats] = useState({});
            const [searchQuery, setSearchQuery] = useState(''), [searchResults, setSearchResults] = useState([]), [showResults, setShowResults] = useState(false);
            // ë¦¬ë” í´ë¦­ ì‹œ ìˆœì› í‘œì‹œìš©
            const [selectedLeader, setSelectedLeader] = useState(null);
            const selectedLeaderRef = useRef(null);  // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ì—ì„œ ìµœì‹ ê°’ ì°¸ì¡°ìš©
            const [leaderMembers, setLeaderMembers] = useState([]);
            const [memberSortBy, setMemberSortBy] = useState('name'); // 'name' | 'age'
            const [editItem, setEditItem] = useState(null);
            const [editType, setEditType] = useState(null);
            const [mapInitialized, setMapInitialized] = useState(false);
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [geocodeProgress, setGeocodeProgress] = useState(null); // { current, total } ì¼ê´„ ê°±ì‹  ì§„í–‰ë¥ 

            // selectedLeader ë³€ê²½ ì‹œ refë„ ë™ê¸°í™”
            useEffect(() => { selectedLeaderRef.current = selectedLeader; }, [selectedLeader]);

            // í†µì¼ëœ ìˆœì› ê¸°ë³¸ ìƒ‰ìƒ
            const MEMBER_DEFAULT_COLOR = '#14b8a6';
            const MEMBER_UNASSIGNED_COLOR = '#ef4444';
            const HIGHLIGHT_COLOR = '#fbbf24';

            // globalData ë³€ê²½ ì‹œ í†µê³„ ë° ì§€ë„ ì—…ë°ì´íŠ¸
            useEffect(() => {
                if (!globalData?.loaded) return;
                const leaders = globalData.leaders || [];
                const members = globalData.members || [];
                allData.current = { leaders, members };

                const un = members.filter(m => !m.leader_id).length;
                const cap = leaders.reduce((s, l) => s + (l.max_capacity || 0), 0);
                const occ = cap > 0 ? Math.round((members.length - un) / cap * 100) : 0;
                const ag = { '20ëŒ€': 0, '30ëŒ€': 0, '40ëŒ€': 0, '50ëŒ€': 0, '60ëŒ€+': 0 };
                const gr = { male: 0, female: 0 };
                members.forEach(m => {
                    const a = calcAge(m.birthdate);
                    if (a < 30) ag['20ëŒ€']++; else if (a < 40) ag['30ëŒ€']++; else if (a < 50) ag['40ëŒ€']++; else if (a < 60) ag['50ëŒ€']++; else ag['60ëŒ€+']++;
                    const g = String(m.gender || '').toLowerCase();
                    if (g === 'male' || g === 'm' || g === 'ë‚¨' || g === 'ë‚¨ì„±') gr.male++;
                    else if (g === 'female' || g === 'f' || g === 'ì—¬' || g === 'ì—¬ì„±') gr.female++;
                });
                setStats({ leaderCount: leaders.length, memberCount: members.length, unassignedCount: un, occupancyRate: occ, ageGroups: ag, genderRatio: gr });

                // ë™ë³„ ì¸ì› í†µê³„ ê³„ì‚°
                const dongCounts = {};
                [...leaders, ...members].forEach(p => {
                    if (!p.address) return;
                    // ì£¼ì†Œì—ì„œ ë™/ë¦¬ ì¶”ì¶œ (ì˜ˆ: "ì—­ì‚¼ë™", "ì°½ìš°ë™", "ì„œì´ˆë™")
                    const match = p.address.match(/([\uac00-\ud7af]+[ë™ë¦¬ìŒë©´])/);
                    if (match) {
                        const dong = match[1];
                        dongCounts[dong] = (dongCounts[dong] || 0) + 1;
                    }
                });
                setDongStats(dongCounts);

                // ì§€ë„ ì´ˆê¸°í™”/ì—…ë°ì´íŠ¸
                if (leaders.length > 0 || members.length > 0) {
                    initMap(leaders, members);
                }

                // ì„ íƒëœ ë¦¬ë”ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ìˆœì› ëª©ë¡ ê°±ì‹ 
                if (selectedLeader) {
                    const updatedLeader = leaders.find(l => String(l.id) === String(selectedLeader.id));
                    if (updatedLeader) {
                        setSelectedLeader(updatedLeader);
                        const updatedMembers = members.filter(m => String(m.leader_id) === String(selectedLeader.id));
                        setLeaderMembers(updatedMembers);
                    } else {
                        setSelectedLeader(null);
                        setLeaderMembers([]);
                    }
                }
            }, [globalData]);

            // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ í•¸ë“¤ëŸ¬
            const load = () => {
                setLoading(true);
                onRefresh?.();
                setTimeout(() => setLoading(false), 500);
            };

            // ì¼ê´„ ìœ„ì¹˜ ì •ë³´ ê°±ì‹  (ëˆ„ë½ëœ ì¸ì›)
            const fixMissingLocations = async () => {
                const { members } = allData.current;
                const targets = members.filter(m =>
                    m.address &&
                    (!m.lat || !m.lng || m.lat === 0 || m.lng === 0)
                );

                if (targets.length === 0) { alert("ê°±ì‹ í•  ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤."); return; }
                if (!confirm(`${targets.length}ëª…ì˜ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°±ì‹ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì•½ê°„ì˜ ì‹œê°„ì´ ì†Œìš”ë©ë‹ˆë‹¤.`)) return;

                setGeocodeProgress({ current: 0, total: targets.length });
                const backup = { ...globalData };
                let successCount = 0;
                let lastError = null;
                let updatedMembers = [...members];

                // ì¤‘ë‹¨ í”Œë˜ê·¸
                let stopped = false;

                try {
                    for (let i = 0; i < targets.length; i++) {
                        if (stopped) break;
                        const m = targets[i];
                        try {
                            const geo = await geocodeAddress(m.address);
                            // ë¡œì»¬ ì—…ë°ì´íŠ¸
                            updatedMembers = updatedMembers.map(mem => mem.id === m.id ? { ...mem, lat: geo.lat, lng: geo.lng } : mem);
                            setGlobalData(prev => ({ ...prev, members: updatedMembers })); // ì‹¤ì‹œê°„ ë°˜ì˜

                            // ì„œë²„ ì—…ë°ì´íŠ¸
                            await updateMember(m.id, { lat: geo.lat, lng: geo.lng });
                            successCount++;
                        } catch (e) {
                            console.warn(`Geocode fail for ${m.name}:`, e);
                            lastError = e;
                            if (String(e).includes('OVER_QUERY_LIMIT')) {
                                await sleep(2000); // ì¿¨ë‹¤ìš´
                            }
                            if (String(e).includes('REQUEST_DENIED')) {
                                stopped = true; // API ë¯¸í™œì„±í™” ê°€ëŠ¥ì„± -> ì¤‘ë‹¨
                            }
                        }
                        setGeocodeProgress({ current: i + 1, total: targets.length });
                        await sleep(600); // API Rate Limit ë°©ì§€ (ì—¬ìœ ìˆê²Œ ì¦ëŸ‰)
                    }

                    if (successCount === 0 && lastError) {
                        alert(`ê°±ì‹  ì‹¤íŒ¨: ë‹¨ í•œ ëª…ë„ ê°±ì‹ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nì˜¤ë¥˜: ${lastError.message}\n\n[ì²´í¬í¬ì¸íŠ¸]\n1. Google Cloud Consoleì—ì„œ 'Geocoding API'ê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.\n2. API í‚¤ í• ë‹¹ëŸ‰ì´ ì¶©ë¶„í•œì§€ í™•ì¸í•˜ì„¸ìš”.`);
                    } else if (stopped) {
                        alert(`ì¤‘ë‹¨ë¨: ì¼ë¶€ ê°±ì‹  ì‹¤íŒ¨ (${successCount}/${targets.length})\nì˜¤ë¥˜: ${lastError.message}\nAPI í‚¤ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.`);
                    } else {
                        alert(`ì™„ë£Œ: ${successCount}/${targets.length}ëª… ê°±ì‹ ë¨${successCount < targets.length ? `\n(${targets.length - successCount}ëª… ì‹¤íŒ¨: ì£¼ì†Œ ì˜¤ë¥˜ ë“±)` : ''}`);
                    }
                } catch (e) {
                    console.error(e);
                    alert("ì‹œìŠ¤í…œ ì˜¤ë¥˜: " + e.message);
                } finally {
                    setGeocodeProgress(null);
                    // load(); // ìµœì¢… ë¡œë“œëŠ” ìƒëµ (ì„œë²„ ë°˜ì˜ ë”œë ˆì´ë¡œ ì‚¬ë¼ì§ ë°©ì§€)
                }
            };

            // ê²€ìƒ‰ ê¸°ëŠ¥
            const handleSearch = (query) => {
                setSearchQuery(query);
                if (!query.trim()) { setSearchResults([]); setShowResults(false); return; }
                const q = query.toLowerCase();
                const { leaders, members } = allData.current;
                const results = [];
                leaders.forEach(l => { if (l.name?.toLowerCase().includes(q)) results.push({ ...l, type: 'leader' }); });
                members.forEach(m => { if (m.name?.toLowerCase().includes(q)) results.push({ ...m, type: 'member', leaderName: leaders.find(l => l.id === m.leader_id)?.name || 'ë¯¸ë°°ì •' }); });
                setSearchResults(results.slice(0, 10));
                setShowResults(true);
            };

            // ê²€ìƒ‰ ê²°ê³¼ í´ë¦­ ì‹œ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™
            const focusOnResult = (result) => {
                if (!mapInst.current || !result.lat || !result.lng) return;
                mapInst.current.panTo({ lat: result.lat, lng: result.lng });
                mapInst.current.setZoom(17);
                setShowResults(false);
                setSearchQuery('');

                // í•´ë‹¹ ë§ˆì»¤ ì°¾ì•„ì„œ í•˜ì´ë¼ì´íŠ¸
                const marker = markers.current.find(mk => mk.memberData?.id === result.id || mk.leaderData?.id === result.id);
                if (marker) {
                    marker.setAnimation(window.google.maps.Animation.BOUNCE);
                    setTimeout(() => marker.setAnimation(null), 2000);
                }

                // ë¦¬ë”ì¸ ê²½ìš°: ë¦¬ë” ì„ íƒ ëª¨ë“œë¡œ ì „í™˜ (ì‚¬ì´ë“œë°”ì— ìƒì„¸ì •ë³´ í‘œì‹œ)
                if (result.type === 'leader') {
                    selectLeaderOnMap(result);
                }
                // ë©¤ë²„ì¸ ê²½ìš°: ì†Œì† ë¦¬ë”ê°€ ìˆìœ¼ë©´ ê·¸ ë¦¬ë”ë¥¼ ì„ íƒí•˜ì—¬ ê·¸ë£¹ í‘œì‹œ
                else if (result.leader_id) {
                    const leader = allData.current.leaders.find(l => l.id === result.leader_id);
                    if (leader) {
                        selectLeaderOnMap(leader);
                        // ë©¤ë²„ ë§ˆì»¤ ê°•ì¡°
                        setTimeout(() => {
                            if (marker) {
                                marker.setIcon({ path: window.google.maps.SymbolPath.CIRCLE, fillColor: '#ef4444', fillOpacity: 1, strokeColor: '#fff', strokeWeight: 4, scale: 12 });
                                marker.setZIndex(300);
                            }
                        }, 100);
                    }
                }
            };

            // ë¦¬ë” ì„ íƒ ì‹œ ìˆœì› ëª©ë¡ í‘œì‹œ
            const selectLeaderOnMap = async (leader) => {
                setSelectedLeader(leader);
                const members = allData.current.members.filter(m => String(m.leader_id) === String(leader.id));
                setLeaderMembers(members);
                // ì§€ë„ì—ì„œ í•´ë‹¹ ê·¸ë£¹ í•˜ì´ë¼ì´íŠ¸
                if (mapInst.current) {
                    polylines.current.forEach(p => p.setMap(null)); polylines.current = [];
                    markers.current.forEach(mk => { if (mk.originalIcon) mk.setIcon(mk.originalIcon); mk.setZIndex(mk.leaderData ? 100 : 50); });
                    const groupMembers = leaderMemberGroupMarkers.current[leader.id] || [];
                    groupMembers.forEach(memberMk => {
                        memberMk.setIcon({ path: window.google.maps.SymbolPath.CIRCLE, fillColor: HIGHLIGHT_COLOR, fillOpacity: 1, strokeColor: '#f59e0b', strokeWeight: 3, scale: 10 });
                        memberMk.setZIndex(150);
                    });
                    groupMembers.forEach(memberMk => {
                        const line = new window.google.maps.Polyline({
                            path: [{ lat: leader.lat, lng: leader.lng }, memberMk.getPosition()],
                            geodesic: true, strokeColor: HIGHLIGHT_COLOR, strokeOpacity: 0.8, strokeWeight: 2, map: mapInst.current
                        });
                        polylines.current.push(line);
                    });
                }
            };

            const closeLeaderPanel = () => {
                setSelectedLeader(null);
                setLeaderMembers([]);
                polylines.current.forEach(p => p.setMap(null)); polylines.current = [];
                markers.current.forEach(mk => { if (mk.originalIcon) mk.setIcon(mk.originalIcon); mk.setZIndex(mk.leaderData ? 100 : 50); });
            };

            // ì†Œì† ëª…ë‹¨ ì¸ì‡„ í•¨ìˆ˜
            const printMemberList = () => {
                if (!selectedLeader || leaderMembers.length === 0) {
                    alert('ì¸ì‡„í•  ëª…ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const today = new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });

                const printContent = `
                    <div id="print-area" class="print-container">
                        <div class="print-header">
                            <div class="print-title">ğŸ“‹ ${selectedLeader.name} ${formatRole(selectedLeader.role) || ''} ì†Œê·¸ë£¹ ëª…ë‹¨</div>
                            <div class="print-subtitle">${selectedLeader.address || ''} Â· ì •ì› ${selectedLeader.current_members}/${selectedLeader.max_capacity}ëª… Â· ${today}</div>
                        </div>
                        <table class="print-table">
                            <thead>
                                <tr>
                                    <th style="width:8%">ë²ˆí˜¸</th>
                                    <th style="width:15%">ì´ë¦„</th>
                                    <th style="width:12%">ì§ë¶„</th>
                                    <th style="width:10%">ë‚˜ì´</th>
                                    <th style="width:15%">ì—°ë½ì²˜</th>
                                    <th style="width:40%">ì£¼ì†Œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${leaderMembers.map((m, i) => `
                                    <tr>
                                        <td style="text-align:center">${i + 1}</td>
                                        <td><b>${m.name || ''}</b></td>
                                        <td>${formatRole(m.role) || ''}</td>
                                        <td style="text-align:center">${calcAge(m.birthdate)}ì„¸</td>
                                        <td>${m.contact || '-'}</td>
                                        <td style="font-size:12px">${m.address || ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="print-footer">
                            ì†Œê·¸ë£¹ í¸ì„± ë§¤ë‹ˆì € Â· ì¶œë ¥ì¼: ${today}
                        </div>
                    </div>
                `;

                // ì¸ì‡„ ì°½ ìƒì„±
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${selectedLeader.name} ì†Œê·¸ë£¹ ëª…ë‹¨</title>
                        <style>
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif; }
                            .print-container { max-width: 210mm; margin: 0 auto; padding: 15mm; background: white; }
                            .print-header { border-bottom: 2px solid #1e40af; padding-bottom: 12px; margin-bottom: 20px; }
                            .print-title { font-size: 24px; font-weight: bold; color: #1e40af; }
                            .print-subtitle { font-size: 14px; color: #64748b; margin-top: 4px; }
                            .print-table { width: 100%; border-collapse: collapse; }
                            .print-table th { background: #f1f5f9; padding: 10px 8px; text-align: left; font-size: 12px; font-weight: bold; border-bottom: 2px solid #e2e8f0; }
                            .print-table td { padding: 10px 8px; border-bottom: 1px solid #e2e8f0; font-size: 13px; }
                            .print-table tr:nth-child(even) { background: #f8fafc; }
                            .print-footer { margin-top: 30px; text-align: center; font-size: 11px; color: #94a3b8; }
                            @media print { @page { size: A4; margin: 10mm; } }
                        </style>
                    </head>
                    <body>${printContent}</body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => { printWindow.print(); }, 300);
            };

            const openEditMember = (member) => { setEditItem(member); setEditType('member'); };
            const openEditLeader = () => { if (selectedLeader) { setEditItem(selectedLeader); setEditType('leader'); } };

            const handleDelete = async (member) => {
                if (!confirm(`${member.name}ë‹˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                await removeMember(member.id, selectedLeader?.id, 'DELETE');
                await load();
            };

            const handleUnassign = async (member) => {
                if (!confirm(`${member.name}ë‹˜ì„ ê·¸ë£¹ì—ì„œ ì œì™¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                await removeMember(member.id, selectedLeader?.id, 'UNASSIGN');
                await load();
            };

            const onEditUpdate = async () => {
                await load();
            };

            const initMap = (leaders, members) => {
                if (!mapRef.current || !window.google) return;
                if (!mapInst.current) mapInst.current = new window.google.maps.Map(mapRef.current, { center: { lat: 36.5, lng: 127.8 }, zoom: 7, disableDefaultUI: true, zoomControl: true, styles: MAP_STYLES });
                markers.current.forEach(m => m.setMap(null)); markers.current = [];
                polylines.current.forEach(p => p.setMap(null)); polylines.current = [];
                memberMarkersMap.current = {}; // Reset member ID to marker map
                leaderMemberGroupMarkers.current = {}; // Reset leader ID to member markers array map
                const bounds = new window.google.maps.LatLngBounds();

                let missingLocationCount = 0;

                members.forEach(m => {
                    const un = !m.leader_id || String(m.leader_id) === '0' || String(m.leader_id) === '';

                    if (m.lat && m.lng) {
                        const leaderName = un ? 'ë¯¸ë°°ì •' : (leaders.find(l => l.id === m.leader_id)?.name || 'ì•Œìˆ˜ì—†ìŒ');
                        const memberColor = un ? MEMBER_UNASSIGNED_COLOR : MEMBER_DEFAULT_COLOR;
                        const mk = new window.google.maps.Marker({
                            position: { lat: m.lat, lng: m.lng },
                            map: mapInst.current,
                            icon: { path: window.google.maps.SymbolPath.CIRCLE, fillColor: memberColor, fillOpacity: 0.9, strokeColor: '#fff', strokeWeight: 2, scale: un ? 8 : 7 },
                            zIndex: 50
                        });
                        mk.originalIcon = { path: window.google.maps.SymbolPath.CIRCLE, fillColor: memberColor, fillOpacity: 0.9, strokeColor: '#fff', strokeWeight: 2, scale: un ? 8 : 7 };
                        mk.memberData = m;
                        const info = new window.google.maps.InfoWindow({ content: `<div style="padding:8px;font-family:sans-serif;min-width:150px"><div style="font-size:13px;font-weight:bold;color:#334155">${m.name}</div><div style="font-size:11px;color:#64748b">${m.role} Â· ${calcAge(m.birthdate)}ì„¸</div><div style="font-size:10px;color:#94a3b8;margin-top:4px">${m.address}</div><div style="margin-top:6px;font-size:11px;padding:3px 6px;border-radius:4px;display:inline-block;${un ? 'background:#fee2e2;color:#dc2626' : 'background:#ccfbf1;color:#0d9488'}">ë°°ì •: ${leaderName}</div>${un ? '<div style="margin-top:4px;font-size:10px;color:#f59e0b">ğŸ‘† í´ë¦­í•˜ì—¬ ì¶”ì²œë¦¬ë” ë³´ê¸°</div>' : ''}</div>` });
                        mk.addListener('mouseover', () => info.open(mapInst.current, mk));
                        mk.addListener('mouseout', () => info.close());
                        // ë©¤ë²„ í´ë¦­ í•¸ë“¤ëŸ¬
                        mk.addListener('click', () => {
                            if (m.leader_id) {
                                const leader = leaders.find(l => l.id === m.leader_id);
                                if (leader) selectLeaderOnMap(leader);
                            } else {
                                // ë¯¸ë°°ì •: ì¶”ì²œ ë¦¬ë” í‘œì‹œ
                                const recommended = findClosest(m.lat, m.lng, m.birthdate, leaders, 5);
                                polylines.current.forEach(p => p.setMap(null)); polylines.current = [];
                                markers.current.forEach(mk => { if (mk.originalIcon) mk.setIcon(mk.originalIcon); mk.setZIndex(mk.leaderData ? 100 : 50); });

                                recommended.forEach(rec => {
                                    const leaderMk = markers.current.find(k => k.leaderData?.id === rec.id);
                                    if (leaderMk) {
                                        const line = new window.google.maps.Polyline({
                                            path: [{ lat: m.lat, lng: m.lng }, { lat: rec.lat, lng: rec.lng }],
                                            geodesic: true, strokeColor: '#f59e0b', strokeOpacity: 0.8, strokeWeight: 2, map: mapInst.current,
                                            icons: [{ icon: { path: window.google.maps.SymbolPath.FORWARD_CLOSED_ARROW }, offset: '100%' }]
                                        });
                                        polylines.current.push(line);
                                        leaderMk.setIcon({ path: window.google.maps.SymbolPath.CIRCLE, fillColor: '#f59e0b', fillOpacity: 1, strokeColor: '#fff', strokeWeight: 3, scale: 16 });
                                        leaderMk.setZIndex(200);
                                    }
                                });
                                // ìê¸° ìì‹  í•˜ì´ë¼ì´íŠ¸
                                mk.setIcon({ path: window.google.maps.SymbolPath.CIRCLE, fillColor: '#ef4444', fillOpacity: 1, strokeColor: '#fff', strokeWeight: 4, scale: 10 });
                                mk.setZIndex(201);
                            }
                        });
                        markers.current.push(mk);
                        mk.leaderData = null; // ë©¤ë²„ ë§ˆì»¤ì„
                        memberMarkersMap.current[m.id] = mk; // Map member ID to its marker
                        if (m.leader_id) {
                            if (!leaderMemberGroupMarkers.current[m.leader_id]) leaderMemberGroupMarkers.current[m.leader_id] = [];
                            leaderMemberGroupMarkers.current[m.leader_id].push(mk);
                        }
                        bounds.extend({ lat: m.lat, lng: m.lng });
                    } else if (m.address) {
                        missingLocationCount++;
                    }
                });
                setUnmappedCount(missingLocationCount);

                // ë¦¬ë” ë§ˆì»¤ ìƒì„± (ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì†Œì†ì› í•˜ì´ë¼ì´íŠ¸)
                leaders.forEach(l => {
                    if (l.lat && l.lng) {
                        const full = l.current_members >= l.max_capacity;
                        const mk = new window.google.maps.Marker({
                            position: { lat: l.lat, lng: l.lng },
                            map: mapInst.current,
                            icon: { path: window.google.maps.SymbolPath.CIRCLE, fillColor: full ? '#94a3b8' : '#3b82f6', fillOpacity: 1, strokeColor: '#fff', strokeWeight: 3, scale: 14 },
                            label: { text: String(l.current_members), color: '#fff', fontSize: '11px', fontWeight: 'bold' },
                            zIndex: 100
                        });
                        mk.leaderData = l;
                        const info = new window.google.maps.InfoWindow({ content: `<div style="padding:10px;font-family:sans-serif;min-width:180px"><div style="font-size:15px;font-weight:bold;color:#1e40af;margin-bottom:4px">ğŸ‘¤ ${l.name} ${l.role}</div><div style="font-size:12px;color:#64748b">${calcAge(l.birthdate)}ì„¸ Â· ${['male', 'ë‚¨', 'ë‚¨ì„±', 'm'].some(v => String(l.gender || '').toLowerCase().includes(v)) ? 'ë‚¨ì„±' : 'ì—¬ì„±'}</div><div style="font-size:11px;color:#94a3b8;margin:6px 0;padding-top:6px;border-top:1px solid #e2e8f0">${l.address}</div><div style="font-size:12px;padding:4px 8px;border-radius:4px;display:inline-block;${full ? 'background:#fee2e2;color:#dc2626' : 'background:#dcfce7;color:#16a34a'};font-weight:600">ì •ì›: ${l.current_members}/${l.max_capacity}ëª…</div><div style="margin-top:6px;font-size:11px;color:#6366f1">ğŸ“Œ í´ë¦­í•˜ì—¬ ëª…ë‹¨ ë³´ê¸°</div></div>` });

                        // Hover: InfoWindowë§Œ í‘œì‹œ (ê¹œë¹¡ì„ ë°©ì§€)
                        mk.addListener('mouseover', () => info.open(mapInst.current, mk));
                        mk.addListener('mouseout', () => info.close());

                        // Click: ì „ì²´ íš¨ê³¼ (í•˜ì´ë¼ì´íŠ¸ + ì—°ê²°ì„  + íŒ¨ë„)
                        mk.addListener('click', () => selectLeaderOnMap(l));

                        markers.current.push(mk);
                        bounds.extend({ lat: l.lat, lng: l.lng });
                    }
                });

                if (leaders.length || members.length) { mapInst.current.fitBounds(bounds); window.google.maps.event.addListenerOnce(mapInst.current, 'idle', () => { if (mapInst.current.getZoom() > 14) mapInst.current.setZoom(14) }); }
            };


            const maxA = Math.max(...Object.values(stats.ageGroups), 1);

            // ì‚¬ì´ë“œë°” ì»¨í…ì¸  ë Œë”ë§
            const renderSidebarContent = () => {
                if (selectedLeader) {
                    return (
                        <div className="flex flex-col h-full animate-fade-in">
                            <div className="p-4 border-b bg-slate-50 flex justify-between items-start sticky top-0 z-10">
                                <div>
                                    <div className="flex items-center gap-2 mb-1">
                                        <span className="bg-brand-100 text-brand-700 text-xs px-2 py-0.5 rounded-full font-bold">ë¦¬ë”</span>
                                        <h3 className="text-lg font-bold text-slate-800">{selectedLeader.name}</h3>
                                    </div>
                                    <div className="text-sm text-slate-500">{formatRole(selectedLeader.role)} Â· {calcAge(selectedLeader.birthdate)}ì„¸</div>
                                    <div className="text-xs text-slate-400 mt-1 flex items-center gap-1">ğŸ“ {selectedLeader.address}</div>
                                </div>
                                <button onClick={closeLeaderPanel} className="text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-200 transition-colors">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </div>

                            <div className="p-3 bg-white border-b flex gap-2 overflow-x-auto no-scrollbar">
                                <button onClick={openEditLeader} className="flex-1 text-xs bg-slate-50 border border-slate-200 text-slate-700 px-3 py-2 rounded-lg hover:bg-slate-100 flex items-center justify-center gap-1 font-medium transition-colors">
                                    âœï¸ ìˆ˜ì •
                                </button>
                                <button onClick={printMemberList} className="flex-1 text-xs bg-blue-50 border border-blue-100 text-blue-700 px-3 py-2 rounded-lg hover:bg-blue-100 flex items-center justify-center gap-1 font-medium transition-colors">
                                    ğŸ–¨ï¸ ì¸ì‡„
                                </button>
                            </div>

                            <div className="p-2 bg-slate-50 border-b text-xs text-slate-500 flex justify-between items-center">
                                <span>êµ¬ì„±ì› <b>{leaderMembers.length}</b>ëª…</span>
                                <div className="flex bg-white rounded border overflow-hidden">
                                    <button onClick={() => setMemberSortBy('name')} className={`px-2 py-1 ${memberSortBy === 'name' ? 'bg-slate-100 font-bold text-brand-600' : 'hover:bg-slate-50'}`}>ì´ë¦„</button>
                                    <div className="w-px bg-slate-200"></div>
                                    <button onClick={() => setMemberSortBy('age')} className={`px-2 py-1 ${memberSortBy === 'age' ? 'bg-slate-100 font-bold text-brand-600' : 'hover:bg-slate-50'}`}>ë‚˜ì´</button>
                                </div>
                            </div>

                            <div className="flex-1 overflow-y-auto p-2 space-y-2">
                                {leaderMembers.length === 0 ? (
                                    <div className="text-center text-slate-400 py-12 flex flex-col items-center gap-2">
                                        <div className="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-2xl">ğŸƒ</div>
                                        <p>ì†Œì†ëœ ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤</p>
                                    </div>
                                ) : (
                                    [...leaderMembers].sort((a, b) => memberSortBy === 'age' ? calcAge(b.birthdate) - calcAge(a.birthdate) : (a.name || '').localeCompare(b.name || '', 'ko')).map(m => (
                                        <div key={m.id} className="group bg-white p-3 rounded-xl border border-slate-100 hover:border-brand-200 hover:shadow-sm transition-all relative">
                                            <div className="flex justify-between items-start">
                                                <div className="flex items-center gap-2">
                                                    {genderIcon(m.gender)}
                                                    <span className="font-bold text-slate-700">{m.name}</span>
                                                    <span className="text-xs bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">{formatRole(m.role)}</span>
                                                </div>
                                                <span className="text-xs text-slate-400">{calcAge(m.birthdate)}ì„¸</span>
                                            </div>

                                            {m.contact && <div className="text-xs text-slate-400 mt-1 flex items-center gap-1">ğŸ“ {m.contact}</div>}
                                            <div className="text-xs text-slate-400 mt-0.5 truncate flex items-center gap-1" title={m.address}>ğŸ“ {m.address}</div>

                                            <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                                                <button onClick={(e) => { e.stopPropagation(); openEditMember(m); }} className="w-7 h-7 bg-white border rounded-lg flex items-center justify-center hover:bg-slate-50 text-slate-600" title="ìˆ˜ì •">âœï¸</button>
                                                <button onClick={(e) => { e.stopPropagation(); handleUnassign(m); }} className="w-7 h-7 bg-white border rounded-lg flex items-center justify-center hover:bg-amber-50 text-amber-600" title="ì œì™¸">ğŸ“¤</button>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    );
                }

                // Default Sidebar: Stats & Search
                return (
                    <div className="flex flex-col h-full overflow-hidden">
                        <div className="p-4 space-y-4">
                            {/* Search */}
                            <div className="relative">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                                </div>
                                <input
                                    type="text"
                                    value={searchQuery}
                                    onChange={e => handleSearch(e.target.value)}
                                    placeholder="ì´ë¦„ ê²€ìƒ‰..."
                                    className="w-full pl-9 pr-4 py-2.5 bg-slate-100 border-none rounded-xl text-sm focus:ring-2 focus:ring-brand-500 transition-shadow"
                                />
                                {searchQuery && (
                                    <button
                                        onClick={() => { setSearchQuery(''); setSearchResults([]); setShowResults(false); }}
                                        className="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 hover:text-slate-600"
                                    >
                                        <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                    </button>
                                )}
                            </div>

                            {/* Mini Stats Grid */}
                            <div className="grid grid-cols-2 gap-3">
                                <div className="bg-brand-50 p-3 rounded-2xl border border-brand-100">
                                    <div className="text-xs text-brand-600 font-bold mb-1">ì „ì²´ ì¸ì›</div>
                                    <div className="text-2xl font-black text-brand-700">{stats.memberCount}</div>
                                </div>
                                <div className={`p-3 rounded-2xl border ${stats.unassignedCount > 0 ? 'bg-red-50 border-red-100' : 'bg-slate-50 border-slate-100'}`}>
                                    <div className={`text-xs font-bold mb-1 ${stats.unassignedCount > 0 ? 'text-red-600' : 'text-slate-500'}`}>ë¯¸ë°°ì •</div>
                                    <div className={`text-2xl font-black ${stats.unassignedCount > 0 ? 'text-red-700' : 'text-slate-700'}`}>{stats.unassignedCount}</div>
                                </div>
                            </div>
                        </div>

                        {/* Search Results or Dong Stats */}
                        <div className="flex-1 overflow-y-auto px-4 pb-4 space-y-4 scroll-smooth">
                            {showResults && searchResults.length > 0 ? (
                                <div className="space-y-2 animate-fade-in">
                                    <div className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">ê²€ìƒ‰ ê²°ê³¼ ({searchResults.length})</div>
                                    {searchResults.map((r, i) => (
                                        <div key={i} onClick={() => focusOnResult(r)} className="bg-white border rounded-xl p-3 hover:border-brand-500 hover:shadow-md transition-all cursor-pointer group">
                                            <div className="flex items-center justify-between mb-1">
                                                <div className="flex items-center gap-2">
                                                    <span className={`text-[10px] px-1.5 py-0.5 rounded font-bold ${r.type === 'leader' ? 'bg-blue-100 text-blue-700' : r.leader_id ? 'bg-teal-100 text-teal-700' : 'bg-red-100 text-red-700'}`}>
                                                        {r.type === 'leader' ? 'ë¦¬ë”' : r.leader_id ? 'ë°°ì •' : 'ë¯¸ë°°ì •'}
                                                    </span>
                                                    <span className="font-bold text-slate-700 group-hover:text-brand-600 transition-colors">{r.name}</span>
                                                </div>
                                                <span className="text-xs text-slate-400">{calcAge(r.birthdate)}ì„¸</span>
                                            </div>
                                            <div className="text-xs text-slate-500 flex items-center gap-1 truncate">ğŸ“ {r.address}</div>
                                            {r.type === 'member' && r.leaderName && <div className="text-xs text-slate-400 mt-1 pl-2 border-l-2">ì†Œì†: {r.leaderName}</div>}
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="space-y-6">
                                    {/* Age Distribution */}
                                    <div>
                                        <div className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex justify-between">
                                            <span>ì—°ë ¹ëŒ€ ë¶„í¬</span>
                                            <span className="flex gap-2">
                                                <span className="flex items-center gap-1"><span className="w-1.5 h-1.5 rounded-full bg-blue-500"></span>ë‚¨ {stats.genderRatio.male}</span>
                                                <span className="flex items-center gap-1"><span className="w-1.5 h-1.5 rounded-full bg-pink-500"></span>ì—¬ {stats.genderRatio.female}</span>
                                            </span>
                                        </div>
                                        <div className="space-y-2">
                                            {Object.entries(stats.ageGroups).map(([k, v]) => (
                                                <div key={k} className="flex items-center gap-3 text-sm">
                                                    <span className="w-10 text-slate-500 text-xs font-medium">{k}</span>
                                                    <div className="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden">
                                                        <div className="h-full bg-slate-300 rounded-full" style={{ width: `${v / maxA * 100}%` }}></div>
                                                    </div>
                                                    <span className="w-6 text-right font-bold text-slate-700">{v}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Dong Stats */}
                                    {Object.keys(dongStats).length > 0 && (
                                        <div>
                                            <div className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">ì§€ì—­ë³„ ë¶„í¬</div>
                                            <div className="flex flex-wrap gap-1.5">
                                                {Object.entries(dongStats)
                                                    .sort((a, b) => b[1] - a[1])
                                                    .slice(0, 15) // Top 15ë§Œ í‘œì‹œ
                                                    .map(([dong, count]) => (
                                                        <div key={dong} className="flex items-center gap-1 bg-white border border-slate-200 rounded-lg px-2 py-1 text-xs">
                                                            <span className="text-slate-600">{dong}</span>
                                                            <span className="bg-slate-100 text-slate-600 px-1 rounded font-bold">{count}</span>
                                                        </div>
                                                    ))
                                                }
                                                {Object.keys(dongStats).length > 15 && <div className="text-xs text-slate-400 pt-1">+ {Object.keys(dongStats).length - 15}ê°œ ì§€ì—­</div>}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            return (
                <div className="h-[calc(100vh-6rem)] bg-white rounded-2xl border shadow-sm overflow-hidden flex relative">

                    {/* Sidebar */}
                    <div className={`
                        absolute inset-y-0 left-0 z-20 w-full md:w-80 bg-white border-r transform transition-transform duration-300 ease-in-out flex flex-col
                        ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0 md:w-0 md:border-none md:overflow-hidden'}
                    `}>
                        {renderSidebarContent()}
                    </div>

                    {/* Toggle Button (Mobile/Desktop) */}
                    <button
                        onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                        className={`absolute top-4 z-30 bg-white p-2 rounded-lg shadow-lg border border-slate-200 text-slate-600 hover:text-brand-600 transition-all duration-300
                            ${isSidebarOpen ? 'left-[calc(100%-3rem)] md:left-84' : 'left-4'}
                        `}
                    >
                        {isSidebarOpen ? (
                            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" /></svg>
                        ) : (
                            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                        )}
                    </button>

                    {/* Main Map Area */}
                    <div className={`flex-1 relative transition-all duration-300 ${isSidebarOpen ? 'md:ml-80' : 'ml-0'}`}>
                        {loading && (
                            <div className="absolute inset-0 z-40 bg-white/50 backdrop-blur-sm flex items-center justify-center">
                                <div className="bg-white p-4 rounded-2xl shadow-xl flex flex-col items-center gap-3">
                                    <div className="w-10 h-10 border-4 border-brand-200 border-t-brand-600 rounded-full animate-spin" />
                                    <span className="text-sm font-bold text-slate-600">ë¡œë”©ì¤‘...</span>
                                </div>
                            </div>
                        )}

                        <div className="absolute top-4 right-4 z-10 flex flex-col gap-2">
                            <button
                                onClick={load}
                                className="bg-white p-2.5 rounded-xl shadow-lg border border-slate-200 text-slate-600 hover:text-brand-600 hover:bg-slate-50 transition-colors"
                                title="ìƒˆë¡œê³ ì¹¨"
                            >
                                <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                            </button>
                            {unmappedCount > 0 && (
                                <button
                                    onClick={fixMissingLocations}
                                    className="bg-amber-100 text-amber-700 p-2.5 rounded-xl shadow-lg border border-amber-200 hover:bg-amber-200 transition-colors animate-pulse"
                                    title={`${unmappedCount}ëª… ìœ„ì¹˜ ê°±ì‹  í•„ìš”`}
                                >
                                    âš ï¸
                                </button>
                            )}
                        </div>

                        {/* Map Container */}
                        <div ref={mapRef} className="w-full h-full bg-slate-100" />
                    </div>

                    {editItem && <EditModal item={editItem} type={editType} leaders={allData.current.leaders} onClose={() => { setEditItem(null); setEditType(null); }} onUpdate={onEditUpdate} />}
                </div>
            );
        };

        const OrgChart = ({ globalData, onRefresh, setGlobalData, setSyncing }) => {
            const { leaders, members } = globalData;

            // ë‹¤ì¤‘ ì„ íƒ ìƒíƒœ (í„°ì¹˜/í´ë¦­ ê¸°ë°˜) - { id, fromLeaderId, member }
            const [selectedMembers, setSelectedMembers] = useState([]);
            // ì¶”ì²œ ë¦¬ë” ID ëª©ë¡ (ë§ˆì§€ë§‰ ì„ íƒëœ ë©¤ë²„ ê¸°ì¤€)
            const [recommendedLeaders, setRecommendedLeaders] = useState([]);
            // ì •ë ¬ ì˜µì…˜: 'name' (ì´ë¦„ìˆœ), 'members' (ì¸ì›ìˆœ)
            const [sortOption, setSortOption] = useState('name');
            // ìˆœì› ì¶”ê°€ ëª¨ë‹¬
            const [addMemberModal, setAddMemberModal] = useState({ visible: false, leaderId: null, leaderName: '' });
            const [addMemberForm, setAddMemberForm] = useState({ name: '', role: 'ì„±ë„', gender: 'Male', birthdate: '', contact: '', address: '' });
            const [addingSaving, setAddingSaving] = useState(false);

            // Context Menu State
            const [contextMenu, setContextMenu] = useState({ visible: false, x: 0, y: 0, member: null, leaderId: null });
            // Edit Modal State
            const [editModal, setEditModal] = useState({ visible: false, member: null });
            // Edit Form State
            const [editForm, setEditForm] = useState({ name: '', role: '', birthdate: '', gender: '', address: '' });

            // Recruitment Modal State
            const [recruitmentModal, setRecruitmentModal] = useState({ visible: false, leader: null });
            // Placement Modal State (New)
            const [placementModal, setPlacementModal] = useState({ visible: false, member: null });

            // ì„±ë³„ íŒë³„ í•¨ìˆ˜ (ë‚¨ì„±: 0, ì—¬ì„±: 1)
            const getGenderOrder = (g) => {
                const s = String(g || '').toLowerCase();
                return ['female', 'ì—¬', 'ì—¬ì„±', 'f', 'å¥³'].some(v => s.includes(v)) ? 1 : 0;
            };

            // ê·¸ë£¹ ë¶„ë¥˜ ê¸°ì¤€ (ì‚¬ìš©ì ì§€ì • ìˆœì„œ)
            // í•˜ë‚¨ì—¬ì„±ìˆœ (01ìˆœ~25ìˆœ + 26ê´€ë¦¬ìˆœ + ì—¬ì„±ê´€ë¦¬ìˆœ)
            const GROUP_REGULAR = [
                'ê¶Œìˆœì´', 'ì´ì •ë‚¨', 'ì‹ ê¸¸ì„ ', 'ì„ë¯¼ì •', 'ì´ê²½í¬', 'í™ë´‰ìˆ™', 'ìœ¤ìƒë¯¸', 'ì‹ í˜œì„ ',
                'í˜„ì§„ì„­', 'ê¹€ìˆ˜í˜„', 'ì¡°ì€ì¬', 'í•œì¸ìˆœ', 'ê¹€í˜„ì •', 'ì–‘ë¯¸ì', 'ì´ì •ë¯¼', 'ê¹€ì˜¥ìˆœ',
                'ì´ì€ì •', 'ë°•ìœ¤ê²½', 'ì´ì˜ë¯¸', 'ê³½í˜„ì •', 'ì„œìœ¤í¬', 'ê¹€ì£¼í˜„', 'ë…¸ì›ì˜¥', 'ì˜¨ìœ¤ê²½',
                'ìœ¤í–¥ìˆ™', 'ìœ ê²½ì˜¥', 'ê¹€ì€ì£¼'
            ];
            // í•˜ë‚¨ì§ì¥ìˆœ (01ìˆœ~10ìˆœ)
            const GROUP_WORK = [
                'ìµœì§„ìˆ™', 'ê¹€ìˆ˜ë¯¸', 'ë°•ìˆœì• ', 'ìµœë´‰ì€', 'ì˜¤ì€ë¯¸', 'ê°•ë¯¼ì •', 'ì„œì§€í˜œ', 'ì´ì‚¬ë‘',
                'ì˜¤ë¯¸ê²½', 'ì´ëª…ìˆ™'
            ];
            const GROUP_MALE = ['ê¹€ê´€', 'ê¹€ê´‘ë¹ˆ', 'ê¹€ê·œì‹', 'ê¹€ëŒ€í˜•', 'ê¹€ìƒì •', 'ê¹€ì¢…ì§„', 'ë°•ìˆœìƒ', 'ë°°ê°‘ìˆ˜', 'ìœ¤í˜•ì„±', 'ìœ¤í˜„ì„±', 'ì´ë¶€ìš©', 'ì§„ìš©ì„±'];

            // ì „ì²´ ì •ë ¬ ìˆœì„œ ë°°ì—´ (ì¼ë°˜ â†’ ì§ì¥ â†’ ë‚¨ì„±)
            const LEADER_ORDER = [...GROUP_REGULAR, ...GROUP_WORK, ...GROUP_MALE];

            // ê·¸ë£¹ ë²ˆí˜¸ ë°˜í™˜ (ì¼ë°˜: 0, ì§ì¥: 1, ë‚¨ì„±: 2, ë¯¸ë¶„ë¥˜: 3)
            const getGroupOrder = (leader) => {
                const n = (leader.name || '').trim();

                if (GROUP_REGULAR.includes(n)) return 0;
                if (GROUP_WORK.includes(n)) return 1;
                if (GROUP_MALE.includes(n)) return 2;

                return 3; // ë¯¸ë¶„ë¥˜
            };

            // ì •ë ¬ ë¡œì§: ì§€ì •ëœ ìˆœì„œ ë°°ì—´ ê¸°ì¤€ ì •ë ¬
            const getSortedLeaders = () => {
                return [...leaders].sort((a, b) => {
                    // ì¸ì›ìˆœ ì •ë ¬ ì„ íƒ ì‹œ
                    if (sortOption === 'members') {
                        const groupDiff = getGroupOrder(a) - getGroupOrder(b);
                        if (groupDiff !== 0) return groupDiff;
                        return (a.current_members || 0) - (b.current_members || 0);
                    }

                    // ê¸°ë³¸: ì§€ì •ëœ ìˆœì„œ ë°°ì—´ ê¸°ì¤€
                    const aName = (a.name || '').trim();
                    const bName = (b.name || '').trim();
                    const aIndex = LEADER_ORDER.indexOf(aName);
                    const bIndex = LEADER_ORDER.indexOf(bName);

                    // ë‘˜ ë‹¤ ë°°ì—´ì— ìˆìœ¼ë©´ ì¸ë±ìŠ¤ ìˆœì„œëŒ€ë¡œ
                    if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                    // í•˜ë‚˜ë§Œ ë°°ì—´ì— ìˆìœ¼ë©´ ë°°ì—´ì— ìˆëŠ” ìª½ ìš°ì„ 
                    if (aIndex !== -1) return -1;
                    if (bIndex !== -1) return 1;
                    // ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ì´ë¦„ìˆœ
                    return aName.localeCompare(bName, 'ko');
                });
            };
            const sortedLeaders = getSortedLeaders();
            const groups = sortedLeaders.map(l => ({
                leader: l,
                members: members.filter(m => String(m.leader_id) === String(l.id)).sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ko'))
            }));
            const unassigned = members.filter(m => !m.leader_id).sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ko'));

            // ë¯¸ë°°ì • ì¸ì› ë Œë”ë§ í—¬í¼
            const UnassignedItem = ({ m, isSelected, onClick }) => (
                <div
                    onClick={onClick}
                    className={`
                        flex justify-between items-center p-3 cursor-pointer transition-all border-b last:border-0
                        ${isSelected ? 'bg-emerald-50 border-emerald-100' : 'hover:bg-slate-50 border-slate-100'}
                    `}
                >
                    <div className="flex-1">
                        <div className="flex items-center gap-2">
                            <span className="font-bold text-slate-700">{m.name}</span>
                            <span className="text-xs text-slate-400">{calcAge(m.birthdate)}ì„¸ Â· {['male', 'ë‚¨', 'ë‚¨ì„±', 'm'].some(v => String(m.gender || '').toLowerCase().includes(v)) ? 'ë‚¨' : 'ì—¬'}</span>
                        </div>
                        <div className="text-xs text-slate-400 truncate max-w-[140px]">{m.address || 'ì£¼ì†Œ ì—†ìŒ'}</div>
                    </div>
                    {/* ì¶”ì²œ ë²„íŠ¼ (ë‹ë³´ê¸°/ë°˜ì§ì´) - í´ë¦­ ì‹œ ëª¨ë‹¬ ì˜¤í”ˆ */}
                    <button
                        onClick={(e) => { e.stopPropagation(); setPlacementModal({ visible: true, member: m }); }}
                        className="p-2 text-amber-500 hover:bg-amber-50 rounded-full transition-colors"
                        title="ë¦¬ë” ì¶”ì²œ ë°›ê¸°"
                    >
                        âœ¨
                    </button>
                </div>
            );

            // Group by category for visual separation
            const groupedSections = {
                0: { title: "ğŸ¡ ì¼ë°˜", groups: [] },
                1: { title: "ğŸ’¼ ì§ì¥", groups: [] },
                2: { title: "ğŸ‘¨ ë‚¨ì„±", groups: [] },
                3: { title: "ê¸°íƒ€", groups: [] }
            };

            groups.forEach(g => {
                const order = getGroupOrder(g.leader);
                if (groupedSections[order]) {
                    groupedSections[order].groups.push(g);
                } else {
                    groupedSections[3].groups.push(g);
                }
            });

            // ìˆœì› ì„ íƒ í•¸ë“¤ëŸ¬ (ë‹¤ì¤‘ ì„ íƒ í† ê¸€)
            const handleSelectMember = (member, fromLeaderId) => {
                const isSelected = selectedMembers.some(s => s.id === member.id);

                if (isSelected) {
                    // ì„ íƒ í•´ì œ
                    const newSet = selectedMembers.filter(s => s.id !== member.id);
                    setSelectedMembers(newSet);
                    if (newSet.length === 0) setRecommendedLeaders([]);
                } else {
                    // ì¶”ê°€ ì„ íƒ
                    const newItem = { id: member.id, fromLeaderId, member };
                    const newSet = [...selectedMembers, newItem];
                    setSelectedMembers(newSet);

                    // ì¶”ì²œ ë¦¬ë” ê³„ì‚° (ë§ˆì§€ë§‰ ì„ íƒëœ ë©¤ë²„ ê¸°ì¤€)
                    if (member.lat && member.lng) {
                        const recommended = findClosest(member.lat, member.lng, member.birthdate, leaders, 3);
                        setRecommendedLeaders(recommended.map(r => r.id));
                    } else {
                        setRecommendedLeaders([]);
                    }
                }
            };

            // Context Menu Handlers
            const handleContextMenu = (e, member, leaderId) => {
                e.preventDefault();
                setContextMenu({
                    visible: true,
                    x: e.pageX,
                    y: e.pageY,
                    member,
                    leaderId
                });
            };

            const closeContextMenu = () => setContextMenu({ ...contextMenu, visible: false });

            useEffect(() => {
                const handleClick = () => closeContextMenu();
                document.addEventListener('click', handleClick);
                return () => document.removeEventListener('click', handleClick);
            }, [contextMenu]);

            const handleEditClick = (memberOverride) => {
                const targetMember = memberOverride || (selectedMembers.length === 1 ? selectedMembers[0].member : contextMenu.member);
                if (targetMember) {
                    setEditForm({
                        name: targetMember.name,
                        role: targetMember.role,
                        birthdate: targetMember.birthdate,
                        gender: targetMember.gender,
                        address: targetMember.address || ''
                    });
                    setEditModal({ visible: true, member: targetMember });

                    // Close context menu if open
                    if (contextMenu.visible) setContextMenu({ ...contextMenu, visible: false });
                }
            };

            const handleDeleteClick = async () => {
                let targets = [];
                if (selectedMembers.length > 0) {
                    targets = selectedMembers.map(s => s.member);
                } else if (contextMenu.member) {
                    targets = [contextMenu.member];
                }

                if (targets.length === 0) return;

                const names = targets.map(m => m.name).join(', ');
                const displayName = targets.length > 3 ? `${targets[0].name} ì™¸ ${targets.length - 1}ëª…` : names;

                // Determine if we are unassigning or permanently deleting
                // Check if ALL selected targets are already unassigned (leader_id is empty)
                const isPermanentDelete = targets.every(m => !m.leader_id);

                if (isPermanentDelete) {
                    if (!confirm(`âš ï¸ ê²½ê³ : ì •ë§ ${displayName}ì„(ë¥¼) ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) return;

                    // Optimistic Update for Permanent Delete
                    const backup = { ...globalData };
                    const targetIds = targets.map(m => String(m.id));

                    const newMembers = members.filter(m => !targetIds.includes(String(m.id)));

                    // No need to update leaders count as they are unassigned
                    setGlobalData({ ...globalData, members: newMembers });
                    setSyncing?.(true);

                    // Clear selection
                    setSelectedMembers([]);
                    setRecommendedLeaders([]);
                    if (contextMenu.visible) setContextMenu({ ...contextMenu, visible: false });

                    try {
                        await Promise.all(targets.map(m => removeMember(m.id, '', 'DELETE')));
                    } catch (err) {
                        alert("ì‚­ì œ ì‹¤íŒ¨: " + err.message);
                        setGlobalData(backup);
                    } finally {
                        setSyncing?.(false);
                    }
                } else {
                    // Normal Unassign
                    if (!confirm(`${displayName}ì„(ë¥¼) ì •ë§ ê·¸ë£¹ì—ì„œ ì œì™¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë¯¸ë°°ì • ìƒíƒœë¡œ ë³€ê²½ë¨)`)) return;

                    // Optimistic Update
                    const backup = { ...globalData };

                    const targetIds = targets.map(m => String(m.id));
                    // Unassign (remove leader_id)
                    const newMembers = members.map(m => targetIds.includes(String(m.id)) ? { ...m, leader_id: '' } : m);

                    // Recalculate leader count
                    const leaderCounts = {};
                    newMembers.forEach(m => {
                        if (m.leader_id) leaderCounts[m.leader_id] = (leaderCounts[m.leader_id] || 0) + 1;
                    });

                    const newLeaders = leaders.map(l => ({
                        ...l,
                        current_members: leaderCounts[l.id] || 0
                    }));

                    setGlobalData({ ...globalData, members: newMembers, leaders: newLeaders });
                    setSyncing?.(true);

                    // Clear selection
                    setSelectedMembers([]);
                    setRecommendedLeaders([]);
                    if (contextMenu.visible) setContextMenu({ ...contextMenu, visible: false });

                    try {
                        await Promise.all(targets.map(m => updateMember(m.id, { leader_id: '' })));
                    } catch (err) {
                        alert("ì‚­ì œ ì‹¤íŒ¨: " + err.message);
                        setGlobalData(backup);
                    } finally {
                        setSyncing?.(false);
                    }
                }
            };

            const handleDeletePermanently = async () => {
                if (!editModal.member) return;
                const { member } = editModal;
                if (!confirm(`ì •ë§ë¡œ ${member.name}ë‹˜ì„ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;

                // Optimistic Update
                const backup = { ...globalData };
                const newMembers = members.filter(m => m.id !== member.id);
                // Recalculate leader count
                const leaderCounts = {};
                newMembers.forEach(m => {
                    if (m.leader_id) leaderCounts[m.leader_id] = (leaderCounts[m.leader_id] || 0) + 1;
                });
                const newLeaders = leaders.map(l => ({
                    ...l,
                    current_members: leaderCounts[l.id] || 0
                }));

                setGlobalData({ ...globalData, members: newMembers, leaders: newLeaders });
                setEditModal({ visible: false, member: null });
                setSyncing?.(true);

                try {
                    await removeMember(member.id, member.leader_id, 'DELETE');
                } catch (err) {
                    alert("ì˜êµ¬ ì‚­ì œ ì‹¤íŒ¨: " + err.message);
                    setGlobalData(backup);
                } finally {
                    setSyncing?.(false);
                }
            };

            const handleSaveEdit = async (e) => {
                e.preventDefault();
                if (!editModal.member) return;

                const backup = { ...globalData };
                const updatedMember = { ...editModal.member, ...editForm };

                const newMembers = members.map(m => m.id === updatedMember.id ? updatedMember : m);
                setGlobalData({ ...globalData, members: newMembers });
                setEditModal({ visible: false, member: null });
                setSyncing?.(true);

                try {
                    await updateMember(updatedMember.id, editForm);
                } catch (err) {
                    alert("ìˆ˜ì • ì‹¤íŒ¨: " + err.message);
                    setGlobalData(backup);
                } finally {
                    setSyncing?.(false);
                }
            };

            // ê·¸ë£¹ í´ë¦­ í•¸ë“¤ëŸ¬ (ì„ íƒëœ ë©¤ë²„ë“¤ì„ ì´ ê·¸ë£¹ìœ¼ë¡œ ëª¨ë‘ ì´ë™)
            const handleGroupClick = async (toLeaderId) => {
                // ì„ íƒëœ ë©¤ë²„ê°€ ì—†ìœ¼ë©´ ë¦¬ë” ì¶”ì²œ ëª¨ë‹¬ í‘œì‹œ (toLeaderIdê°€ ìˆëŠ” ê²½ìš°ë§Œ)
                if (selectedMembers.length === 0) {
                    if (toLeaderId) {
                        const leader = leaders.find(l => String(l.id) === String(toLeaderId));
                        if (leader) setRecruitmentModal({ visible: true, leader });
                    }
                    return;
                }

                // ì„ íƒëœ ë©¤ë²„ê°€ ìˆìœ¼ë©´ ì´ë™ ë¡œì§ ìˆ˜í–‰
                const leaderName = leaders.find(l => String(l.id) === String(toLeaderId))?.name || "ë¯¸ë°°ì •";
                const count = selectedMembers.length;
                const names = selectedMembers.map(s => s.member.name).join(', ');
                const displayName = count > 3 ? `${selectedMembers[0].member.name} ì™¸ ${count - 1}ëª…` : names;

                if (!confirm(`${displayName}ì„(ë¥¼) [${leaderName}]ìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

                // Optimistic Update
                const backup = { ...globalData };

                // ë©¤ë²„ ì—…ë°ì´íŠ¸
                const targetIds = selectedMembers.map(s => String(s.id));
                const newMembers = members.map(m => targetIds.includes(String(m.id)) ? { ...m, leader_id: toLeaderId || '' } : m);

                // ë¦¬ë” ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
                // leaders arrayë¥¼ ìˆœíšŒí•˜ë©°, ê° leaderì˜ current_membersë¥¼ ì¬ê³„ì‚°í•˜ëŠ” ê²ƒì´ ì•ˆì „í•¨.
                // í•˜ì§€ë§Œ ì„±ëŠ¥ìƒ deltaë§Œ ë°˜ì˜í•˜ë ¤ë©´ ë³µì¡í•¨ (Nëª…ì´ ì„œë¡œ ë‹¤ë¥¸ ê·¸ë£¹ì—ì„œ ì™”ì„ ìˆ˜ ìˆìŒ).
                // ê°„ë‹¨íˆ newMembers ê¸°ë°˜ìœ¼ë¡œ leader countsë¥¼ ì¬ê³„ì‚°í•˜ëŠ”ê²Œ ê°€ì¥ ì •í™•í•¨.
                const leaderCounts = {};
                newMembers.forEach(m => {
                    if (m.leader_id) leaderCounts[m.leader_id] = (leaderCounts[m.leader_id] || 0) + 1;
                });

                const newLeaders = leaders.map(l => ({
                    ...l,
                    current_members: leaderCounts[l.id] || 0
                }));

                setGlobalData({ ...globalData, members: newMembers, leaders: newLeaders });
                setSelectedMembers([]);
                setRecommendedLeaders([]);

                setSyncing?.(true);
                try {
                    // ë³‘ë ¬ ì—…ë°ì´íŠ¸
                    await Promise.all(selectedMembers.map(s => updateMember(s.id, { leader_id: toLeaderId || '' })));
                } catch (err) {
                    console.error("ì´ë™ ì‹¤íŒ¨", err);
                    alert("ì´ë™ ì‹¤íŒ¨: " + err.message);
                    setGlobalData(backup);
                } finally {
                    setSyncing?.(false);
                }
            };

            // ì¶”ì²œ ìˆœìœ„ ë±ƒì§€
            const getRecommendRank = (leaderId) => {
                const idx = recommendedLeaders.indexOf(leaderId);
                return idx >= 0 ? idx + 1 : null;
            };

            // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (A3 ë ˆì´ì•„ì›ƒ ê³ ë ¤)
            const exportExcel = () => {
                const wb = XLSX.utils.book_new();
                const wsData = [];
                const GROUPS_PER_ROW = 5;

                // ì „ì²´ ê·¸ë£¹ ë¦¬ìŠ¤íŠ¸ (ë¯¸ë°°ì •ë„ ê·¸ë£¹ì²˜ëŸ¼ ì·¨ê¸‰)
                const allGroups = [...groups];
                if (unassigned.length > 0) {
                    allGroups.push({
                        leader: { name: 'ë¯¸ë°°ì •', role: '', isUnassigned: true },
                        members: unassigned
                    });
                }

                for (let i = 0; i < allGroups.length; i += GROUPS_PER_ROW) {
                    const rowGroups = allGroups.slice(i, i + GROUPS_PER_ROW);
                    const headerRow = [];
                    rowGroups.forEach(g => {
                        headerRow.push(g.leader.isUnassigned ? "ë¯¸ë°°ì •" : `${g.leader.name} ${formatRole(g.leader.role)}`);
                        headerRow.push(""); headerRow.push("");
                    });
                    wsData.push(headerRow);

                    const maxLen = Math.max(...rowGroups.map(g => g.members.length));
                    for (let j = 0; j < maxLen; j++) {
                        const memberRow = [];
                        rowGroups.forEach(g => {
                            const m = g.members[j];
                            if (m) {
                                memberRow.push(m.name); memberRow.push(formatRole(m.role));
                            } else {
                                memberRow.push(""); memberRow.push("");
                            }
                            memberRow.push("");
                        });
                        wsData.push(memberRow);
                    }
                    const footerRow = [];
                    rowGroups.forEach(g => {
                        footerRow.push(`ì´ ${g.members.length}ëª…`);
                        footerRow.push(""); footerRow.push("");
                    });
                    wsData.push(footerRow);
                    wsData.push([]); wsData.push([]);
                }

                const ws = XLSX.utils.aoa_to_sheet(wsData);
                const wscols = [];
                for (let k = 0; k < GROUPS_PER_ROW; k++) {
                    wscols.push({ wch: 10 }); wscols.push({ wch: 8 }); wscols.push({ wch: 2 });
                }
                ws['!cols'] = wscols;
                XLSX.utils.book_append_sheet(wb, ws, "ì¡°ì§ë„");
                XLSX.writeFile(wb, `ì¡°ì§ë„_${new Date().toISOString().slice(0, 10)}.xlsx`);
            };

            // ìˆœì› ì¶”ê°€ í•¸ë“¤ëŸ¬
            const handleAddMemberClick = (leaderId, leaderName, e) => {
                e?.stopPropagation();
                setAddMemberForm({ name: '', role: 'ì„±ë„', gender: 'Male', birthdate: '', contact: '', address: '' });
                setAddMemberModal({ visible: true, leaderId, leaderName });
            };

            const handleAddMemberSubmit = async (e) => {
                e.preventDefault();
                if (!addMemberForm.name || !addMemberForm.address) {
                    alert('ì´ë¦„ê³¼ ì£¼ì†ŒëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
                    return;
                }
                setAddingSaving(true);
                try {
                    const geo = await geocodeAddress(addMemberForm.address);
                    const newMember = {
                        ...addMemberForm,
                        gender: normalizeGender(addMemberForm.gender),
                        contact: formatPhone(addMemberForm.contact),
                        lat: geo.lat,
                        lng: geo.lng,
                        leader_id: addMemberModal.leaderId || '',
                        status: addMemberModal.leaderId ? 'assigned' : 'wants_group'
                    };
                    await insertMember(newMember);
                    alert(`${addMemberForm.name}ë‹˜ì´ ${addMemberModal.leaderName || 'ë¯¸ë°°ì •'}ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                    setAddMemberModal({ visible: false, leaderId: null, leaderName: '' });
                    onRefresh?.();
                } catch (err) {
                    alert(`ë“±ë¡ ì‹¤íŒ¨: ${err.message}`);
                } finally {
                    setAddingSaving(false);
                }
            };

            // ë©¤ë²„ ë°°ì • (PlacementModalì—ì„œ í˜¸ì¶œ)
            const handlePlaceMember = async (member, leader) => {
                if (!confirm(`${member.name}ë‹˜ì„ ${leader.name}ë‹˜(${leader.role}) ì…€ë¡œ ë°°ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

                // Optimistic Update
                const backup = { ...globalData };
                const updatedMember = { ...member, leader_id: leader.id };

                // Update Members
                const newMembers = members.map(m => m.id === member.id ? updatedMember : m);

                // Update Leaders counts
                const leaderCounts = {};
                newMembers.forEach(m => {
                    if (m.leader_id) {
                        leaderCounts[m.leader_id] = (leaderCounts[m.leader_id] || 0) + 1;
                    }
                });
                const newLeaders = leaders.map(l => ({ ...l, current_members: leaderCounts[l.id] || 0 }));

                setGlobalData({ leaders: newLeaders, members: newMembers });
                setPlacementModal({ visible: false, member: null });

                try {
                    setSyncing(true);
                    await updateMember(updatedMember);
                    // await updateLeader(recruitmentModal.leader.id ... ) // ë¦¬ë” ì¹´ìš´íŠ¸ëŠ” DB íŠ¸ë¦¬ê±°/ê³„ì‚°ì‹ì´ë©´ ìƒëµ ê°€ëŠ¥í•˜ì§€ë§Œ ì—¬ê¸°ì„  ìƒëµ
                } catch (err) {
                    console.error(err);
                    alert("ë°°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    setGlobalData(backup);
                } finally {
                    setSyncing(false);
                }
            };

            const handleRecruitMember = async (member) => {
                const toLeader = recruitmentModal.leader;
                if (!toLeader) return;

                if (!confirm(`${member.name}ë‹˜ì„ ${toLeader.name} ì…€ë¡œ ì˜ì…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

                // Optimistic Update
                const backup = { ...globalData };
                const updatedMember = { ...member, leader_id: toLeader.id };

                // Update Members
                const newMembers = members.map(m => m.id === member.id ? updatedMember : m);

                // Update Leaders counts
                const leaderCounts = {};
                newMembers.forEach(m => {
                    if (m.leader_id) leaderCounts[m.leader_id] = (leaderCounts[m.leader_id] || 0) + 1;
                });
                const newLeaders = leaders.map(l => ({ ...l, current_members: leaderCounts[l.id] || 0 }));

                setGlobalData({ ...globalData, members: newMembers, leaders: newLeaders });
                setSyncing?.(true);

                try {
                    await updateMember(member.id, { leader_id: toLeader.id });
                } catch (e) {
                    alert("ì˜ì… ì‹¤íŒ¨: " + e.message);
                    setGlobalData(backup);
                } finally {
                    setSyncing?.(false);
                }
            };

            return (
                <div className="space-y-6 pb-12">
                    <div className="flex flex-wrap justify-between items-center gap-3 bg-white p-4 rounded-2xl border shadow-sm print:hidden">
                        <h2 className="text-xl font-bold flex items-center gap-2">
                            <span>ğŸ“Š</span> ì¡°ì§ë„ (í„°ì¹˜í•˜ì—¬ ì´ë™)
                        </h2>
                        <div className="flex items-center gap-3 flex-wrap">
                            {/* ì •ë ¬ ì˜µì…˜ */}
                            <div className="flex bg-slate-100 p-0.5 rounded-lg text-xs">
                                <button onClick={() => setSortOption('name')} className={`px-2 py-1 rounded ${sortOption === 'name' ? 'bg-white text-brand-600 font-bold shadow-sm' : 'text-slate-500'}`}>ì´ë¦„ìˆœ</button>
                                <button onClick={() => setSortOption('members')} className={`px-2 py-1 rounded ${sortOption === 'members' ? 'bg-white text-brand-600 font-bold shadow-sm' : 'text-slate-500'}`}>ì¸ì›ìˆœ</button>
                            </div>
                            {/* ìˆœì› ì¶”ê°€ ë²„íŠ¼ */}
                            <button onClick={(e) => handleAddMemberClick('', 'ë¯¸ë°°ì •', e)} className="bg-brand-600 text-white px-3 py-1.5 rounded-lg font-bold text-sm hover:bg-brand-700 flex items-center gap-1 transition-colors">
                                <span>â•</span> ìˆœì› ë“±ë¡
                            </button>
                            <button onClick={exportExcel} className="bg-green-600 text-white px-3 py-1.5 rounded-lg font-bold text-sm hover:bg-green-700 flex items-center gap-1 transition-colors shadow-sm">
                                <span>ğŸ“…</span> ì—‘ì…€
                            </button>
                        </div>
                    </div>

                    {/* ì„ íƒ ìƒíƒœ ì•ˆë‚´ ë°°ë„ˆ */}
                    {/* ì„ íƒ ìƒíƒœ ì•ˆë‚´ ë°°ë„ˆ (ë‹¤ì¤‘ ì„ íƒ ì§€ì›) */}
                    {selectedMembers.length > 0 && (
                        <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 bg-slate-800 text-white p-3 rounded-2xl flex justify-between items-center shadow-2xl border border-slate-600 animate-fade-in-up w-[90%] max-w-2xl backdrop-blur-md bg-opacity-95">
                            <div className="flex items-center gap-2 overflow-x-auto no-scrollbar">
                                <span className="text-lg">ğŸ‘†</span>
                                <span className="font-bold whitespace-nowrap">
                                    {selectedMembers.length}ëª…
                                    {selectedMembers.length === 1 && <span className="text-sm font-normal ml-1">({selectedMembers[0].member.name})</span>}
                                </span>
                                <div className="h-4 w-px bg-blue-300 mx-1"></div>

                                {selectedMembers.length === 1 && (
                                    <button onClick={() => handleEditClick()} className="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg text-sm font-bold transition-colors flex items-center gap-1 whitespace-nowrap">
                                        âœï¸ ìˆ˜ì •
                                    </button>
                                )}
                                <button onClick={() => handleDeleteClick()} className={`bg-white/20 px-3 py-1 rounded-lg text-sm font-bold transition-colors flex items-center gap-1 whitespace-nowrap ${selectedMembers.every(s => !s.member.leader_id) ? 'hover:bg-red-600/80 text-red-100 bg-red-600/50' : 'hover:bg-red-500/80'}`}>
                                    {selectedMembers.every(s => !s.member.leader_id) ? 'ğŸ—‘ï¸ ì˜êµ¬ ì‚­ì œ' : 'ğŸ—‘ï¸ ì œì™¸'}
                                </button>

                                <span className="text-blue-100 text-xs hidden sm:inline ml-2 whitespace-nowrap">
                                    {selectedMembers.every(s => !s.member.leader_id) ? ' - ì£¼ì˜: ë³µêµ¬ ë¶ˆê°€' : ' - ì´ë™í•  ê·¸ë£¹ í„°ì¹˜'}
                                </span>
                            </div>
                            <button
                                onClick={() => { setSelectedMembers([]); setRecommendedLeaders([]); }}
                                className="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg text-sm font-medium transition-colors ml-2 whitespace-nowrap"
                            >
                                âœ• ì·¨ì†Œ
                            </button>
                        </div>
                    )}

                    <div className="flex flex-col lg:flex-row gap-6">
                        {/* Main Grid */}
                        <div className="flex-1">
                            <div id="org-chart-container" className="space-y-8 print:space-y-4">
                                <style>{`
                                    @media print {
                                        @page { size: A3 landscape; margin: 10mm; }
                                        body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                                        .org-section-grid {
                                            display: grid;
                                            grid-template-columns: repeat(5, 1fr) !important;
                                            gap: 10px !important;
                                            width: 100%;
                                        }
                                        .org-card {
                                            break-inside: avoid;
                                            page-break-inside: avoid;
                                            border: 1px solid #cbd5e1 !important;
                                            box-shadow: none !important;
                                        }
                                        .no-print { display: none !important; }
                                        h3 { margin-top: 20px; page-break-after: avoid; }
                                    }
                                `}</style>

                                {[0, 1, 2, 3].map(key => {
                                    const section = groupedSections[key];
                                    if (!section || section.groups.length === 0) return null;

                                    return (
                                        <div key={key}>
                                            <h3 className="text-lg font-bold text-slate-700 border-b-2 border-slate-200 pb-2 mb-4 flex items-center gap-2">
                                                {key === 0 && 'ğŸ¡'} {key === 1 && 'ğŸ’¼'} {key === 2 && 'ğŸ‘¨'}
                                                {section.title}
                                                <span className="text-sm font-normal text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full ml-auto">
                                                    {section.groups.length}ê°œ ì…€
                                                </span>
                                            </h3>
                                            <div className="org-section-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 print:block">
                                                {section.groups.map(({ leader, members }) => {
                                                    const recommendRank = getRecommendRank(leader.id);
                                                    const isRecommended = recommendRank !== null;
                                                    return (
                                                        <div
                                                            key={leader.id}
                                                            onClick={() => handleGroupClick(leader.id)}
                                                            className={`org-card bg-white rounded-lg shadow border overflow-hidden flex flex-col h-full transition-all cursor-pointer select-none
                                                        ${selectedMembers.length > 0 ? 'hover:ring-2 hover:ring-blue-400' : 'hover:shadow-lg'}
                                                        ${isRecommended ? 'ring-2 ring-amber-400 border-amber-300' : 'border-slate-200'}
                                                    `}
                                                        >
                                                            <div className={`p-2 text-center border-b print:bg-slate-200 print:text-black print:border-slate-300 relative
                                                        ${isRecommended ? 'bg-amber-500 text-white border-amber-400' : 'bg-slate-700 text-white border-slate-600'}
                                                    `}>
                                                                {isRecommended && (
                                                                    <div className="absolute -top-2 -right-2 w-6 h-6 bg-amber-500 border-2 border-white rounded-full flex items-center justify-center text-white text-xs font-bold shadow">
                                                                        {recommendRank}
                                                                    </div>
                                                                )}
                                                                <div className="text-xs opacity-80 font-light">{formatRole(leader.role)}</div>
                                                                <div className="text-base font-bold truncate">{leader.name} {calcAge(leader.birthdate) > 0 ? `(${calcAge(leader.birthdate)})` : ''}</div>

                                                                {/* Capacity Bar */}
                                                                <div className="w-full bg-black/20 h-1.5 mt-2 rounded-full overflow-hidden">
                                                                    <div className={`h-full ${leader.current_members >= leader.max_capacity ? 'bg-red-400' : 'bg-emerald-400'} transition-all duration-500`} style={{ width: `${Math.min(100, (leader.current_members / leader.max_capacity) * 100)}%` }} />
                                                                </div>
                                                                {/* ë¦¬ë” ì¹´ë“œì— ìˆœì› ì¶”ê°€ ë²„íŠ¼ */}
                                                                <button
                                                                    onClick={(e) => handleAddMemberClick(leader.id, leader.name, e)}
                                                                    className="absolute top-1 right-1 w-5 h-5 bg-white/30 hover:bg-white/50 rounded-full text-xs flex items-center justify-center transition-colors"
                                                                    title="ì´ ê·¸ë£¹ì— ìˆœì› ì¶”ê°€"
                                                                >
                                                                    â•
                                                                </button>
                                                            </div>
                                                            <div className="p-2 flex-1 bg-white space-y-1 min-h-[100px]">
                                                                {members.length === 0 ? (
                                                                    <div className="text-center text-slate-300 text-xs py-4">ë°°ì • ì¸ì› ì—†ìŒ<br />{selectedMembers.length > 0 ? 'ğŸ‘† í„°ì¹˜í•˜ì—¬ ë°°ì •' : 'í„°ì¹˜ â†’ ì´ë™'}</div>
                                                                ) : (
                                                                    members.map(m => {
                                                                        const isSelected = selectedMembers.some(s => s.id === m.id);
                                                                        return (
                                                                            <div
                                                                                key={m.id}
                                                                                onClick={(e) => { e.stopPropagation(); handleSelectMember(m, leader.id); }}
                                                                                onContextMenu={(e) => handleContextMenu(e, m, leader.id)}
                                                                                className={`rounded px-2 py-1.5 text-xs flex justify-between items-center cursor-pointer transition-all select-none
                                                                        ${isSelected
                                                                                        ? 'bg-blue-500 text-white border-2 border-blue-600 ring-2 ring-blue-300 shadow-lg'
                                                                                        : 'bg-slate-50 border border-slate-100 hover:bg-slate-100'}
                                                                    `}
                                                                            >
                                                                                <span className={`font-medium truncate ${isSelected ? 'text-white' : 'text-slate-700'}`}>
                                                                                    {isSelected && 'âœ“ '}{m.name} {calcAge(m.birthdate) > 0 ? `(${calcAge(m.birthdate)})` : ''}
                                                                                </span>
                                                                                <span className={`text-[10px] ${isSelected ? 'text-blue-100' : 'text-slate-400'}`}>{formatRole(m.role)}</span>
                                                                            </div>
                                                                        )
                                                                    })
                                                                )}
                                                            </div>
                                                            <div className="bg-slate-50 p-1.5 text-center text-[10px] text-slate-400 border-t border-slate-100 font-mono">
                                                                Total: {members.length}
                                                            </div>
                                                        </div>
                                                    )
                                                })}
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        </div>

                        {/* Unassigned Sidebar */}
                        <div className="w-full lg:w-64 shrink-0 print:hidden">
                            <div
                                className={`bg-white rounded-xl border shadow-sm sticky top-24 max-h-[calc(100vh-8rem)] flex flex-col cursor-pointer transition-all select-none
                                    ${selectedMembers.length > 0 ? 'border-blue-300 ring-2 ring-blue-200' : 'border-red-200'}
                                `}
                                onClick={() => handleGroupClick('')}
                            >
                                <div className="bg-red-50 text-red-700 p-3 text-center border-b border-red-100 rounded-t-xl">
                                    <div className="font-bold">ë¯¸ë°°ì • ì¸ì›</div>
                                    <div className="text-xs mt-1 bg-white/50 inline-block px-2 py-0.5 rounded-full">{unassigned.length}ëª…</div>
                                    {selectedMembers.length > 0 && <div className="text-xs mt-1 text-blue-600 font-medium">ğŸ‘† í„°ì¹˜í•˜ì—¬ ë°°ì • ì·¨ì†Œ</div>}
                                </div>
                                <div className="p-2 overflow-y-auto flex-1 bg-red-50/10 space-y-1 min-h-[150px]">
                                    <div className="divide-y divide-slate-100">
                                        {unassigned.length === 0 ? (
                                            <div className="p-8 text-center text-slate-400 text-sm">ëŒ€ê¸° ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤</div>
                                        ) : (
                                            unassigned.map(m => (
                                                <UnassignedItem
                                                    key={m.id}
                                                    m={m}
                                                    isSelected={selectedMembers.some(s => s.id === m.id)}
                                                    onClick={(e) => handleSelectMember(m, null)}
                                                />
                                            ))
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Context Menu */}
                    {contextMenu.visible && (
                        <div
                            className="fixed bg-white border border-slate-200 shadow-xl rounded-lg py-1 w-32 z-[100] animate-fade-in"
                            style={{ top: contextMenu.y, left: contextMenu.x }}
                            onClick={(e) => e.stopPropagation()}
                        >
                            <button onClick={() => { setPlacementModal({ visible: true, member: contextMenu.member }); setContextMenu({ ...contextMenu, visible: false }); }} className="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 flex items-center gap-2">
                                âœ¨ ë¦¬ë” ì¶”ì²œ ë°›ê¸°
                            </button>
                            <button onClick={() => handleEditClick(null)} className="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 flex items-center gap-2">
                                âœï¸ ìˆ˜ì •
                            </button>
                            <button onClick={handleDeleteClick} className="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2">
                                ğŸ—‘ï¸ ì‚­ì œ
                            </button>
                        </div>
                    )}

                    {/* Edit Modal */}
                    {editModal.visible && (
                        <div className="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-[110] animate-fade-in">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 m-4" onClick={(e) => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4">ì •ë³´ ìˆ˜ì •</h3>
                                <form onSubmit={handleSaveEdit} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 block mb-1">ì´ë¦„</label>
                                        <input required value={editForm.name} onChange={e => setEditForm({ ...editForm, name: e.target.value })} className="w-full rounded-lg border bg-slate-50 py-2.5 px-3 text-sm" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 block mb-1">ì§ë¶„</label>
                                            <input value={editForm.role} onChange={e => setEditForm({ ...editForm, role: e.target.value })} className="w-full rounded-lg border bg-slate-50 py-2.5 px-3 text-sm" />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 block mb-1">ì„±ë³„</label>
                                            <select value={editForm.gender} onChange={e => setEditForm({ ...editForm, gender: e.target.value })} className="w-full rounded-lg border bg-slate-50 py-2.5 px-3 text-sm">
                                                <option value="Male">ë‚¨ì„±</option>
                                                <option value="Female">ì—¬ì„±</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 block mb-1">ìƒë…„ì›”ì¼</label>
                                        <input type="date" required value={editForm.birthdate} onChange={e => setEditForm({ ...editForm, birthdate: e.target.value })} className="w-full rounded-lg border bg-slate-50 py-2.5 px-3 text-sm" />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 block mb-1">ì£¼ì†Œ</label>
                                        <input value={editForm.address} onChange={e => setEditForm({ ...editForm, address: e.target.value })} className="w-full rounded-lg border bg-slate-50 py-2.5 px-3 text-sm" />
                                    </div>
                                    <div className="flex justify-end gap-2 mt-6">
                                        <button type="button" onClick={() => handleDeletePermanently()} className="mr-auto text-red-500 text-xs font-bold px-3 py-2 hover:bg-red-50 rounded-lg transition-colors">ì˜êµ¬ ì‚­ì œ</button>
                                        <button type="button" onClick={() => setEditModal({ visible: false, member: null })} className="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-xl transition-colors">ì·¨ì†Œ</button>
                                        <button type="submit" className="px-4 py-2 bg-brand-600 text-white font-bold rounded-xl hover:bg-brand-700 transition-colors">ì €ì¥</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* ìˆœì› ì¶”ê°€ ëª¨ë‹¬ */}
                    {addMemberModal.visible && (
                        <div className="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-[110] animate-fade-in">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 m-4" onClick={(e) => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                                    â• ìˆœì› ë“±ë¡
                                    {addMemberModal.leaderName && <span className="text-sm font-normal text-slate-500">â†’ {addMemberModal.leaderName}</span>}
                                </h3>
                                <form onSubmit={handleAddMemberSubmit} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 block mb-1">ì´ë¦„ *</label>
                                        <input required value={addMemberForm.name} onChange={e => setAddMemberForm({ ...addMemberForm, name: e.target.value })} className="w-full rounded-lg border bg-slate-50 py-2.5 px-3 text-sm" placeholder="í™ê¸¸ë™" />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 block mb-1">ì£¼ì†Œ *</label>
                                        <input required value={addMemberForm.address} onChange={e => setAddMemberForm({ ...addMemberForm, address: e.target.value })} className="w-full rounded-lg border bg-slate-50 py-2.5 px-3 text-sm" placeholder="ì„œìš¸ì‹œ ê°•ë‚¨êµ¬..." />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 block mb-1">ì§ë¶„</label>
                                            <input value={addMemberForm.role} onChange={e => setAddMemberForm({ ...addMemberForm, role: e.target.value })} className="w-full rounded-lg border bg-slate-50 py-2.5 px-3 text-sm" placeholder="ì„±ë„" />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 block mb-1">ì„±ë³„</label>
                                            <select value={addMemberForm.gender} onChange={e => setAddMemberForm({ ...addMemberForm, gender: e.target.value })} className="w-full rounded-lg border bg-slate-50 py-2.5 px-3 text-sm">
                                                <option value="Male">ë‚¨ì„±</option>
                                                <option value="Female">ì—¬ì„±</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 block mb-1">ìƒë…„ì›”ì¼</label>
                                            <input type="date" value={addMemberForm.birthdate} onChange={e => setAddMemberForm({ ...addMemberForm, birthdate: e.target.value })} className="w-full rounded-lg border bg-slate-50 py-2.5 px-3 text-sm" />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 block mb-1">ì—°ë½ì²˜</label>
                                            <input value={addMemberForm.contact} onChange={e => setAddMemberForm({ ...addMemberForm, contact: formatPhone(e.target.value) })} className="w-full rounded-lg border bg-slate-50 py-2.5 px-3 text-sm" placeholder="010-0000-0000" />
                                        </div>
                                    </div>
                                    <div className="flex justify-end gap-2 mt-6">
                                        <button type="button" onClick={() => setAddMemberModal({ visible: false, leaderId: null, leaderName: '' })} className="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-xl transition-colors">ì·¨ì†Œ</button>
                                        <button type="submit" disabled={addingSaving} className="px-4 py-2 bg-brand-600 text-white font-bold rounded-xl hover:bg-brand-700 transition-colors disabled:opacity-50">
                                            {addingSaving ? 'ë“±ë¡ ì¤‘...' : 'ë“±ë¡'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                    {/* Recruitment Modal */}
                    {recruitmentModal.visible && recruitmentModal.leader && (
                        <RecruitmentModal
                            leader={recruitmentModal.leader}
                            members={members}
                            leaders={leaders}
                            onClose={() => setRecruitmentModal({ visible: false, leader: null })}
                            onAssign={handleRecruitMember}
                        />
                    )}
                    {/* Placement Modal */}
                    {placementModal.visible && placementModal.member && (
                        <PlacementModal
                            member={placementModal.member}
                            leaders={leaders}
                            getGroupOrder={getGroupOrder}
                            onClose={() => setPlacementModal({ visible: false, member: null })}
                            onAssign={handlePlaceMember}
                        />
                    )}
                </div >
            );
        };
        const App = () => {
            const [tab, setTab] = useState('MATCH'), [mapsLoaded, setMapsLoaded] = useState(false), [conn, setConn] = useState(false), [check, setCheck] = useState(true);
            // ì „ì—­ ë°ì´í„° ìƒíƒœ (í•œ ë²ˆë§Œ ë¡œë“œ)
            const [globalData, setGlobalData] = useState({ leaders: [], members: [], loaded: false, loading: false });
            // ë°±ê·¸ë¼ìš´ë“œ ë™ê¸°í™” ìƒíƒœ
            const [syncing, setSyncing] = useState(false);
            // ë¡œë”© ì§„í–‰ ìƒíƒœ
            const [loadingProgress, setLoadingProgress] = useState({ step: '', progress: 0, details: '' });

            // ë™ê¸°í™” ì¤‘ì¼ ë•Œ í˜ì´ì§€ ì´íƒˆ ê²½ê³ 
            useEffect(() => {
                const handleBeforeUnload = (e) => {
                    if (syncing) {
                        e.preventDefault();
                        e.returnValue = '';
                    }
                };
                window.addEventListener('beforeunload', handleBeforeUnload);
                return () => window.removeEventListener('beforeunload', handleBeforeUnload);
            }, [syncing]);

            const loadGlobalData = async () => {
                if (globalData.loading) return;
                setGlobalData(prev => ({ ...prev, loading: true }));
                setLoadingProgress({ step: 'ì—°ê²° í™•ì¸ ì¤‘...', progress: 10, details: 'Google Sheets ì—°ê²° ì¤‘' });
                try {
                    // ë‹¨ê³„ë³„ ë¡œë”©ìœ¼ë¡œ ì§„í–‰ ìƒí™© í‘œì‹œ
                    setLoadingProgress({ step: 'ë¦¬ë” ë°ì´í„° ë¡œë”© ì¤‘...', progress: 30, details: 'ì†Œê·¸ë£¹ ë¦¬ë” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤' });
                    const leaders = await request('GET_LEADERS');
                    setLoadingProgress({ step: 'ë¦¬ë” ë°ì´í„° ì™„ë£Œ', progress: 50, details: `${leaders.length}ëª…ì˜ ë¦¬ë” ë¡œë“œë¨` });

                    await sleep(100); // ì§„í–‰ë¥  í‘œì‹œë¥¼ ìœ„í•œ ì§§ì€ ë”œë ˆì´

                    setLoadingProgress({ step: 'ìˆœì› ë°ì´í„° ë¡œë”© ì¤‘...', progress: 70, details: 'ì†Œê·¸ë£¹ì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤' });
                    const members = await request('GET_ALL_MEMBERS');
                    setLoadingProgress({ step: 'ë°ì´í„° ì²˜ë¦¬ ì¤‘...', progress: 90, details: `${leaders.length}ëª… ë¦¬ë”, ${members.length}ëª… ìˆœì› ë¡œë“œë¨` });

                    await sleep(100);

                    setLoadingProgress({ step: 'ì™„ë£Œ!', progress: 100, details: 'ë°ì´í„° ë¡œë”© ì™„ë£Œ' });
                    setGlobalData({ leaders, members, loaded: true, loading: false });
                } catch (err) {
                    console.error('ì „ì—­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', err);
                    setLoadingProgress({ step: 'ì˜¤ë¥˜ ë°œìƒ', progress: 0, details: err.message });
                    setGlobalData(prev => ({ ...prev, loading: false }));
                }
            };

            const refreshGlobalData = async () => {
                setGlobalData(prev => ({ ...prev, loading: true }));
                try {
                    const { leaders, members } = await fetchFullData();
                    setGlobalData({ leaders, members, loaded: true, loading: false });
                } catch (err) {
                    console.error('ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', err);
                    setGlobalData(prev => ({ ...prev, loading: false }));
                }
            };

            const handleTabChange = (newTab) => { setTab(newTab); window.scrollTo(0, 0); };

            useEffect(() => {
                if (getBackendMode() === 'firebase' && getFirebaseConfigRaw() && getMapsApiKey()) {
                    try { ensureFirebaseDb(); setConn(true); } catch { setConn(false); }
                }
                setCheck(false);
                if (!document.getElementById('gm')) {
                    const mapsApiKey = getMapsApiKey();
                    if (!mapsApiKey) return;
                    const s = document.createElement('script');
                    s.id = 'gm';
                    s.src = `https://maps.googleapis.com/maps/api/js?key=${mapsApiKey}&libraries=places`;
                    s.async = true;
                    s.onload = () => setTimeout(() => setMapsLoaded(true), 100);
                    document.head.appendChild(s);
                } else if (window.google?.maps) setMapsLoaded(true);
            }, []);

            // ì—°ê²° í›„ ìµœì´ˆ 1íšŒ ë°ì´í„° ë¡œë“œ
            useEffect(() => {
                if (conn && mapsLoaded && !globalData.loaded && !globalData.loading) {
                    loadGlobalData();
                }
            }, [conn, mapsLoaded, globalData.loaded, globalData.loading]);

            const disconnect = () => {
                if (!confirm("ì—°ê²° í•´ì œ?")) return;
                clearStoredValue(FIREBASE_CONFIG_KEY);
                clearStoredValue(BACKEND_MODE_KEY);
                clearStoredValue(MAPS_API_KEY_STORAGE);
                firebaseDb = null;
                setConn(false);
                setMapsLoaded(false);
                setGlobalData({ leaders: [], members: [], loaded: false, loading: false });
            };

            if (check) return null;
            if (!conn) return <SetupScreen onComplete={() => setConn(true)} />;

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col font-sans selection:bg-brand-100 selection:text-brand-900">
                    <header className="bg-white/90 backdrop-blur-md sticky top-0 z-40 border-b border-slate-200 shadow-sm transition-all duration-300">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-3 cursor-pointer group select-none" onClick={disconnect}>
                                <div className="bg-brand-600 p-2 rounded-xl text-white shadow-lg shadow-brand-200 transform group-hover:scale-105 group-active:scale-95 transition-all duration-200">ğŸ“‹</div>
                                <div>
                                    <b className="text-lg tracking-tight text-slate-800 font-extrabold top-nav-title">ì†Œê·¸ë£¹ í¸ì„±</b>
                                    <p className="text-[10px] text-brand-600 flex items-center gap-1.5 font-bold">
                                        <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse shadow-[0_0_8px_rgba(34,197,94,0.6)]" />ì—°ê²°ë¨
                                    </p>
                                </div>
                            </div>
                            <div className="flex items-center gap-2 md:gap-6">
                                {syncing && (
                                    <div className="hidden md:flex items-center gap-2 text-xs font-bold text-brand-600 bg-brand-50 px-3 py-1.5 rounded-full border border-brand-100 shadow-sm animate-fade-in">
                                        <div className="w-2 h-2 rounded-full bg-brand-600 animate-ping" />
                                        ì €ì¥ ì¤‘...
                                    </div>
                                )}
                                <nav className="flex bg-slate-100/80 p-1 rounded-2xl overflow-x-auto no-scrollbar max-w-[calc(100vw-180px)] md:max-w-none backdrop-blur-sm">
                                    {[
                                        { id: 'MATCH', icon: 'âœ¨', label: 'ë°°ì •' },
                                        { id: 'ORG_CHART', icon: 'ğŸ“Š', label: 'ì¡°ì§ë„' },
                                        { id: 'DASHBOARD', icon: 'ğŸ“ˆ', label: 'í˜„í™©' },
                                        { id: 'UPLOAD', icon: 'âš™ï¸', label: 'ê´€ë¦¬' },
                                    ].map(item => (
                                        <button
                                            key={item.id}
                                            onClick={() => handleTabChange(item.id)}
                                            className={`
                                                flex items-center gap-1.5 px-3 md:px-5 py-2 rounded-xl text-sm font-bold transition-all duration-200 whitespace-nowrap
                                                ${tab === item.id
                                                    ? 'bg-white text-brand-600 shadow-sm ring-1 ring-black/5 scale-[1.02]'
                                                    : 'text-slate-500 hover:text-slate-700 hover:bg-white/50'}
                                            `}
                                        >
                                            <span className={`text-base ${tab === item.id ? '' : 'grayscale opacity-70'}`}>{item.icon}</span>
                                            <span className={tab === item.id ? 'opacity-100' : 'hidden md:inline opacity-100'}>{item.label}</span>
                                        </button>
                                    ))}
                                </nav>
                            </div>
                        </div>
                        {/* Mobile Sync Indicator (Top Line) */}
                        {syncing && (
                            <div className="md:hidden absolute bottom-0 left-0 h-0.5 w-full bg-brand-100 overflow-hidden">
                                <div className="h-full bg-brand-500 w-1/3 animate-[loading_1s_ease-in-out_infinite]" />
                            </div>
                        )}
                    </header>
                    <main className="flex-1 max-w-7xl mx-auto w-full p-6">
                        {!mapsLoaded ? (
                            <div className="flex flex-col items-center justify-center h-[60vh] text-slate-400">
                                <div className="w-12 h-12 border-4 border-brand-100 border-t-brand-600 rounded-full animate-spin mb-4" />
                                ì§€ë„ ë¡œë”©ì¤‘...
                            </div>
                        ) : globalData.loading && !globalData.loaded ? (
                            <div className="flex flex-col items-center justify-center h-[60vh] text-slate-500">
                                <div className="bg-white rounded-2xl shadow-lg border p-8 w-full max-w-md">
                                    {/* ë¡œë”© ì•„ì´ì½˜ */}
                                    <div className="flex justify-center mb-6">
                                        <div className="relative">
                                            <div className="w-16 h-16 border-4 border-brand-100 border-t-brand-600 rounded-full animate-spin" />
                                            <div className="absolute inset-0 flex items-center justify-center">
                                                <span className="text-lg">ğŸ“Š</span>
                                            </div>
                                        </div>
                                    </div>

                                    {/* ì§„í–‰ë¥  ë°” */}
                                    <div className="mb-4">
                                        <div className="flex justify-between text-xs mb-1">
                                            <span className="font-semibold text-brand-600">{loadingProgress.step}</span>
                                            <span className="text-slate-400">{loadingProgress.progress}%</span>
                                        </div>
                                        <div className="h-2 bg-slate-100 rounded-full overflow-hidden">
                                            <div
                                                className="h-full bg-gradient-to-r from-brand-500 to-brand-600 rounded-full transition-all duration-300 ease-out"
                                                style={{ width: `${loadingProgress.progress}%` }}
                                            />
                                        </div>
                                    </div>

                                    {/* ìƒì„¸ ì •ë³´ */}
                                    <p className="text-center text-sm text-slate-400">{loadingProgress.details}</p>

                                    {/* íŒ */}
                                    <div className="mt-6 pt-4 border-t border-slate-100">
                                        <p className="text-xs text-center text-slate-300">
                                            ğŸ’¡ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë°ì´í„°ê°€ ë§ì„ìˆ˜ë¡ ì‹œê°„ì´ ë” ì†Œìš”ë©ë‹ˆë‹¤
                                        </p>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="animate-fade-in-up">
                                {tab === 'MATCH' && <MemberMatching globalData={globalData} onRefresh={refreshGlobalData} setGlobalData={setGlobalData} setSyncing={setSyncing} />}
                                {tab === 'UPLOAD' && <LeaderUpload globalData={globalData} onRefresh={refreshGlobalData} />}
                                {tab === 'DASHBOARD' && <Dashboard globalData={globalData} onRefresh={refreshGlobalData} setGlobalData={setGlobalData} />}
                                {tab === 'ORG_CHART' && <OrgChart globalData={globalData} onRefresh={refreshGlobalData} setGlobalData={setGlobalData} setSyncing={setSyncing} />}
                            </div>
                        )}
                    </main>
                    <footer className="border-t bg-white py-6 text-center text-xs text-slate-400">
                        Â© {new Date().getFullYear()} Church Small Group Manager
                    </footer>
                </div >
            );
        };
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>
